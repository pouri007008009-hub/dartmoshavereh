<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ฺฏุฑูู ูุดุงูุฑูโุง ุฏุงุฑุช - ุจุฑูุงููโุฑุฒ ฑด ุฑูุฒู ู ุงูุชุญุงูุงุช ุฏโูุงู</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg: #f3f4f6;
  --bg-soft: #eef2ff;
  --card-bg: #ffffff;
  --card-elevated: #f9fafb;
  --primary: #2563eb;
  --primary-soft: rgba(37, 99, 235, 0.1);
  --primary-soft-strong: rgba(37, 99, 235, 0.14);
  --border-soft: #e5e7eb;
  --border-strong: #d1d5db;
  --text-main: #111827;
  --text-muted: #6b7280;
  --text-softer: #9ca3af;
  --danger: #ef4444;
  --danger-soft: rgba(239, 68, 68, 0.08);
  --success: #16a34a;
  --success-soft: rgba(22, 163, 74, 0.09);
  --radius-lg: 18px;
  --radius-md: 12px;
  --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
  --shadow-subtle: 0 8px 24px rgba(15, 23, 42, 0.04);
  --input-bg: #f9fafb;
}

/* ุชูโูุง */
body.theme-obsessive {
  --primary: #0f766e;
  --primary-soft: rgba(15, 118, 110, 0.1);
  --primary-soft-strong: rgba(15, 118, 110, 0.16);
  --bg-soft: #ecfdf5;
}
body.theme-runner {
  --primary: #f97316;
  --primary-soft: rgba(249, 115, 22, 0.12);
  --primary-soft-strong: rgba(249, 115, 22, 0.18);
  --bg-soft: #fff7ed;
}
body.theme-steady { }
body.theme-lastminute {
  --primary: #9333ea;
  --primary-soft: rgba(147, 51, 234, 0.12);
  --primary-soft-strong: rgba(147, 51, 234, 0.18);
  --bg-soft: #faf5ff;
}

/* ุญุงูุช ุชุฑู */
body.dark-mode {
  --bg: #050816;
  --bg-soft: #020617;
  --card-bg: #0b1020;
  --card-elevated: #020617;
  --border-soft: #1f2937;
  --border-strong: #374151;
  --text-main: #e5e7eb;
  --text-muted: #9ca3af;
  --text-softer: #6b7280;
  --danger-soft: rgba(239, 68, 68, 0.16);
  --success-soft: rgba(34, 197, 94, 0.18);
  --input-bg: #020617;
  --shadow-soft: 0 25px 80px rgba(0, 0, 0, 0.85);
  --shadow-subtle: 0 18px 40px rgba(15, 23, 42, 0.7);
}

*,
*::before,
*::after { box-sizing: border-box; }

body {
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Tahoma,sans-serif;
  background: radial-gradient(circle at top left, rgba(129,140,248,0.25) 0, transparent 40%),
              radial-gradient(circle at bottom right, rgba(236,72,153,0.18) 0, transparent 45%),
              var(--bg);
  color: var(--text-main);
}

/* ฺฉุงูุชูุฑ ุงุตู */
.container {
  max-width: 1180px;
  margin: 24px auto 40px auto;
  background: linear-gradient(135deg, #ffffff, #f9fafb);
  border-radius: 26px;
  padding: 22px 24px 26px 24px;
  box-shadow: var(--shadow-soft);
  border: 1px solid rgba(148, 163, 184, 0.16);
}
body.dark-mode .container {
  background: radial-gradient(circle at top, #020617 0, #020617 60%);
  border-color: rgba(15, 23, 42, 0.9);
}

/* ูุงฺฏู */
#loginContainer {
  max-width: 480px;
  margin-top: 60px;
  padding: 28px 26px 26px 26px;
  border-radius: 24px;
}
body.dark-mode #loginContainer {
  background: radial-gradient(circle at top, #0b1120 0, #020617 65%);
}
#loginContainer h2 {
  margin-bottom: 18px;
  font-weight: 700;
}
#loginContainer input { width: 100%; }
#loginStatus {
  padding: 6px 10px;
  border-radius: 10px;
}

/* ูุฏุฑ ุงูพ */
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  margin-bottom: 18px;
}
.app-title {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: radial-gradient(circle at left, var(--primary-soft-strong), transparent);
  color: var(--text-main);
  padding: 10px 16px;
  border-radius: 20px;
  font-size: 18px;
  font-weight: 700;
}
.app-title span.logo-dot {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background: var(--primary);
  box-shadow: 0 0 0 4px var(--primary-soft);
}
.user-chip {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--primary-soft);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 11px;
  color: var(--text-main);
  border: 1px solid rgba(129, 140, 248, 0.4);
}

/* ุขฺฉูู ุชูฺฏุฑุงู */
.telegram-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.6);
  background: #0ea5e9;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  text-decoration: none;
}
.telegram-icon span {
  font-size: 16px;
}
.telegram-link {
  font-size: 11px;
  color: var(--primary);
  text-decoration: none;
}

/* ุชุจโูุง */
.tab-bar {
  display: inline-flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 4px;
  background: var(--card-elevated);
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  margin-bottom: 14px;
}
.tab-btn {
  border-radius: 999px !important;
  background: transparent;
  color: var(--text-muted);
  padding-inline: 12px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: none;
}
.tab-btn.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 6px 16px rgba(15, 23, 42, 0.2);
}

/* ฺฉุงุฑุช / ุณฺฉุดู */
section {
  border-radius: var(--radius-lg);
  padding: 14px 16px 12px 16px;
  margin-bottom: 12px;
  background: var(--card-bg);
  border: 1px solid var(--border-soft);
  box-shadow: var(--shadow-subtle);
}
body.dark-mode section {
  background: radial-gradient(circle at top left, rgba(79,70,229,0.18), transparent 50%),
              radial-gradient(circle at bottom right, rgba(236,72,153,0.18), transparent 55%),
              var(--card-bg);
  border-color: rgba(31,41,55,0.9);
}
section h3 {
  margin-top: 0;
  margin-bottom: 4px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}
section h3::after {
  content: "";
  flex-grow: 1;
  height: 1px;
  margin-right: 8px;
  background: linear-gradient(90deg, rgba(148, 163, 184, 0.5), transparent 60%);
}

/* ูุฑูโูุง */
label { font-size: 11px; color: var(--text-muted); }
input, select, textarea {
  padding: 7px 8px;
  margin: 3px 0 7px 0;
  border-radius: 10px;
  border: 1px solid var(--border-soft);
  font-size: 12px;
  outline: none;
  background: var(--input-bg);
  transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
  color: var(--text-main);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--primary);
  background: #ffffff;
  box-shadow: 0 0 0 1px var(--primary-soft);
}
body.dark-mode input:focus,
body.dark-mode select:focus,
body.dark-mode textarea:focus {
  background: #020617;
}
input[type="number"] { width: 90px; }
textarea { resize: vertical; }
input[type="radio"], input[type="checkbox"] {
  width: auto;
  accent-color: var(--primary);
}

/* ุฏฺฉููโูุง */
.btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 7px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
  transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease, opacity 0.12s ease;
}
.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 30px rgba(37, 99, 235, 0.35);
  opacity: 0.96;
}
.btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 18px rgba(15, 23, 42, 0.25);
}
.small-btn {
  background: #4b5563;
  color: #fff;
  border: none;
  padding: 4px 9px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 11px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  transition: background-color 0.15s ease, transform 0.1s ease;
}
.small-btn:hover {
  background: #374151;
  transform: translateY(-0.5px);
}
.small-btn.del { background: #b91c1c; }
.small-btn.del:hover { background: #7f1d1d; }

/* ุฌุฏููโูุง */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11.5px;
  border-radius: var(--radius-md);
  overflow: hidden;
  background: var(--card-elevated);
}
th, td {
  border: 1px solid rgba(209, 213, 219, 0.8);
  padding: 6px 7px;
  vertical-align: top;
}
th {
  background: linear-gradient(135deg, var(--primary), #111827);
  color: #f9fafb;
  font-weight: 500;
}
.table-soft th {
  background: #f3f4f6;
  color: var(--text-main);
}
body.dark-mode .table-soft th {
  background: #020617;
  color: #e5e7eb;
}
table tr:nth-child(even) td {
  background: rgba(249, 250, 251, 0.9);
}
body.dark-mode table tr:nth-child(even) td {
  background: #020617;
}
.sub-table th { font-size: 11px; padding: 5px 6px; }

/* ูโุขูุชโูุง */
.row-flex {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.row-flex > div {
  min-width: 160px;
  flex: 1 1 160px;
}

/* ุชฺฏ ูุถุนุช */
.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 10px;
  background: #e5e7eb;
  color: #374151;
  gap: 4px;
}
.badge.done { background: var(--success-soft); color: var(--success); }
.badge.todo { background: var(--danger-soft); color: var(--danger); }
.badge.partial { background: rgba(244, 114, 182, 0.12); color: #be185d; }

/* ุจูุงฺฉ ุชุณฺฉ */
.task-block {
  margin-bottom: 6px;
  padding: 6px 8px;
  border-radius: 10px;
  background: #f9fafb;
  border: 1px dashed rgba(209, 213, 219, 0.9);
}
body.dark-mode .task-block {
  background: #020617;
  border-color: rgba(75,85,99,0.9);
}
.task-block:last-child { margin-bottom: 0; }

.hidden { display: none; }

#coverageSummary {
  font-size: 11px;
  margin-top: 6px;
  color: var(--text-muted);
  background: var(--primary-soft);
  padding: 6px 8px;
  border-radius: 999px;
  display: inline-block;
}

/* ุฌุฏูู ุขุฒููู ุดุฎุตุช */
.personality-table td { border: none; padding: 5px 6px; }
.personality-table th { background: var(--primary); }
.personality-scale-header {
  font-size: 11px;
  text-align: center;
  color: #f9fafb;
}

/* ฺฉุงุฑุช ุขุฒูููโูุง */
.exam-card {
  border-radius: 14px;
  border: 1px solid var(--border-soft);
  background: #f9fafb;
  padding: 10px 10px 8px 10px;
  margin-top: 8px;
}
body.dark-mode .exam-card { background: #020617; }

/* ูุฒุงุฑุฏ ุขุฒููู ุดุฎุตุช */
.personality-step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 8px 0;
  font-size: 11px;
  color: var(--text-muted);
}
.personality-progress {
  flex: 1;
  height: 6px;
  border-radius: 999px;
  background: rgba(148, 163, 184, 0.35);
  overflow: hidden;
}
.personality-progress-inner {
  height: 100%;
  width: 0;
  border-radius: 999px;
  background: linear-gradient(90deg, var(--primary), #ec4899);
  transition: width 0.2s ease;
}
.personality-actions {
  margin-top: 8px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.personality-actions .btn {
  flex: 1;
  justify-content: center;
}
.personality-actions .small-btn { min-width: 80px; }

/* ุชุจ ูพุงูโูุง */
.message-item {
  border-radius: 12px;
  padding: 8px 10px;
  margin-bottom: 6px;
  background: #f9fafb;
  border: 1px solid rgba(209,213,219,0.8);
  font-size: 11.5px;
}
body.dark-mode .message-item { background: #020617; }

/* ุฑุณูพุงูุณู */
@media (max-width: 768px) {
  .container {
    margin: 12px;
    padding: 18px 14px 20px 14px;
    border-radius: 22px;
  }
  .app-header {
    flex-direction: column;
    align-items: flex-start;
  }
  .tab-bar {
    width: 100%;
    justify-content: space-between;
  }
}
</style>
</head>
<body class="theme-steady">
<!-- ูุงฺฏู -->
<div id="loginContainer" class="container">
  <h2 style="text-align:center;margin-bottom:10px;">ูุฑูุฏ ุจู ุณุงูุงูู ฺฏุฑูู ูุดุงูุฑูโุง ุฏุงุฑุช</h2>
  <div style="max-width:320px;margin:auto;">
    <label>ุงูู</label><br>
    <input id="loginEmail" type="email" placeholder="ูุซูุงู student@example.com"><br>
    <label>ูพุณูุฑุฏ (ุญุฏุงูู ถ ฺฉุงุฑุงฺฉุชุฑ)</label><br>
    <input id="loginPassword" type="password"><br>
    <button class="btn" style="width:100%;justify-content:center;margin-top:6px;" onclick="handleLogin()">ูุฑูุฏ ุจู ุญุณุงุจ</button>
    <div id="loginStatus" style="font-size:11px;color:#b30000;margin-top:6px;"></div>
  </div>
</div>

<!-- ุงูพ ุงุตู -->
<div id="appContainer" class="container hidden">
  <div class="app-header">
    <h1 class="app-title">
      <span class="logo-dot"></span>
      <span>ฺฏุฑูู ูุดุงูุฑูโุง ุฏุงุฑุช</span>
    </h1>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <!-- ุขฺฉูู ฺฉุงูุงู ุชูฺฏุฑุงู -->
      <a href="https://t.me/dartnz" target="_blank" class="telegram-icon" title="ฺฉุงูุงู ุชูฺฏุฑุงู ุฏุงุฑุช">
        <span>โ๏ธ</span>
      </a>
      <span style="font-size:11px;">
        <a class="telegram-link" href="https://t.me/dart_ad" target="_blank">ุงุฑุชุจุงุท ุจุง ูุง ุฏุฑ ุชูฺฏุฑุงู (@dart_ad)</a>
      </span>
      <button class="small-btn" id="modeToggleBtn" onclick="toggleMode()">๐ ุญุงูุช ุชุฑู</button>
      <span id="currentUserEmail" class="user-chip"></span>
      <button class="small-btn" onclick="logout()">ุฎุฑูุฌ</button>
    </div>
  </div>

  <!-- ุชุจโูุง -->
  <div class="tabs">
  <button class="btn tab-btn" id="introTabBtn" onclick="showTab('introTab')" style="display:none;">๐ ูุนุงุฑูู</button>
  <button class="btn tab-btn" id="personalityTabBtn" onclick="showTab('personalityTab')">๐งฌ ุขุฒููู ุดุฎุตุช</button>
  <button class="btn tab-btn" id="plannerTabBtn" onclick="showTab('plannerTab')">๐ง ุณุงุฎุช ุจุฑูุงูู ฑด ุฑูุฒู</button>
  <button class="btn tab-btn" id="midtermTabBtn" onclick="showTab('midtermTab')">๐ ุงูุชุญุงูุงุช ุฏโูุงู</button>
  <button class="btn tab-btn" id="studentTabBtn" onclick="showTab('studentTab')">โ ุจุฑูุงููโูุง ูู</button>
  <button class="btn tab-btn" id="backlogTabBtn" onclick="showTab('backlogTab')">๐ฆ ุนูุจโูุงูุฏฺฏโูุง</button>
  <button class="btn tab-btn" id="messagesTabBtn" onclick="showTab('messagesTab')">๐ฌ ูพุงูโูุง</button>
  <button class="btn tab-btn" id="adminTabBtn" style="display:none;" onclick="showTab('adminTab')">๐ ูพูู ุงุฏูู</button>
</div>

<!-- ุชุจ ูุนุงุฑูู -->
<div id="introTab" class="hidden">
  <section>
    <h3>๐ ูุนุงุฑูู ู ูุฏูโฺฏุฐุงุฑ</h3>
    <p style="font-size:12px;color:#555">
      ุงู ูุฑู ููุท <b>ฺฉโุจุงุฑ</b> ุงุฒ ุชู ูพุฑุณุฏู ูโุดูุฏ ู ุจุนุฏ ุฏุฑ ุญุณุงุจ ฺฉุงุฑุจุฑโุงุช ุฐุฎุฑู ูโุดูุฏ.
      ุจุฑ ุงุณุงุณ ุงู ุงุทูุงุนุงุชุ ูพุดููุงุฏ ฺฉุชุงุจ ุชุณุชุ ุณุทุญ ุงุณุชุงุฏ ู ูุณุฑ ฺฉูโุงุช ุฑุง ุจูุช ูโฺฏูู.
    </p>

    <div class="card">
      <h4>ฑ) ุงุทูุงุนุงุช ูพุงู</h4>
      <div class="grid-2">
        <div>
          <label>ูุงู</label>
          <input type="text" id="introFname" class="input">
        </div>
        <div>
          <label>ูุงู ุฎุงููุงุฏฺฏ</label>
          <input type="text" id="introLname" class="input">
        </div>
        <div>
          <label>ุดูุงุฑู ููุจุงู</label>
          <input type="text" id="introPhone" class="input" placeholder="ูุซูุงู 09...">
        </div>
        <div>
          <label>ุดูุฑ</label>
          <input type="text" id="introCity" class="input">
        </div>
        <div>
          <label>ูุฏุฑุณู</label>
          <input type="text" id="introSchool" class="input">
        </div>
        <div>
          <label>ูพุงู</label>
          <select id="introGrade" class="input">
            <option value="">ุงูุชุฎุงุจ ฺฉู</option>
            <option value="10">ุฏูู</option>
            <option value="11">ุงุฒุฏูู</option>
            <option value="12">ุฏูุงุฒุฏูู</option>
          </select>
        </div>
        <div>
          <label>ุฑุดุชู</label>
          <select id="introMajor" class="input">
            <option value="">ุงูุชุฎุงุจ ฺฉู</option>
            <option value="ุฑุงุถ">ุฑุงุถ</option>
            <option value="ุชุฌุฑุจ">ุชุฌุฑุจ</option>
            <option value="ุงูุณุงู">ุงูุณุงู</option>
            <option value="ููุฑ">ููุฑ</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h4>ฒ) ูุฏู ฺฉูฺฉูุฑ</h4>
      <div class="grid-2">
        <div>
          <label>ุฑูุฌ ุฑุชุจูโ ูุฏู</label>
          <select id="introGoalRank" class="input">
            <option value="">ุงูุชุฎุงุจ ฺฉู</option>
            <option value="very_good">ุชฺฉโุฑูู / ุฏู ุฑูู</option>
            <option value="good">ฑฐฐ ุชุง ฑฐฐฐ</option>
            <option value="medium">ฑฐฐฐ ุชุง ฒฐฐฐ</option>
            <option value="weak">ุจุงูุงุชุฑ ุงุฒ ฒฐฐฐ</option>
          </select>
        </div>
        <div>
          <label>ุฏุงูุดฺฏุงู ู ุฑุดุชูโ ูุฏู</label>
          <input type="text" id="introGoalField" class="input" placeholder="ูุซูุงู ูพุฒุดฺฉ ุชูุฑุงู">
        </div>
      </div>
    </div>

    <div class="card" id="introMockCard" style="display:none;">
      <h4>ณ) ูุถุนุช ุขุฒูููโูุง ุขุฒูุงุด</h4>
      <p style="font-size:11px;color:#777">
        ุงฺฏุฑ ุณุงู ูุจู ุง ุงูุณุงู ุขุฒููู ุดุฑฺฉุช ฺฉุฑุฏูโุงุ ุงู ุจุฎุด ุฑุง ูพุฑ ฺฉู.
      </p>
      <div class="grid-2">
        <div>
          <label>ููุน ุขุฒููู</label>
          <select id="introMockSystem" class="input">
            <option value="none">ุขุฒููู ุดุฑฺฉุช ูฺฉุฑุฏู</option>
            <option value="ghalamchi">ูููโฺ / ุฎูโุณุจุฒ</option>
            <option value="maz">ูุงุฒ</option>
          </select>
        </div>
        <div>
          <label>ูุงูฺฏู ุชุฑุงุฒ ฺฉู ุชูุฑุจ</label>
          <input type="number" id="introMockAvgTotal" class="input" min="0" step="100">
        </div>
      </div>
      <h5 style="margin-top:12px;">ุชุฑุงุฒ ุชูุฑุจ ูุฑ ุฏุฑุณ ุงุฎุชุตุงุต</h5>
      <div class="grid-2">
        <div>
          <label>ุฒุณุช</label>
          <input type="number" id="introMockBio" class="input" min="0" step="100">
        </div>
        <div>
          <label>ุดู</label>
          <input type="number" id="introMockChem" class="input" min="0" step="100">
        </div>
        <div>
          <label>ูุฒฺฉ</label>
          <input type="number" id="introMockPhys" class="input" min="0" step="100">
        </div>
        <div>
          <label>ุฑุงุถ</label>
          <input type="number" id="introMockMath" class="input" min="0" step="100">
        </div>
      </div>
    </div>

    <div class="card">
      <h4>ด) ูุนุฑู ฺฉู ููุงุจุน ู ุงุณุงุชุฏ</h4>
      <p style="font-size:11px;color:#777">
        ุฏุฑ ุงู ูุฑุญูู ููุท ูพุดููุงุฏ ูโุฏููุ ุงูุชุฎุงุจ ููุง ุจุง ุฎูุฏุช ุงุณุช ู ุจุนุฏุงู ุฏุฑ ูุฑู ุจุฑูุงููโูุง
        ูุดุฎุต ูโุดูุฏ ฺฉู ุงุฒ ฺฉุฏุงู ููุจุน/ุงุณุชุงุฏ ุงุณุชูุงุฏู ูโฺฉู.
      </p>
      <textarea id="introAdviceBox" class="input" style="min-height:160px;" readonly></textarea>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn secondary" onclick="skipIntro()">ูุนูุงู ุฑุฏ ฺฉู</button>
      <button class="btn primary" onclick="saveIntro()">ุซุจุช ูุนุงุฑูู</button>
    </div>
    <p id="introStatus" style="font-size:11px;color:#b30000;margin-top:6px;"></p>
  </section>
</div>

  <!-- ุชุจ ุขุฒููู ุดุฎุตุช -->
  <div id="personalityTab">
    <section>
      <h3>๐งฌ ุขุฒููู ุดุฎุตุช ูุทุงูุนู</h3>
      <p id="personalityInfo" style="font-size:11px;color:#444;">
        ุงู ุขุฒููู ุจุฑุง ุชูพโุจูุฏ ุณุจฺฉ ูุทุงูุนู ุดูุงุณุช ุชุง ุจุฑูุงููโูุง ุจุฑ ุงุณุงุณ ุดุฎุตุชุชุงู ุชูุธู ุดููุฏ.
        ูุทูุงู ุจู ูููโ ุณุคุงูุงุช ุจุง ุฏูุช ู ุตุฏุงูุช ูพุงุณุฎ ุจุฏู.
      </p>

      <div class="personality-step-header">
        <span id="personalityStepLabel">ุณุคุงู ฑ ุงุฒ ฑถ</span>
        <div class="personality-progress">
          <div id="personalityProgressInner" class="personality-progress-inner"></div>
        </div>
      </div>

      <table class="personality-table table-soft">
        <tr>
          <th>ุณุคุงู</th>
          <th class="personality-scale-header">ฺฉุงููุงู ูุฎุงููู</th>
          <th class="personality-scale-header">ูุฎุงููู</th>
          <th class="personality-scale-header">ูุธุฑ ูุฏุงุฑู</th>
          <th class="personality-scale-header">ููุงููู</th>
          <th class="personality-scale-header">ฺฉุงููุงู ููุงููู</th>
        </tr>
        <!-- ฑ -->
        <tr>
          <td>ฑ. ููุช ุจุฑูุงููโ ุฏูู ุฏุงุฑูุ ุงฺฏุฑ ุญุช ฺฉ ฺฉุงุฑุด ุงูุฌุงู ูุดูุฏุ ุชุง ุขุฎุฑ ุฑูุฒ ูฺฉุฑู ุฏุฑฺฏุฑ ูโูุงูุฏ.</td>
          <td><input type="radio" name="q1" value="1"></td>
          <td><input type="radio" name="q1" value="2"></td>
          <td><input type="radio" name="q1" value="3"></td>
          <td><input type="radio" name="q1" value="4"></td>
          <td><input type="radio" name="q1" value="5"></td>
        </tr>
        <!-- ฒ -->
        <tr>
          <td>ฒ. ุงฺฏุฑ ฺฉ ุฑูุฒ ุจุฑูุงููโุงู ุฎุฑุงุจ ุดูุฏุ ูุนูููุงู ูโฺฏูู ยซุจโุฎุงูุ ุงุฒ ูุฑุฏุง ุฌุฏ ุดุฑูุน ูโฺฉููยป.</td>
          <td><input type="radio" name="q2" value="1"></td>
          <td><input type="radio" name="q2" value="2"></td>
          <td><input type="radio" name="q2" value="3"></td>
          <td><input type="radio" name="q2" value="4"></td>
          <td><input type="radio" name="q2" value="5"></td>
        </tr>
        <!-- ณ -->
        <tr>
          <td>ณ. ุชุฑุฌุญ ูโุฏูู ูุฑ ุฑูุฒ ฺฉู ูพุด ุจุฑูู ุชุง ุงูฺฉู ููู ฺุฒ ุฑุง ุจฺฏุฐุงุฑู ุจุฑุง ุฑูุฒูุง ุขุฎุฑ.</td>
          <td><input type="radio" name="q3" value="1"></td>
          <td><input type="radio" name="q3" value="2"></td>
          <td><input type="radio" name="q3" value="3"></td>
          <td><input type="radio" name="q3" value="4"></td>
          <td><input type="radio" name="q3" value="5"></td>
        </tr>
        <!-- ด -->
        <tr>
          <td>ด. ูุนูููุงู ุจุฎุด ุฒุงุฏ ุงุฒ ุฏุฑุณโูุงู ุฑุง ูุฒุฏฺฉ ุขุฒููู ุง ุงูุชุญุงู ุงูุฌุงู ูโุฏูู.</td>
          <td><input type="radio" name="q4" value="1"></td>
          <td><input type="radio" name="q4" value="2"></td>
          <td><input type="radio" name="q4" value="3"></td>
          <td><input type="radio" name="q4" value="4"></td>
          <td><input type="radio" name="q4" value="5"></td>
        </tr>
        <!-- ต -->
        <tr>
          <td>ต. ุงฺฏุฑ ฺฉ ูุจุญุซ ุฑุง ฺฉุงูู ู ุจโููุต ูุจูู/ูุฒููุ ุญุณ ูโฺฉูู ุงุตูุงู ุขู ูุจุญุซ ุฑุง ุจูุฏ ูุณุชู.</td>
          <td><input type="radio" name="q5" value="1"></td>
          <td><input type="radio" name="q5" value="2"></td>
          <td><input type="radio" name="q5" value="3"></td>
          <td><input type="radio" name="q5" value="4"></td>
          <td><input type="radio" name="q5" value="5"></td>
        </tr>
        <!-- ถ -->
        <tr>
          <td>ถ. ุดุฑูุน ฺฉุฑุฏู ุจุฑุงู ุณุฎุช ุงุณุชุ ุงูุง ููุช ุดุฑูุน ฺฉููุ ูุนูููุงู ุฌุฏ ู ูุชูุฑฺฉุฒ ุฌูู ูโุฑูู.</td>
          <td><input type="radio" name="q6" value="1"></td>
          <td><input type="radio" name="q6" value="2"></td>
          <td><input type="radio" name="q6" value="3"></td>
          <td><input type="radio" name="q6" value="4"></td>
          <td><input type="radio" name="q6" value="5"></td>
        </tr>
        <!-- ท -->
        <tr>
          <td>ท. ุฏูุณุช ุฏุงุฑู ุญุฌู ุจุฑูุงููโุงู ุทูุฑ ุจุงุดุฏ ฺฉู ุจุง ุฎุงู ุฑุงุญุช ุจุชูุงูู ุฑูุฒุงูู ุงูุฌุงูุด ุฏููุ ูู ูุดุฑุฏู ู ุงุณุชุฑุณ.</td>
          <td><input type="radio" name="q7" value="1"></td>
          <td><input type="radio" name="q7" value="2"></td>
          <td><input type="radio" name="q7" value="3"></td>
          <td><input type="radio" name="q7" value="4"></td>
          <td><input type="radio" name="q7" value="5"></td>
        </tr>
        <!-- ธ -->
        <tr>
          <td>ธ. ุจุงุฑูุง ุดุฏู ุจุฑูุงููโุฑุฒ ุนุงู ุฏุงุดุชู ุจุงุดูุ ุงูุง ูุณุท ฺฉุงุฑ ุจุฒูู ุฒุฑุด ู ุจฺฏูู ยซุญูุตูู ูุฏุงุฑูยป.</td>
          <td><input type="radio" name="q8" value="1"></td>
          <td><input type="radio" name="q8" value="2"></td>
          <td><input type="radio" name="q8" value="3"></td>
          <td><input type="radio" name="q8" value="4"></td>
          <td><input type="radio" name="q8" value="5"></td>
        </tr>
        <!-- น -->
        <tr>
          <td>น. ุงุฒ ุฌูุน ุดุฏู ุนูุจโูุงูุฏฺฏโูุง ุฎู ูโุชุฑุณู ู ุฏูุณุช ุฏุงุฑู ุขูโูุง ุฑุง ูุฑฺู ุฒูุฏุชุฑ ุตูุฑ ฺฉูู.</td>
          <td><input type="radio" name="q9" value="1"></td>
          <td><input type="radio" name="q9" value="2"></td>
          <td><input type="radio" name="q9" value="3"></td>
          <td><input type="radio" name="q9" value="4"></td>
          <td><input type="radio" name="q9" value="5"></td>
        </tr>
        <!-- ฑฐ -->
        <tr>
          <td>ฑฐ. ูุนูููุงู ุฏุฑ ุฑูุฒูุง ุขุฎุฑ ูุจู ุงุฒ ุขุฒูููุ ุจุดุชุฑ ุงุฒ ุฑูุฒูุง ุนุงุฏ ุชูุงุด ูโฺฉูู.</td>
          <td><input type="radio" name="q10" value="1"></td>
          <td><input type="radio" name="q10" value="2"></td>
          <td><input type="radio" name="q10" value="3"></td>
          <td><input type="radio" name="q10" value="4"></td>
          <td><input type="radio" name="q10" value="5"></td>
        </tr>
        <!-- ฑฑ -->
        <tr>
          <td>ฑฑ. ุงฺฏุฑ ุจุฑูุงูู ุฎู ูุดุฑุฏู ุจุงุดุฏุ ุงุญุชูุงู ุงูโฺฉู ุฑูุงุด ฺฉูู ุฒุงุฏ ุงุณุช.</td>
          <td><input type="radio" name="q11" value="1"></td>
          <td><input type="radio" name="q11" value="2"></td>
          <td><input type="radio" name="q11" value="3"></td>
          <td><input type="radio" name="q11" value="4"></td>
          <td><input type="radio" name="q11" value="5"></td>
        </tr>
        <!-- ฑฒ -->
        <tr>
          <td>ฑฒ. ูุนูููุงู ุชุฑุฌุญ ูโุฏูู ุงูู ุนูุจโูุงูุฏฺฏโูุงู ุฑุง ุฌูุน ฺฉูู ุจุนุฏ ุณุฑุงุบ ูพุดุฑู ุจุฑูู.</td>
          <td><input type="radio" name="q12" value="1"></td>
          <td><input type="radio" name="q12" value="2"></td>
          <td><input type="radio" name="q12" value="3"></td>
          <td><input type="radio" name="q12" value="4"></td>
          <td><input type="radio" name="q12" value="5"></td>
        </tr>
        <!-- ฑณ -->
        <tr>
          <td>ฑณ. ุงูู ยซุงุฒ ููู ุงูุฑูุฒ ฺฉ ููุฏุงุฑ ุดุฑูุน ฺฉููยป ูุณุชูุ ุญุช ุงฺฏุฑ ุญุณ ฺฉูู ฺฉุงูู ุขูุงุฏู ูุณุชู.</td>
          <td><input type="radio" name="q13" value="1"></td>
          <td><input type="radio" name="q13" value="2"></td>
          <td><input type="radio" name="q13" value="3"></td>
          <td><input type="radio" name="q13" value="4"></td>
          <td><input type="radio" name="q13" value="5"></td>
        </tr>
        <!-- ฑด -->
        <tr>
          <td>ฑด. ููุช ุงุณุชุฑุณ ูโฺฏุฑูุ ุชูุงู ุฏุงุฑู ุจุนุถ ฺฉุงุฑูุง ุฑุง ู ุนูุจ ุจูุฏุงุฒู.</td>
          <td><input type="radio" name="q14" value="1"></td>
          <td><input type="radio" name="q14" value="2"></td>
          <td><input type="radio" name="q14" value="3"></td>
          <td><input type="radio" name="q14" value="4"></td>
          <td><input type="radio" name="q14" value="5"></td>
        </tr>
        <!-- ฑต -->
        <tr>
          <td>ฑต. ุชุฑุฌุญ ูโุฏูู ุจูโุฌุง ุฌูุน ฺฉุฑุฏู ฺฉุงุฑูุงุ ูุฑ ุฑูุฒ ููุฏุงุฑ ูุดุฎุต ฺฉุงุฑ ุซุงุจุช ุฏุงุดุชู ุจุงุดู.</td>
          <td><input type="radio" name="q15" value="1"></td>
          <td><input type="radio" name="q15" value="2"></td>
          <td><input type="radio" name="q15" value="3"></td>
          <td><input type="radio" name="q15" value="4"></td>
          <td><input type="radio" name="q15" value="5"></td>
        </tr>
        <!-- ฑถ -->
        <tr>
          <td>ฑถ. ููุช ูุดุงุฑ ุงูุชุญุงู ูุฒุฏฺฉ ูโุดูุฏุ ุชุงุฒู ุญุณ ูโฺฉูู ุงูฺฏุฒูโ ุงุตูโุงู ุฑูุดู ุดุฏู.</td>
          <td><input type="radio" name="q16" value="1"></td>
          <td><input type="radio" name="q16" value="2"></td>
          <td><input type="radio" name="q16" value="3"></td>
          <td><input type="radio" name="q16" value="4"></td>
          <td><input type="radio" name="q16" value="5"></td>
        </tr>
      </table>

      <div class="personality-actions">
        <button type="button" class="small-btn" id="personalityPrevBtn">ูุจู</button>
        <button type="button" class="btn" id="personalityNextBtn">ุณุคุงู ุจุนุฏ</button>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" onclick="computePersonality()">ูุญุงุณุจู ุชูพ</button>
        <button class="btn" id="savePersonalityBtn" onclick="savePersonality()" disabled>ุซุจุช ุชูพ ุฏุฑ ุญุณุงุจ ูู</button>
      </div>
      <div id="personalityResult" style="font-size:12px;color:#333;margin-top:8px;"></div>
    </section>
  </div>

  <!-- ุชุจ ุจุฑูุงููโุฑุฒ ฑด ุฑูุฒู -->
  <div id="plannerTab" class="hidden">

    <!-- ฐ. ููุน ุจุฑูุงูู -->
    <section>
      <h3>ฐ. ุงูุชุฎุงุจ ููุน ุจุฑูุงูู</h3>
      <p style="font-size:11px;color:#444">
        ๐น <b>ุจุฑูุงูู ุนุงุฏ:</b> ุจุฏูู ุงุณุชูุงุฏู ุงุฒ ุชูพ ุดุฎุตุชุ ุงูฺฏูุฑุชู ูพุงู ู ฺฉููุงุฎุช.<br>
        ๐น <b>ุจุฑูุงูู ุจุฑ ุงุณุงุณ ุชูพ ุดุฎุตุช:</b> ุงุฒ ุชูพ ุซุจุชโุดุฏู ุฏุฑ ุขุฒููู ุงุณุชูุงุฏู ูโฺฉูุฏ
        (ูุณูุงุณุ ูพุฑุชูุงุดโูุฑุงุฑุ ุขูุณุชูโูพูุณุชูุ ุฏูููโููุฏ) ู ุฑูฺฏ ู ุฑุชู ุฎูุฏ ุงูพ ูู ุจุง ุชูพุช ููุงููฺฏ ูโุดูุฏ.<br>
        ๐น ฺฏุฒููโ ยซููุด ูุตููุนยป ูุนูุงู ุบุฑูุนุงู ุงุณุช.
      </p>
      <label>ููุน ุจุฑูุงูู:</label>
      <select id="planMode">
        <option value="normal">ุจุฑูุงูู ุนุงุฏ</option>
        <option value="personality">ุจุฑูุงูู ุจุฑ ุงุณุงุณ ุชูพ ุดุฎุตุช</option>
        <option value="ai" disabled>ุจุฑูุงูู ุจุฑ ุงุณุงุณ ููุด ูุตููุน (ุจู ุฒูุฏ)</option>
      </select>
    </section>

    <!-- ฑ. ุงุทูุงุนุงุช ูพุงู (ูุดุชุฑฺฉ ุจุง ุฏโูุงู) -->
    <section>
      <h3>ฑ. ุงุทูุงุนุงุช ูพุงู ุฏุงูุดโุขููุฒ</h3>
      <p style="font-size:11px;color:#b30000;">ูู ููุฏูุง ุงู ุจุฎุด ุงุฌุจุงุฑ ูุณุชูุฏ ู ุจุฑุง ูููโ ุจุฑูุงููโูุง (ฑดุฑูุฒู ู ุฏโูุงู) ุงุณุชูุงุฏู ูโุดููุฏ.</p>
      <div class="row-flex">
        <div>
          <label>ูุงู</label><br>
          <input id="fname" type="text">
        </div>
        <div>
          <label>ูุงู ุฎุงููุงุฏฺฏ</label><br>
          <input id="lname" type="text">
        </div>
        <div>
          <label>ุดูุงุฑู ููุจุงู</label><br>
          <input id="phone" type="text" placeholder="ูุซูุงู 09123456789">
        </div>
        <div>
          <label>ุดูุฑ</label><br>
          <input id="city" type="text">
        </div>
        <div>
          <label>ูุงู ูุฏุฑุณู</label><br>
          <input id="school" type="text">
        </div>
        <div>
          <label>ูพุงู ุชุญุตู</label><br>
          <select id="grade">
            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
            <option>ุฏูู</option>
            <option>ุงุฒุฏูู</option>
            <option>ุฏูุงุฒุฏูู</option>
          </select>
        </div>
        <div>
          <label>ุฑุดุชู ุชุญุตู</label><br>
          <select id="major">
            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
            <option>ุชุฌุฑุจ</option>
            <option>ุฑุงุถ</option>
            <option>ุงูุณุงู</option>
          </select>
        </div>
      </div>
    </section>

    <!-- ฒ. ุณุงุนุงุช ูุทุงูุนู ฺฉู -->
    <section>
      <h3>ฒ. ุณุงุนุงุช ูุทุงูุนู ฺฉู</h3>
      <div class="row-flex">
        <div>
          <label>ุณุงุนุช ูุทุงูุนู ุฏุฑ ุฑูุฒ ุณูุฏ (ุจุฏูู ูุฏุฑุณู ู ฺฉูุงุณ)</label><br>
          <input id="whiteDay" type="number" step="0.5" min="0" max="15" value="8">
        </div>
        <div>
          <label>ุณุงุนุช ูุทุงูุนู ุฏุฑ ุฑูุฒ ูุฏุฑุณู (ุจุฏูู ฺฉูุงุณ ุจุฑูู)</label><br>
          <input id="schoolDay" type="number" step="0.5" min="0" max="10" value="4">
        </div>
      </div>
    </section>

    <!-- ณ. ูุถุนุช ูุฏุฑุณู -->
    <section>
      <h3>ณ. ูุถุนุช ูุฏุฑุณู ุฏุฑ ฑด ุฑูุฒ ุขูุฏู</h3>
      <table class="sub-table table-soft">
        <tr><th>ุฑูุฒ</th><th>ูโุฑูุฏ ูุฏุฑุณูุ</th></tr>
        <tbody id="attendanceBody"></tbody>
      </table>
    </section>

    <!-- ด. ฺฉูุงุณโูุง ุขููุงู -->
    <section>
      <h3>ด. ฺฉูุงุณโูุง ุขููุงู</h3>
      <p style="font-size:11px;color:#444">
        ฺฉูุงุณโูุง ุขููุงู ูู ุจูโุตูุฑุช ุชุณฺฉ ุฏุฑ ุจุฑูุงูู ูโุขูุฏุ ุงฺฏุฑ ุชฺฉ ูุฎูุฑุ ุฏุฑ ุจุฑูุงูู ุจุนุฏ ุจูโุนููุงู ููู ุขููุงู ุนูุจโุงูุชุงุฏู ุญุณุงุจ ูโุดููุฏ.
      </p>
      <button class="small-btn" onclick="addClassRow()">โ ุงูุฒูุฏู ฺฉูุงุณ</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฑูุฒ</th><th>ุฏุฑุณ</th><th>ูุฏุช (ุณุงุนุช)</th><th>ูุตู</th><th>ุญุฐู</th>
        </tr>
        <tbody id="classesBody"></tbody>
      </table>
    </section>

    <!-- ต. ุขุฒูููโูุง -->
    <section>
      <h3>ต. ุขุฒูููโูุง ุฏุฑ ฑด ุฑูุฒ ุขูุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุจุฑุง ูุฑ ุขุฒูููุ ูโุชูุงู ฺูุฏ ูุตู ู ฺูุฏ ููุจุน ุชุณุช ุชุนุฑู ฺฉู ู ุงฺฏุฑ ุจุฎูุงู ุชุญูู ุขุฒููู ูู ุงูุฌุงู ุดูุฏ.
      </p>
      <button class="small-btn" onclick="addExamCard()">โ ุงูุฒูุฏู ุขุฒููู</button>
      <div id="examsCards"></div>
    </section>

    <!-- ถ. ูููโูุง ุขููุงู -->
    <section>
      <h3>ถ. ูููโูุง ุขููุงู ุนูุจโุงูุชุงุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุงูุฌุง ุชุฑฺฉุจ ุนูุจโูุงูุฏฺฏโูุง ูุฏู + ููุงุฑุฏ ุงุณุช ฺฉู ุฎูุฏุช ุงุถุงูู ูโฺฉู. ูุจู ุงุฒ ุณุงุฎุช ุจุฑูุงููุ ูโุชูุงู ฺุฒูุง ุฑุง ฺฉู ุฏฺฏุฑ ุนูุจโูุงูุฏู ูุณุช ุญุฐู ฺฉู.
      </p>
      <button class="small-btn" onclick="addOfflineRow()">โ ุงูุฒูุฏู ููู ุขููุงู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฏุฑุณ</th><th>ูุตู</th><th>ูุฏุช (ุณุงุนุช)</th><th>ุญุฐู</th>
        </tr>
        <tbody id="offlineBody"></tbody>
      </table>
    </section>

    <!-- ท. ุชุณุชโูุง ุนูุจโูุงูุฏู -->
    <section>
      <h3>ท. ุชุณุชโูุง ุนูุจโูุงูุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุงู ูู ุชุฑฺฉุจ ุชุณุชโูุง ุงุณุช ฺฉู ุงุฒ ุจุฑูุงููโูุง ูุจู ุฌุง ูุงูุฏู + ุชุณุชโูุง ฺฉู ุฎูุฏุช ุจู ุนููุงู ุนูุจโูุงูุฏฺฏ ุชุนุฑู ูโฺฉู.
      </p>
      <button class="small-btn" onclick="addLagRow()">โ ุงูุฒูุฏู ุชุณุช ุนูุจโูุงูุฏู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฏุฑุณ</th><th>ูุตู</th><th>ููุจุน ุชุณุช</th><th>ุชุนุฏุงุฏ ุชุณุช</th><th>ุญุฐู</th>
        </tr>
        <tbody id="lagBody"></tbody>
      </table>
    </section>

    <!-- ธ. ูพุดุฑู -->
    <section>
      <h3>ธ. ูพุดุฑู ูพุดููุงุฏ</h3>
      <button class="small-btn" onclick="addProgRow()">โ ุงูุฒูุฏู ูุฏู ูพุดุฑู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฏุฑุณ</th><th>ูุตู</th><th>ููุจุน ุชุณุช</th><th>ุชุนุฏุงุฏ ุชุณุช</th><th>ุญุฐู</th>
        </tr>
        <tbody id="progBody"></tbody>
      </table>
    </section>

    <!-- น. ุชุฑุงุฒูุง -->
    <section>
      <h3>น. ุชุฑุงุฒ/ุฏุฑุตุฏ ูุงูฺฏู ุฏุฑูุณ ุงุฎุชุตุงุต</h3>
      <p style="font-size:11px;color:#444">ุจุฑุง ุชุดุฎุต ููุทู ููุช ู ุถุนู.</p>
      <div class="row-flex">
        <div>
          <label>ุชุฑุงุฒ ุฒุณุช</label><br>
          <input id="rankBio" type="number" step="10">
        </div>
        <div>
          <label>ุชุฑุงุฒ ุดู</label><br>
          <input id="rankChem" type="number" step="10">
        </div>
        <div>
          <label>ุชุฑุงุฒ ูุฒฺฉ</label><br>
          <input id="rankPhys" type="number" step="10">
        </div>
        <div>
          <label>ุชุฑุงุฒ ุฑุงุถ</label><br>
          <input id="rankMath" type="number" step="10">
        </div>
      </div>
    </section>

    <!-- ฑฐ. ุณุงุฎุช ุจุฑูุงูู -->
    <section>
      <h3>ฑฐ. ุณุงุฎุช ุจุฑูุงูู</h3>
      <button class="btn" onclick="onMakePlanClicked()">โ ุณุงุฎุช ุจุฑูุงูู ฑด ุฑูุฒู ู ุฐุฎุฑู ุฏุฑ Supabase</button>
      <button class="small-btn" onclick="downloadPlanTable()">๐จ๏ธ ูพุฑูุช / ุฎุฑูุฌ ุฌุฏูู</button>
      <span id="statusMsg" style="font-size:11px;color:#b30000;margin-right:10px;"></span>
    </section>

    <!-- ููุงุด ุจุฑูุงูู -->
    <section>
      <h3>ุจุฑูุงูู ฑด ุฑูุฒู (ุจุง ุชุงุฑุฎ ูุงูุน)</h3>
      <div id="coverageSummary"></div>
      <table id="scheduleTable" class="table-soft"></table>
    </section>

  </div>

  <!-- ุชุจ ุงูุชุญุงูุงุช ุฏโูุงู -->
  <div id="midtermTab" class="hidden">
    <!-- ฑ. ุจุงุฒู ุงูุชุญุงูุงุช -->
    <section>
      <h3>ฑ. ุจุงุฒู ุงูุชุญุงูุงุช ุฏโูุงู / ููโุณุงู</h3>
      <p style="font-size:11px;color:#444">
        ุงู ุจุฎุด ุจุฑุง ุจุฑูุงููโุฑุฒ ุฏูู ุจู ุงูุชุญุงูุงุช ูุฏุฑุณู (ุฏโูุงู / ูุงูโุชุฑู) ุงุณุช.
        ุงูู ุจุงุฒูโุง ุฑุง ฺฉู ุงูุชุญุงู ุฏุงุฑ ุงูุชุฎุงุจ ฺฉูุ ุจุนุฏ ุฌุฏูู ุฑูุฒูุง ู ุงูุชุญุงูโูุง ุฑุง ูโฺูู.
      </p>
      <div class="row-flex">
        <div>
          <label>ุชุงุฑุฎ ุดุฑูุน ุงูุชุญุงูุงุช</label><br>
          <input id="deyStartDate" type="date">
        </div>
        <div>
          <label>ุชุงุฑุฎ ูพุงุงู ุงูุชุญุงูุงุช</label><br>
          <input id="deyEndDate" type="date">
        </div>
      </div>
      <button class="small-btn" onclick="buildDeyDays()">๐ ุณุงุฎุช ุฌุฏูู ุฑูุฒูุง</button>
      <span id="deyRangeStatus" style="font-size:11px;color:#b30000;margin-right:8px;"></span>
    </section>

    <!-- ฒ. ูุถุนุช ูุฏุฑุณู ู ุณุงุนุช ูุทุงูุนู -->
    <section>
      <h3>ฒ. ูุถุนุช ูุฏุฑุณู ู ุณุงุนุงุช ูุทุงูุนู ุฏุฑ ุงู ุจุงุฒู</h3>
      <p style="font-size:11px;color:#444">
        ุฏุฑ ุงู ุฌุฏููุ ุจุฑุง ูุฑ ุฑูุฒ ุจฺฏู ูุฏุฑุณู ูโุฑู ุง ูู.
        ุณุงุนุช ูุทุงูุนู ุฑูุฒ ุณูุฏ / ูุฏุฑุณูโุง ูู ุจุฑุง ููู ุจุงุฒู ุฏโูุงู ุงุณุช (ููฺฉู ุงุณุช ุจุง ุจุฑูุงูู ูุนููู ูุฑู ฺฉูุฏ).
      </p>
      <div class="row-flex">
        <div>
          <label>ุณุงุนุช ูุทุงูุนู ุฑูุฒ ุณูุฏ ุฏุฑ ุฏโูุงู</label><br>
          <input id="deyWhiteDay" type="number" step="0.5" min="0" max="15" value="6">
        </div>
        <div>
          <label>ุณุงุนุช ูุทุงูุนู ุฑูุฒ ูุฏุฑุณู ุฏุฑ ุฏโูุงู</label><br>
          <input id="deySchoolDay" type="number" step="0.5" min="0" max="12" value="3">
        </div>
      </div>
      <table class="sub-table table-soft">
        <tr><th>ุฑูุฒ</th><th>ุชุงุฑุฎ</th><th>ุฑูุฒ ููุชู</th><th>ูุฏุฑุณู ูโุฑูุฏุ</th></tr>
        <tbody id="deyDaysBody"></tbody>
      </table>
    </section>

    <!-- ณ. ฺฉูุงุณโูุง ุขููุงู ุฏุฑ ุจุงุฒู ุฏโูุงู -->
    <section>
      <h3>ณ. ฺฉูุงุณโูุง ุขููุงู ุฏุฑ ุงู ุจุงุฒู</h3>
      <p style="font-size:11px;color:#444">
        ฺฉูุงุณโูุง ฺฉู ุฏุฑ ููู ุจุงุฒู ุงูุชุญุงูุงุช ุจุฑฺฏุฒุงุฑ ูโุดููุฏ ุฑุง ุงูุฌุง ูุงุฑุฏ ฺฉู ุชุง ุงุฒ ุณุงุนุช ููุฏ ฺฉู ุดููุฏ.
      </p>
      <button class="small-btn" onclick="addDeyClassRow()">โ ุงูุฒูุฏู ฺฉูุงุณ ุขููุงู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุชุงุฑุฎ</th><th>ุฏุฑุณ</th><th>ูุฏุช (ุณุงุนุช)</th><th>ุชูุถุญ/ูุตู</th><th>ุญุฐู</th>
        </tr>
        <tbody id="deyClassesBody"></tbody>
      </table>
    </section>

    <!-- ด. ุชุนุฑู ุงูุชุญุงูโูุง -->
    <section>
      <h3>ด. ุงูุชุญุงูโูุง ุงู ุจุงุฒู</h3>
      <p style="font-size:11px;color:#444">
        ุชุงุฑุฎ ู ููุน ูุฑ ุงูุชุญุงู ุฑุง ูุดุฎุต ฺฉู. ุงูฺฏูุฑุชูุ ูุฑุฌูโ ูุจู ูุฑ ุงูุชุญุงู ุฑุง ูพุฏุง ูโฺฉูุฏ ู ุจุฑุง ููุงู ุฏุฑุณ ุจุฑูุงูู ูโฺูุฏ.
      </p>
      <button class="small-btn" onclick="addDeyExamRow()">โ ุงูุฒูุฏู ุงูุชุญุงู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุชุงุฑุฎ ุงูุชุญุงู</th><th>ุฏุฑุณ</th><th>ููุน ุงูุชุญุงู</th><th>ูุฏุช (ุฏููู)</th><th>ุญุฐู</th>
        </tr>
        <tbody id="deyExamsBody"></tbody>
      </table>
    </section>

    <!-- ต. ูุณุชูุฑ ูุทุงูุนู ู ุชูุฑู ูุตูโูุง -->
    <section>
      <h3>ต. ูุณุชูุฑ ูุทุงูุนู ู ุชูุฑู ูุตูโูุง</h3>
      <p style="font-size:11px;color:#444">
        ุจุฑุง ูุฑ ุฏุฑุณุ ูุตูโูุง ฺฉู ุฏุฑ ุจูุฏุฌู ุงูุชุญุงู ูโุขูุฏ ุฑุง ูุงุฑุฏ ฺฉู ู ูุดุฎุต ฺฉู ูุทุงูุนู ู ุญู ุชูุฑูโุดุงู ุฑุง ุงูุฌุงู ุฏุงุฏูโุง ุง ูู.
        ุจุฑุง ด ุฏุฑุณ ุงุฎุชุตุงุต (ุฒุณุชุ ุดูุ ูุฒฺฉุ ุฑุงุถ) ูโุชูุงู ููุจุน ุชุณุช ู ุชุนุฏุงุฏ ุชุณุช ุจุงูโูุงูุฏู ุฑุง ูู ูุดุฎุต ฺฉู.
        ุงูฺฏูุฑุชู ุจุฑ ุงุณุงุณ ุฏุฑุตุฏ ูพูุดุด ูุฑ ุฏุฑุณุ ุฏุฑุตุฏ ุฒูุงู ูุจู ุงูุชุญุงู ุฑุง ุชูุฒุน ูโฺฉูุฏ.
      </p>
      <button class="small-btn" onclick="addDeyHistoryRow()">โ ุงูุฒูุฏู ูุตู / ุฏุฑุณ</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฏุฑุณ</th><th>ูุงู ูุตู / ุฏุฑุณ</th><th>ุฏุฑ ุจูุฏุฌู ุงูุชุญุงูุ</th>
          <th>ูุทุงูุนู ุดุฏู</th><th>ุญู ุชูุฑู ุดุฏู</th>
          <th>ููุจุน ุชุณุช (ุจุฑุง ุงุฎุชุตุงุต)</th><th>ุชุณุช ุจุงูโูุงูุฏู</th><th>ุญุฐู</th>
        </tr>
        <tbody id="deyHistoryBody"></tbody>
      </table>
    </section>

    <!-- ถ. ุณุงุฎุช ุจุฑูุงูู ุฏโูุงู -->
    <section>
      <h3>ถ. ุณุงุฎุช ุจุฑูุงูู ุงูุชุญุงูุงุช ุฏโูุงู</h3>
      <button class="btn" onclick="onMakeDeyPlan()">๐ ุณุงุฎุช ุจุฑูุงูู ุฏโูุงู ู ุฐุฎุฑู ุฏุฑ Supabase</button>
      <span id="deyStatusMsg" style="font-size:11px;color:#b30000;margin-right:10px;"></span>
    </section>

    <!-- ท. ููุงุด ุจุฑูุงูู ุฏโูุงู -->
    <section>
      <h3>ุจุฑูุงููโ ูุฎุตูุต ุงูุชุญุงูุงุช ุฏโูุงู</h3>
      <p style="font-size:11px;color:#444">
        ุฏุฑ ุงู ุฌุฏููุ ุจูโุฌุง ยซุฑูุฒ ฑุ ฒุ ...ยป ุชุงุฑุฎ ูุงูุน ู ุฑูุฒ ููุชู ููุงุด ุฏุงุฏู ูโุดูุฏ.
      </p>
      <table id="deyScheduleTable" class="table-soft"></table>
    </section>
  </div>

  <!-- ุชุจ ุจุฑูุงููโูุง ูู (ุฏุงูุดโุขููุฒ) -->
  <div id="studentTab" class="hidden">
    <section>
      <h3>ุจุฑูุงููโูุง ูู</h3>
      <p style="font-size:11px;color:#444">
        ุฑู ูุฑ ุจุฑูุงูู ฺฉูฺฉ ฺฉู ุชุง ุชุณฺฉโูุง ููุงู ุจุฑูุงูู ุฑุง ุจุจู ู ุชฺฉ ุจุฒู.
      </p>
      <table id="studentPlansTable" class="sub-table table-soft"></table>
    </section>

    <section>
      <h3>ุชุณฺฉโูุง ุจุฑูุงูู ุงูุชุฎุงุจโุดุฏู</h3>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap;">
        <p id="studentTasksInfo" style="font-size:11px;color:#444;margin:0;"></p>
        <div style="font-size:11px;">
          ููุชุฑ ุฑูุฒ (ุจุฑ ุงุณุงุณ ุดูุงุฑู ุฑูุฒ ุจุฑูุงููุ ุฏุฑ ุฌุฏูู ุงุตู ุชุงุฑุฎ ูุงูุน ููุงุด ุฏุงุฏู ูโุดูุฏ):
          <select id="studentDayFilter" onchange="renderStudentTasksFiltered()">
            <option value="all">ููู ุฑูุฒูุง</option>
            <option value="1">ุฑูุฒ ฑ</option>
            <option value="2">ุฑูุฒ ฒ</option>
            <option value="3">ุฑูุฒ ณ</option>
            <option value="4">ุฑูุฒ ด</option>
            <option value="5">ุฑูุฒ ต</option>
            <option value="6">ุฑูุฒ ถ</option>
            <option value="7">ุฑูุฒ ท</option>
            <option value="8">ุฑูุฒ ธ</option>
            <option value="9">ุฑูุฒ น</option>
            <option value="10">ุฑูุฒ ฑฐ</option>
            <option value="11">ุฑูุฒ ฑฑ</option>
            <option value="12">ุฑูุฒ ฑฒ</option>
            <option value="13">ุฑูุฒ ฑณ</option>
            <option value="14">ุฑูุฒ ฑด</option>
          </select>
          <button class="small-btn" onclick="showInstantReport()">๐ ฺฏุฒุงุฑุด ูุญุธูโุง</button>
        </div>
      </div>
      <table id="studentTasksTable" class="sub-table table-soft"></table>
      <div id="instantReportBox" style="font-size:11px;color:#333;margin-top:6px;"></div>
    </section>
  </div>

  <!-- ุชุจ ุนูุจโูุงูุฏฺฏโูุง -->
  <div id="backlogTab" class="hidden">
    <section>
      <h3>๐ฆ ุนูุจโูุงูุฏฺฏโูุง ุซุจุช ุดุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุงูโูุง ุชุณฺฉโูุง ูุณุชูุฏ ฺฉู ุชุงุฑุฎโุดุงู ฺฏุฐุดุชู ู ฺฉุงูู ุงูุฌุงู ูุดุฏูโุงูุฏ (ุงูุฌุงูโูุดุฏู ุง ูุงูุต).
        ุจุฑุง ุจุฑูุงูู ุจุนุฏุ ุงุฒ ุงูโูุง ุจู ุนููุงู ุนูุจโูุงูุฏฺฏ ุงุณุชูุงุฏู ูโุดูุฏ.
      </p>
      <button class="small-btn" onclick="loadBacklogView()">๐ ุจูโุฑูุฒุฑุณุงู ูุณุช ุนูุจโูุงูุฏฺฏ</button>
      <table id="backlogTable" class="sub-table table-soft"></table>
    </section>
  </div>

  <!-- ุชุจ ูพุงูโูุง -->
  <div id="messagesTab" class="hidden">
    <section>
      <h3>๐ฌ ูพุงูโูุง ู ฺฏุฒุงุฑุดโูุง ุฑูุฒุงูู</h3>
      <p style="font-size:11px;color:#444">
        ุงูุฌุง ูู ูพุงูโูุง ุฏุณุช ูุดุงูุฑ ุซุจุช ูโุดูุฏุ ูู ฺฏุฒุงุฑุดโูุง ุฎูุฏฺฉุงุฑ ุฑูุฒุงูู.
        <br>ฺฏุฒุงุฑุด ุฎูุฏฺฉุงุฑ ูุฑ ุฑูุฒุ ุจุฑ ุงุณุงุณ ุชุณฺฉโูุง ุงูุฌุงูโุดุฏู ู ุงูุฌุงูโูุดุฏู ููุงู ุฑูุฒ ุณุงุฎุชู ูโุดูุฏ.
      </p>
      <div class="row-flex">
        <div>
          <label>ูพุงู ุฏุณุช ุจุฑุง ุฏุงูุดโุขููุฒ (ุฎูุฏุช ุจููุณ)</label><br>
          <textarea id="manualMessageText" style="width:100%;min-height:70px;"></textarea><br>
          <button class="btn" onclick="sendManualMessage()">ุงุฑุณุงู ู ุฐุฎุฑู ูพุงู</button>
        </div>
        <div>
          <label>ฺฏุฒุงุฑุด ุฎูุฏฺฉุงุฑ ุงูุฑูุฒ</label><br>
          <button class="small-btn" onclick="generateTodayReport()">๐ ุณุงุฎุช ฺฏุฒุงุฑุด ุงูุฑูุฒ (ุงูุงู)</button>
          <p style="font-size:10px;color:#666;margin-top:4px;">
            ุฏุฑ ฺฉูุงุฑ ุงูุ ุณุณุชู ุฏุฑ ูุฑ ุจุงุฑ ูุฑูุฏุ ุจุฑุฑุณ ูโฺฉูุฏ ุงฺฏุฑ ุงุฒ ุณุงุนุช ~ฑฑ ุดุจ ฺฏุฐุดุชู ู ฺฏุฒุงุฑุด ุจุฑุง ุงูุฑูุฒ ุซุจุช ูุดุฏูุ
            ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฏุฒุงุฑุด ุฑุง ุฏุฑ ููู ูุณุช ุงุถุงูู ฺฉูุฏ (ุชุง ุฌุง ฺฉู ุตูุญู ุจุงุฒ ุจุงุดุฏ).
          </p>
        </div>
      </div>
    </section>

    <section>
      <h3>๐ ุชุงุฑุฎฺู ูพุงูโูุง</h3>
      <div id="messagesList"></div>
    </section>
  </div>

  <!-- ุชุจ ูพูู ุงุฏูู -->
  <div id="adminTab" class="hidden">
    <section>
      <h3>ูุณุช ุจุฑูุงููโูุง ุฏุงูุดโุขููุฒุงู</h3>
      <table id="adminPlansTable" class="sub-table table-soft"></table>
    </section>
    <section>
      <h3>ุชุณฺฉโูุง ุจุฑูุงูู ุงูุชุฎุงุจโุดุฏู</h3>
      <p id="adminPlanTitle" style="font-size:11px;color:#444;"></p>
      <table id="adminTasksTable" class="sub-table table-soft"></table>

      <div style="margin-top:10px;">
        <h4>โ ุงูุฒูุฏู ุชุณฺฉ ุฏุณุช ุจู ุงู ุจุฑูุงูู</h4>
        <label>ุฑูุฒ (ฑ ุชุง ฑด): </label>
        <input id="adminNewTaskDay" type="number" min="1" max="14" value="1"><br>
        <label>ูุชู ุชุณฺฉ:</label><br>
        <textarea id="adminNewTaskText" style="width:100%;height:60px;"></textarea><br>
        <button class="small-btn" onclick="adminAddTask()">ุงูุฒูุฏู ุชุณฺฉ</button>
      </div>
    </section>
  </div>

</div> <!-- ูพุงุงู appContainer -->

<!-- Supabase + JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== ุชูุธูุงุช Supabase ===== */
var supabaseUrl = "https://uregjguhgbzwgwlzqbef.supabase.co";
var supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyZWdqZ3VoZ2J6d2d3bHpxYmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMTE5OTQsImV4cCI6MjA4MjY4Nzk5NH0.Gsqi4NKf4SssTVzTdC4AvIJCoynC31prHK_Gr7fZCzI";
var supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ===== ุงูู ุงุฏูู ===== */
var ADMIN_EMAILS = ["pouri007008009@gmail.com"];

/* ===== ูุถุนุชโูุง ุชุณฺฉ ===== */
var TASK_STATUS = {
  TODO: "todo",
  PARTIAL: "partial",
  DONE: "done"
};

/* ===== ูุชุบุฑูุง ุชูพ ุดุฎุตุช ===== */
var currentPersonalityType = null;      // "obsessive" | "runner" | "steady" | "lastminute"
var currentPersonalityUpdated = null;   // "YYYY-MM-DD"
var computedPersonalityType = null;

var PERSONALITY_LABELS = {
  obsessive: "ูุณูุงุณ ุฏูู",
  runner: "ูพุฑุชูุงุด ุงูุง ูุฑุงุฑ",
  steady: "ุขูุณุชู ู ูพูุณุชู",
  lastminute: "ููุฑูุงู ุฏููู ููุฏ"
};

var PERSONALITY_DESCRIPTIONS = {
  obsessive: "ุชูุฑฺฉุฒ ุจุงูุง ุฑู ฺฉุงููโฺฉุฑุฏู ฺฉุงุฑูุงุ ุญุณุงุณ ูุณุจุช ุจู ุนูุจโูุงูุฏฺฏ ู ููุต ุฏุฑ ุจุฑูุงูู.",
  runner: "ุชูุงุดโฺฏุฑ ุงูุง ูุฑูุงุฑ ุงุฒ ุดุฑูุนุ ูุงุฒ ุจู ูุฑูุฑูุง ฺฉูุชุงู ู ุงูฺฏุฒูโ ูุฏุงูู.",
  steady: "ุฑุชู ุซุงุจุชุ ุฏูุณุชโุฏุงุฑ ุจุฑูุงููโ ฺฉููุงุฎุช ู ุจุฏูู ููุณุงู ุดุฏุฏ.",
  lastminute: "ุงูุฑฺ ุงุตู ูุฒุฏฺฉ ุฏุฏูุงู ู ุขุฒููู ุฑูุดู ูโุดูุฏุ ุญุฌู ุจุดุชุฑ ุฏุฑ ููุชูโ ุฏูู ุจูุชุฑ ุฌูุงุจ ูโุฏูุฏ."
};

/* ูุชุบุฑูุง ุณุฑุงุณุฑ ุจุฑูุงููโูุง ู ูพูู ุฏุงูุดโุขููุฒ/ุงุฏูู/ูพุงูโูุง */
var personalityRows = [];
var personalityCurrent = 0;
var currentStudentPlanId = null;
var currentStudentPlanDate = null;
var currentStudentTasks = [];
var backlogPrefilled = false;
var currentAdminPlanId = null;
var currentAdminStudentName = "";
var currentAdminProgramDate = "";
var lastDailyReportDate = null; // ุจุฑุง ฺฉูุชุฑู ฺฏุฒุงุฑุด ุฎูุฏฺฉุงุฑ

/* ===== ููุดู ุชุฃุซุฑ ุณุคุงูุงุช ุขุฒููู ุจุฑ ุชูพโูุง ===== */
var personalityConfig = {
  q1: {obsessive:2},
  q2: {runner:2},
  q3: {steady:2},
  q4: {lastminute:2},
  q5: {obsessive:2},
  q6: {runner:1, steady:1},
  q7: {steady:2},
  q8: {runner:2},
  q9: {obsessive:2},
  q10:{lastminute:2},
  q11:{steady:1, runner:1},
  q12:{obsessive:1, steady:1},
  q13:{steady:2},
  q14:{runner:1,lastminute:1},
  q15:{steady:2},
  q16:{lastminute:2}
};

/* ===== ุชู ุจุฑ ุงุณุงุณ ุชูพ ===== */
function applyPersonalityTheme(type){
  var body = document.body;
  body.classList.remove("theme-steady","theme-obsessive","theme-runner","theme-lastminute");
  if(type === "obsessive") body.classList.add("theme-obsessive");
  else if(type === "runner") body.classList.add("theme-runner");
  else if(type === "lastminute") body.classList.add("theme-lastminute");
  else body.classList.add("theme-steady");
}

/* ===== ุฏุงุฑฺฉโููุฏ ===== */
function applyModeFromStorage(){
  var body = document.body;
  var mode = localStorage.getItem("planner-mode") || "dark";
  if(mode === "dark"){
    body.classList.add("dark-mode");
  } else {
    body.classList.remove("dark-mode");
  }
  updateModeToggleText();
}
function toggleMode(){
  var body = document.body;
  var isDark = !body.classList.contains("dark-mode");
  if(isDark){
    body.classList.add("dark-mode");
    localStorage.setItem("planner-mode","dark");
  }else{
    body.classList.remove("dark-mode");
    localStorage.setItem("planner-mode","light");
  }
  updateModeToggleText();
}
function updateModeToggleText(){
  var btn = document.getElementById("modeToggleBtn");
  if(!btn) return;
  if(document.body.classList.contains("dark-mode")){
    btn.textContent = "โ ุญุงูุช ุฑูุดู";
  } else {
    btn.textContent = "๐ ุญุงูุช ุชุฑู";
  }
}

/* ===== ูุฒุงุฑุฏ ุขุฒููู ุดุฎุตุช ===== */
function initPersonalityWizard(){
  var table = document.querySelector(".personality-table");
  if(!table) return;
  var trs = Array.from(table.querySelectorAll("tr"));
  personalityRows = trs.slice(1);
  if(!personalityRows.length) return;
  personalityCurrent = 0;
  updatePersonalityWizardUI();

  var prevBtn = document.getElementById("personalityPrevBtn");
  var nextBtn = document.getElementById("personalityNextBtn");
  if(prevBtn){
    prevBtn.onclick = function(){
      if(personalityCurrent>0){
        personalityCurrent--;
        updatePersonalityWizardUI();
      }
    };
  }
  if(nextBtn){
    nextBtn.onclick = function(){
      if(!isCurrentQuestionAnswered()){
        alert("ูุทูุงู ุจู ุงู ุณุคุงู ูพุงุณุฎ ุจุฏู ุจุนุฏ ุจุฑู ุณุฑุงุบ ุจุนุฏ ๐");
        return;
      }
      if(personalityCurrent < personalityRows.length-1){
        personalityCurrent++;
        updatePersonalityWizardUI();
      }else{
        computePersonality();
      }
    };
  }
}
function isCurrentQuestionAnswered(){
  var row = personalityRows[personalityCurrent];
  if(!row) return true;
  var radios = row.querySelectorAll('input[type="radio"]');
  for(var i=0;i<radios.length;i++){
    if(radios[i].checked) return true;
  }
  return false;
}
function updatePersonalityWizardUI(){
  if(!personalityRows || !personalityRows.length) return;
  personalityRows.forEach(function(tr){ tr.style.display="none"; });
  var row = personalityRows[personalityCurrent];
  if(row) row.style.display="";
  var stepLabel = document.getElementById("personalityStepLabel");
  var progInner = document.getElementById("personalityProgressInner");
  var prevBtn = document.getElementById("personalityPrevBtn");
  var nextBtn = document.getElementById("personalityNextBtn");
  var total = personalityRows.length;
  var step = personalityCurrent + 1;
  if(stepLabel) stepLabel.textContent = "ุณุคุงู "+step+" ุงุฒ "+total;
  if(progInner) progInner.style.width = (step*100/total)+"%";
  if(prevBtn) prevBtn.disabled = (personalityCurrent===0);
  if(nextBtn){
    if(personalityCurrent===total-1) nextBtn.textContent = "ูุดุงูุฏู ูุชุฌู";
    else nextBtn.textContent = "ุณุคุงู ุจุนุฏ";
  }
}

/* ===== ุชุจโูุง ===== */
function showTab(tabId){
  ["introTab","personalityTab","plannerTab","midtermTab","studentTab","backlogTab","messagesTab","adminTab"].forEach(function(id){
    var el = document.getElementById(id);
    if(el) el.classList.add("hidden");
  });
  var target = document.getElementById(tabId);
  if(target) target.classList.remove("hidden");

  var btns = document.querySelectorAll(".tab-btn");
  btns.forEach(function(b){ b.classList.remove("active"); });

  if(tabId === "introTab") document.getElementById("introTabBtn").classList.add("active");
  if(tabId === "personalityTab") document.getElementById("personalityTabBtn").classList.add("active");
  if(tabId === "plannerTab") document.getElementById("plannerTabBtn").classList.add("active");
  if(tabId === "midtermTab") document.getElementById("midtermTabBtn").classList.add("active");
  if(tabId === "studentTab") document.getElementById("studentTabBtn").classList.add("active");
  if(tabId === "backlogTab") document.getElementById("backlogTabBtn").classList.add("active");
  if(tabId === "messagesTab") document.getElementById("messagesTabBtn").classList.add("active");
  if(tabId === "adminTab") document.getElementById("adminTabBtn").classList.add("active");
}


/* ===== ูุงฺฏู ===== */
async function handleLogin(){
  var email = document.getElementById("loginEmail").value.trim();
  var pass  = document.getElementById("loginPassword").value;
  var status= document.getElementById("loginStatus");
  status.style.color="#b30000";
  status.textContent="";

  if(!email){
    status.textContent="ุงูู ุฑุง ูุงุฑุฏ ฺฉู.";
    return;
  }
  if(!pass || pass.length<6){
    status.textContent="ูพุณูุฑุฏ ุจุงุฏ ุญุฏุงูู ถ ฺฉุงุฑุงฺฉุชุฑ ุจุงุดุฏ.";
    return;
  }

  var res = await supabase.auth.signInWithPassword({email:email,password:pass});
  if(res.error){
    status.textContent="ุฎุทุง ุฏุฑ ูุฑูุฏ: "+res.error.message;
    return;
  }

  document.getElementById("loginContainer").classList.add("hidden");
  document.getElementById("appContainer").classList.remove("hidden");
  document.getElementById("currentUserEmail").textContent = "ฺฉุงุฑุจุฑ: "+email;

  if(ADMIN_EMAILS.indexOf(email)>=0){
    document.getElementById("adminTabBtn").style.display="inline-flex";
  }

  // ฑ) ููุฏ ูพุฑููุงู (ูุนุงุฑูู + ุชูพ ุดุฎุตุช)
  await loadIntroAndPersonality(email);
  console.log("DEBUG intro_done =", window._introDone);

  // ฒ) ุจูู ฺุฒูุง ูุซู ูุจู
  applyModeFromStorage && applyModeFromStorage();
  loadStudentPlans();
  loadMessages && loadMessages();
  if(ADMIN_EMAILS.indexOf(email)>=0){
    loadAdminPlans();
  }
  prefillBacklogFromAllPlans();
  loadBacklogView();
  tryAutoDailyReport && tryAutoDailyReport();

// ูููุชุงู ููุดู ุชุจ ูุนุงุฑูู ุฑุง ูุดุงู ุจุฏู ุชุง ุชุณุช ฺฉูู
document.getElementById("introTabBtn").style.display = "inline-flex";
showTab("introTab");
}

/* ===== ุซุงุจุชโูุง ู ุชูุงุจุน ุนููู ===== */
var SOURCE_MIN_PER_QUESTION = {
  "ุฎู ุณุจุฒ": 1.67,
  "ูุฑุฏุจุงู": 2.25,
  "ูุจุชฺฉุฑุงู": 2.0,
  "ูุดุฑุงูฺฏู": 1.67,
  "ุณู ุณุทุญ": 1.67,
  "QB": 2.0,
  "ููุฌ ุขุฒููู": 1.67,
  "ูุตู ุขุฒููู": 1.67,
  "IQ": 2.0,
  "ูฺฉุฑู ฺฏุงุฌ": 1.67,
  "ุชุชุงููู": 2.25
};
function studyRatio(subject){
  if(subject==="ุฒุณุช")  return 0.40;
  if(subject==="ุดู")  return 0.30;
  if(subject==="ูุฒฺฉ") return 0.20;
  if(subject==="ุฑุงุถ") return 0.20;
  return 0;
}
function detectStrongWeak(stats){
  if(!stats) return {strong:"ุฒุณุช",weak:"ุฑุงุถ"};
  var arr=[];
  if(stats.biology && stats.biology.avgRank>0)   arr.push({key:"ุฒุณุช",  rank:stats.biology.avgRank});
  if(stats.chemistry && stats.chemistry.avgRank>0) arr.push({key:"ุดู",  rank:stats.chemistry.avgRank});
  if(stats.physics && stats.physics.avgRank>0)   arr.push({key:"ูุฒฺฉ", rank:stats.physics.avgRank});
  if(stats.math && stats.math.avgRank>0)      arr.push({key:"ุฑุงุถ", rank:stats.math.avgRank});
  if(!arr.length) return {strong:"ุฒุณุช",weak:"ุฑุงุถ"};
  arr.sort(function(a,b){return b.rank-a.rank;});
  return {strong:arr[0].key,weak:arr[arr.length-1].key};
}
function parseDurationToHours(str){
  if(!str) return 0;
  str=String(str).trim();
  if(str.indexOf("min")>-1){
    var m=parseInt(str,10); return m/60;
  }
  if(str.indexOf("h")>-1){
    return parseFloat(str);
  }
  var n=parseFloat(str); return isNaN(n)?0:n;
}
function formatHoursWithMinutes(h){
  h = Math.max(0, h);
  var hrsFloat = h;
  var hrs = Math.floor(hrsFloat);
  var mins = Math.round((hrsFloat - hrs)*60);
  if(mins % 5 !== 0){
    mins = mins + (5 - (mins % 5));
  }
  if(mins === 60){
    hrs += 1;
    mins = 0;
  }
  var hText = hrsFloat.toFixed(1);
  if(hText.endsWith(".0")) hText = hText.slice(0,-2);
  var totalMin = hrs*60 + mins;
  if(hrs>0 || mins>0){
    return hText+' ุณุงุนุช ('+totalMin+' ุฏููู)';
  }else{
    return '0 ุฏููู';
  }
}

/* ุชุนุฏุงุฏ ูุตูโูุง ุจุฑุง ุชููุฏ ุณุงุฏูโ ฺฏุฒููโูุง (ููุท ุฏุฑ ุจุฑูุงูู ฑดุฑูุฒู) */
var SUBJECT_CHAPTER_COUNT = {
  "ุฒุณุช": 8,
  "ุดู": 4,
  "ูุฒฺฉ": 4,
  "ุฑุงุถ": 7,
  "ุงุฏุจุงุช": 18,
  "ุฏู": 12,
  "ุนุฑุจ": 8,
  "ุฒุจุงู": 4
};
function getChapterOptionsForSubject(subj){
  var n = SUBJECT_CHAPTER_COUNT[subj] || 10;
  var html = "";
  for(var i=1;i<=n;i++){
    html += '<option value="ูุตู '+i+'">ูุตู '+i+'</option>';
  }
  return html;
}
function updateTopicOptions(selectEl, topicClass){
  var subj = selectEl.value;
  var row  = selectEl.closest("tr") || selectEl.closest(".exam-card") || selectEl.closest("div");
  var topicSel;
  if(topicClass){
    topicSel = row.querySelector("."+topicClass);
  }else{
    topicSel = row.querySelector("select");
  }
  if(!topicSel) return;
  var prev = topicSel.value;
  topicSel.innerHTML = getChapterOptionsForSubject(subj);
  var exists=false;
  for(var i=0;i<topicSel.options.length;i++){
    if(topicSel.options[i].value===prev){ exists=true; break;}
  }
  if(exists) topicSel.value=prev;
}

/* ูุจู ุชุงุฑุฎโูุง ุงุฒ ุฑู program_date ุจุฑุง ุจุฑูุงูู ฑดุฑูุฒู */
function getDateLabelsFromProgramDate(programDateStr){
  if(!programDateStr) return Array(14).fill(null);
  var parts = programDateStr.split("-");
  var y = parseInt(parts[0],10);
  var m = parseInt(parts[1],10)-1;
  var d = parseInt(parts[2],10);
  var base = new Date(y,m,d);
  var weekdays = ["ฺฉุดูุจู","ุฏูุดูุจู","ุณูโุดูุจู","ฺูุงุฑุดูุจู","ูพูุฌโุดูุจู","ุฌูุนู","ุดูุจู"];
  var labels=[];
  for(var i=1;i<=14;i++){
    var dd = new Date(base);
    dd.setDate(base.getDate()+i);
    var wd = weekdays[dd.getDay()];
    var yy = dd.getFullYear();
    var mm = (dd.getMonth()+1).toString().padStart(2,'0');
    var da = dd.getDate().toString().padStart(2,'0');
    labels.push(wd+" "+yy+"/"+mm+"/"+da);
  }
  return labels;
}

/* ===== ุฑูุฏุงุฏ DOM ===== */
document.addEventListener("DOMContentLoaded", function(){
  applyPersonalityTheme("steady");
  applyModeFromStorage();
  initPersonalityWizard();

  /* ุฌุฏูู ฑด ุฑูุฒ ูุฏุฑุณู */
  var attBody=document.getElementById("attendanceBody");
  for(var d=1;d<=14;d++){
    var tr=document.createElement("tr");
    tr.innerHTML=
      '<td style="text-align:center">'+d+'</td>'+
      '<td><select class="att-select" data-day="'+d+'">'+
      '<option value="ุจูู">ุจูู (ูุฏุฑุณู ูโุฑูุฏ)</option>'+
      '<option value="ุฎุฑ">ุฎุฑ</option>'+
      '</select></td>';
    attBody.appendChild(tr);
  }

  document.getElementById("examsCards").addEventListener("click",function(e){
    if(e.target.classList.contains("delete-exam-card")){
      var card=e.target.closest(".exam-card");
      if(card) card.remove();
    }
  });
});

/* ===== ุงูุฒูุฏู ุฑุฏูโูุง (ุจุฑูุงูู ฑดุฑูุฒู) ===== */
function addClassRow(){
  var tbody=document.getElementById("classesBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><input type="number" class="class-day" min="1" max="14" value="1"></td>'+
    '<td><select class="class-subject" onchange="updateTopicOptions(this, \'class-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
      '<option>ุงุฏุจุงุช</option><option>ุฏู</option><option>ุนุฑุจ</option><option>ุฒุจุงู</option>'+
    '</select></td>'+
    '<td><input type="number" step="0.5" class="class-duration" value="2"></td>'+
    '<td><select class="class-topic"></select></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  var subjSel=tr.querySelector(".class-subject");
  updateTopicOptions(subjSel,"class-topic");
}
function addExamCard(){
  var container=document.getElementById("examsCards");
  var div=document.createElement("div");
  div.className="exam-card";
  div.innerHTML=
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">'+
      '<strong>ุขุฒููู ุฌุฏุฏ</strong>'+
      '<button type="button" class="small-btn del delete-exam-card">ุญุฐู ุขุฒููู</button>'+
    '</div>'+
    'ุฑูุฒ ุขุฒููู: <input type="number" class="exam-day" min="1" max="14" value="14"> '+
    'ุฏุฑุณ: <select class="exam-subject" onchange="refreshExamChapters(this)">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
      '<option>ุงุฏุจุงุช</option><option>ุฏู</option><option>ุนุฑุจ</option><option>ุฒุจุงู</option>'+
    '</select> '+
    'ููุน: <select class="exam-type">'+
      '<option>ุขุฒููู ุขุฒูุงุด</option>'+
      '<option>ุงูุชุญุงู ูุฏุฑุณู</option>'+
      '<option>ุงูุชุญุงู ฺฉูุงุณ ุจุฑูู</option>'+
    '</select> '+
    'ูุฏุช: <select class="exam-duration">'+
      '<option value="30min">ณฐ ุฏููู</option>'+
      '<option value="45min">ดต ุฏููู</option>'+
      '<option value="60min">ฑ ุณุงุนุช</option>'+
      '<option value="90min">ฑ.ต ุณุงุนุช</option>'+
      '<option value="120min">ฒ ุณุงุนุช</option>'+
      '<option value="180min">ณ ุณุงุนุช</option>'+
    '</select>'+
    '<br><br>'+
    'ูุทุงูุนู/ุชุณุช ุฏุฑ ุฎูุฏ ุฑูุฒ ุขุฒููู ูุฌุงุฒ ุจุงุดุฏุ '+
    '<input type="checkbox" class="exam-allow-today" checked> '+
    '๐ ุชุญูู ุขุฒูููุ <input type="checkbox" class="exam-analysis-need"> '+
    'ุงููู ุฑูุฒ ูุฌุงุฒ ุจุฑุง ุชุญูู: <input type="number" class="exam-analysis-start" min="1" max="14" value="14">'+
    '<hr style="margin:6px 0;">'+
    '<div><strong>ูุตูโูุง:</strong> <button type="button" class="small-btn" onclick="addExamChapter(this)">โ ูุตู</button>'+
    '<div class="exam-chapters-box" style="margin-top:4px;"></div></div>'+
    '<hr style="margin:6px 0;">'+
    '<div><strong>ููุงุจุน ุชุณุช:</strong> <button type="button" class="small-btn" onclick="addExamSource(this)">โ ููุจุน ุชุณุช</button>'+
    '<div class="exam-sources-box" style="margin-top:4px;"></div></div>';
  container.appendChild(div);
}
function refreshExamChapters(subjSelect){
  var card=subjSelect.closest(".exam-card");
  var subj=subjSelect.value;
  var boxes=card.querySelectorAll(".exam-chapter");
  for(var i=0;i<boxes.length;i++){
    var sel=boxes[i];
    var prev=sel.value;
    sel.innerHTML=getChapterOptionsForSubject(subj);
    var exists=false;
    for(var j=0;j<sel.options.length;j++){
      if(sel.options[j].value===prev){exists=true;break;}
    }
    if(exists) sel.value=prev;
  }
}
function addExamChapter(btn){
  var box=btn.parentElement.querySelector(".exam-chapters-box");
  var card=btn.closest(".exam-card");
  var subj=card.querySelector(".exam-subject").value;
  var d=document.createElement("div");
  d.innerHTML=
    'ูุตู: <select class="exam-chapter">'+getChapterOptionsForSubject(subj)+'</select> '+
    '<button type="button" class="small-btn del" onclick="this.parentElement.remove()">ุญุฐู</button>';
  box.appendChild(d);
}
function addExamSource(btn){
  var box=btn.parentElement.querySelector(".exam-sources-box");
  var d=document.createElement("div");
  d.innerHTML=
    'ููุจุน: <select class="exam-source">'+
      '<option>ุฎู ุณุจุฒ</option><option>ูุฑุฏุจุงู</option><option>ูุจุชฺฉุฑุงู</option>'+
      '<option>ูุดุฑุงูฺฏู</option><option>ุณู ุณุทุญ</option><option>QB</option>'+
      '<option>ููุฌ ุขุฒููู</option><option>ูุตู ุขุฒููู</option><option>IQ</option>'+
      '<option>ูฺฉุฑู ฺฏุงุฌ</option><option>ุชุชุงููู</option>'+
    '</select> '+
    'ุชุนุฏุงุฏ ุชุณุช: <input type="number" class="exam-count" min="10" step="10" value="100"> '+
    '<button type="button" class="small-btn del" onclick="this.parentElement.remove()">ุญุฐู</button>';
  box.appendChild(d);
}
function addOfflineRow(){
  var tbody=document.getElementById("offlineBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="off-subject" onchange="updateTopicOptions(this, \'off-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
      '<option>ุงุฏุจุงุช</option><option>ุฏู</option><option>ุนุฑุจ</option><option>ุฒุจุงู</option>'+
    '</select></td>'+
    '<td><select class="off-topic"></select></td>'+
    '<td><input type="number" step="0.5" class="off-hours" value="2"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  updateTopicOptions(tr.querySelector(".off-subject"),"off-topic");
}
function addLagRow(){
  var tbody=document.getElementById("lagBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="lag-subject" onchange="updateTopicOptions(this, \'lag-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
    '</select></td>'+
    '<td><select class="lag-topic"></select></td>'+
    '<td><select class="lag-source">'+
      '<option>ุฎู ุณุจุฒ</option><option>ูุฑุฏุจุงู</option><option>ูุจุชฺฉุฑุงู</option>'+
      '<option>ูุดุฑุงูฺฏู</option><option>ุณู ุณุทุญ</option><option>QB</option>'+
      '<option>ููุฌ ุขุฒููู</option><option>ูุตู ุขุฒููู</option><option>IQ</option>'+
      '<option>ูฺฉุฑู ฺฏุงุฌ</option><option>ุชุชุงููู</option>'+
    '</select></td>'+
    '<td><input type="number" class="lag-count" min="10" step="10" value="80"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  updateTopicOptions(tr.querySelector(".lag-subject"),"lag-topic");
}
function addProgRow(){
  var tbody=document.getElementById("progBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="prog-subject" onchange="updateTopicOptions(this, \'prog-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
    '</select></td>'+
    '<td><select class="prog-topic"></select></td>'+
    '<td><select class="prog-source">'+
      '<option>ุฎู ุณุจุฒ</option><option>ูุฑุฏุจุงู</option><option>ูุจุชฺฉุฑุงู</option>'+
      '<option>ูุดุฑุงูฺฏู</option><option>ุณู ุณุทุญ</option><option>QB</option>'+
      '<option>ููุฌ ุขุฒููู</option><option>ูุตู ุขุฒููู</option><option>IQ</option>'+
      '<option>ูฺฉุฑู ฺฏุงุฌ</option><option>ุชุชุงููู</option>'+
    '</select></td>'+
    '<td><input type="number" class="prog-count" min="10" step="10" value="100"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  updateTopicOptions(tr.querySelector(".prog-subject"),"prog-topic");
}

/* ===== ุชูุงุจุน ุขุฒููู ุดุฎุตุช (DB) ===== */
function daysBetween(date1, date2){
  try{
    var d1 = new Date(date1);
    var d2 = new Date(date2);
    var diff = d2.getTime() - d1.getTime();
    return Math.floor(diff / (1000*60*60*24));
  }catch(e){
    return 9999;
  }
}
var _introLoaded = false;
window._introDone = false;
var _profileCache = null;

async function loadIntroAndPersonality(email){
  currentPersonalityType = null;
  currentPersonalityUpdated = null;
  computedPersonalityType = null;
  _introLoaded = false;
  window._introDone = false;
  _profileCache = null;

  var res = await supabase
    .from("student_profile")
    .select("*")
    .eq("email", email)
    .limit(1)
    .single()
    .catch(()=>({error:null,data:null}));

  if(res && !res.error && res.data){
    _profileCache = res.data;
    currentPersonalityType = res.data.personality_type || null;
    currentPersonalityUpdated = res.data.personality_updated || null;
    window._introDone = !!res.data.intro_done;
    _introLoaded = true;

    fillIntroFormFromProfile(res.data);
    fillBasicFieldsFromProfile();
  }else{
    _introLoaded = true;
    window._introDone = false;
  }

  updatePersonalityUI();
}

// ูููโุจูุฏู ุชุณุช ุดุฎุตุช
function canShowPersonalityTab(){
  if(!currentPersonalityUpdated) return true;
  var today = new Date().toISOString().slice(0,10);
  var diff = daysBetween(currentPersonalityUpdated, today);
  return diff >= 60;
}
function updatePersonalityUI(){
  var info = document.getElementById("personalityInfo");
  var saveBtn = document.getElementById("savePersonalityBtn");
  var calcBtn = document.getElementById("computePersonalityBtn"); // ุงฺฏุฑ ุฏฺฉูู ูุญุงุณุจู ุฏุงุฑ

  if(!currentPersonalityType){
    info.innerHTML =
      "ูููุฒ ุชูพ ุดุฎุตุช ูุทุงูุนู ุจุฑุงุช ุซุจุช ูุดุฏู ุงุณุช. "+
      "ูุทูุงู ุขุฒููู ุฑุง ฺฉโุจุงุฑ ฺฉุงูู ูพุงุณุฎ ุจุฏู ู ูุชุฌู ุฑุง ุฐุฎุฑู ฺฉู. "+
      "<br>ุจุนุฏ ุงุฒ ุซุจุชุ ุงฺฏุฑ ุฏุฑ ุณุงุฎุช ุจุฑูุงูู ยซุจุฑ ุงุณุงุณ ุชูพ ุดุฎุตุชยป ุฑุง ุงูุชุฎุงุจ ฺฉูุ ุฑู ุงูฺฏูุฑุชู ู ุธุงูุฑ ุงูพ ุงุนูุงู ูโุดูุฏ.";
    if(saveBtn) saveBtn.disabled = true;
    if(calcBtn) calcBtn.disabled = false;
    applyPersonalityTheme("steady");
    return;
  }

  var label = PERSONALITY_LABELS[currentPersonalityType] || currentPersonalityType;
  var txt = "ุชูพ ุซุจุชโุดุฏูโ ูุนู ุดูุง: <b>"+label+"</b>";
  var canRetake = true;

  if(currentPersonalityUpdated){
    txt += " (ุชุงุฑุฎ ุซุจุช: "+currentPersonalityUpdated+")";
    var today = new Date().toISOString().slice(0,10);
    var diff = daysBetween(currentPersonalityUpdated, today);
    if(diff < 60){
      txt += "<br><span style='color:#b30000'>ูุนูุงู ุงูฺฉุงู ุขุฒููู ุฏูุจุงุฑู ูุฌูุฏ ูุฏุงุฑุฏ. "+(60-diff)+" ุฑูุฒ ุฏฺฏุฑ ูโุชูุงู ุฏูุจุงุฑู ุชูพ ุฑุง ุจุณูุฌ.</span>";
      canRetake = false;
    }else{
      txt += "<br>ุฏุฑ ุตูุฑุช ูุงุฒ ูโุชูุงู ุฏูุจุงุฑู ุขุฒููู ุจุฏู ู ุชูพ ุฌุฏุฏ ุซุจุช ฺฉู.";
    }
  }
  info.innerHTML = txt;

  if(calcBtn) calcBtn.disabled = !canRetake;
  if(!canRetake && saveBtn) saveBtn.disabled = true;

  applyPersonalityTheme(currentPersonalityType);
}
function fillIntroFormFromProfile(p){
  // ุงฺฏุฑ ูุจูุงู ูุนุงุฑูู ุงูุฌุงู ุดุฏูุ ูุฑู ุฑุง readonly ฺฉู ู ุฏฺฉูู skip ุฑุง ูุฎู
  if(!p) return;
  document.getElementById("introFname").value  = p.fname || "";
  document.getElementById("introLname").value  = p.lname || "";
  document.getElementById("introPhone").value  = p.phone || "";
  document.getElementById("introCity").value   = p.city || "";
  document.getElementById("introSchool").value = p.school || "";
  document.getElementById("introGrade").value  = p.grade || "";
  document.getElementById("introMajor").value  = p.major || "";
  document.getElementById("introGoalRank").value = p.goal_rank_band || "";
  document.getElementById("introGoalField").value= p.goal_field || "";
  document.getElementById("introMockSystem").value = p.mock_system || "none";
  document.getElementById("introMockAvgTotal").value = p.mock_avg_total || "";
  document.getElementById("introMockBio").value  = p.mock_avg_bio || "";
  document.getElementById("introMockChem").value = p.mock_avg_chem || "";
  document.getElementById("introMockPhys").value = p.mock_avg_phys || "";
  document.getElementById("introMockMath").value = p.mock_avg_math || "";

  var gradeSel = document.getElementById("introGrade").value;
  document.getElementById("introMockCard").style.display =
    (gradeSel === "11" || gradeSel === "12") ? "block" : "none";

  // ุงฺฏุฑ ูุจูุงู intro_done=trueุ ููุท ููุงุด ู ูพุดููุงุฏุ ูู ูุงุจู ูุฑุงุด
  if(p.intro_done){
    window._introDone = true;
    ["introFname","introLname","introPhone","introCity","introSchool",
     "introGrade","introMajor","introGoalRank","introGoalField",
     "introMockSystem","introMockAvgTotal","introMockBio","introMockChem",
     "introMockPhys","introMockMath"].forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.disabled = true;
    });
    var skipBtn = document.querySelector('button[onclick="skipIntro()"]');
    if(skipBtn) skipBtn.style.display = "none";
  }

  // ุชููุฏ ูุชู ูพุดููุงุฏ
  buildIntroAdviceText();
}

function skipIntro(){
  // ููุท ุชุจ ุนูุถ ูโฺฉููุ ุฏุฑ ุฏุชุงุจุณ ฺุฒ ุซุจุช ููโุดูุฏ
  showTab( canShowPersonalityTab() ? "personalityTab" : "plannerTab" );
}

async function saveIntro(){
  var st = document.getElementById("introStatus");
  st.style.color = "#b30000";
  st.textContent = "";

  var fname = document.getElementById("introFname").value.trim();
  var lname = document.getElementById("introLname").value.trim();
  var phone = document.getElementById("introPhone").value.trim();
  var city  = document.getElementById("introCity").value.trim();
  var school= document.getElementById("introSchool").value.trim();
  var grade = document.getElementById("introGrade").value;
  var major = document.getElementById("introMajor").value;
  var goalRank = document.getElementById("introGoalRank").value;
  var goalField= document.getElementById("introGoalField").value.trim();
  var mockSys  = document.getElementById("introMockSystem").value;
  var mockAvg  = parseInt(document.getElementById("introMockAvgTotal").value||"0",10)||0;
  var mbio  = parseInt(document.getElementById("introMockBio").value||"0",10)||0;
  var mchem = parseInt(document.getElementById("introMockChem").value||"0",10)||0;
  var mphys = parseInt(document.getElementById("introMockPhys").value||"0",10)||0;
  var mmath = parseInt(document.getElementById("introMockMath").value||"0",10)||0;

  if(!fname || !lname || !phone || !city || !school || !grade || !major || !goalRank){
    st.textContent = "ูููโ ููุฏูุง ุถุฑูุฑ ุฑุง ฺฉุงูู ูพุฑ ฺฉู.";
    return;
  }
  var reg=/^09\d{9}$/;
  if(!reg.test(phone)){
    st.textContent="ุดูุงุฑู ููุจุงู ุจุงุฏ ุจุง 09 ุดุฑูุน ุดูุฏ ู ุฏููุงู 11 ุฑูู ุจุงุดุฏ.";
    return;
  }

  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    st.textContent="ุงุจุชุฏุง ูุงฺฏู ฺฉู.";
    return;
  }
  var email = userRes.data.user.email;
  var today = new Date().toISOString().slice(0,10);

  var upRes = await supabase
    .from("student_profile")
    .upsert({
      email: email,
      fname: fname,
      lname: lname,
      phone: phone,
      city: city,
      school: school,
      grade: grade,
      major: major,
      intro_done: true,
      intro_created_at: today,
      goal_rank_band: goalRank,
      goal_field: goalField,
      mock_system: mockSys,
      mock_avg_total: mockAvg,
      mock_avg_bio: mbio,
      mock_avg_chem: mchem,
      mock_avg_phys: mphys,
      mock_avg_math: mmath
    });

  if(upRes.error){
    console.log(upRes.error);
    st.textContent = "ุฎุทุง ุฏุฑ ุฐุฎุฑู ูุนุงุฑูู.";
    return;
  }

  window._introDone = true;
  st.style.color = "green";
  st.textContent = "ูุนุงุฑูู ุซุจุช ุดุฏ โ";

  // ุจุนุฏ ุงุฒ ูุนุงุฑูู: ุชุจ ูุนุงุฑูู ุฑุง ูุฎู ู ุจุฑู ุณุฑุงุบ ุชุณุช ุดุฎุตุช ุง ุจุฑูุงูู
  document.getElementById("introTabBtn").style.display = "none";
  if(canShowPersonalityTab()){
    showTab("personalityTab");
  }else{
    showTab("plannerTab");
  }
}
function classifyStudentFromMock(mockSys, mockAvg){
  if(mockSys === "maz"){
    if(mockAvg >= 11000) return "very_good";
    if(mockAvg >= 10000) return "good";
    if(mockAvg >= 9500)  return "medium";
    return "weak";
  }else if(mockSys === "ghalamchi"){
    if(mockAvg >= 7000) return "very_good";
    if(mockAvg >= 6500) return "good";
    if(mockAvg >= 6000) return "medium";
    return "weak";
  }
  return null; // ููุช ุขุฒููู ูุฑูุชู
}

function buildIntroAdviceText(){
  var box = document.getElementById("introAdviceBox");
  if(!box) return;

  var goalRank = document.getElementById("introGoalRank").value;
  var mockSys  = document.getElementById("introMockSystem").value;
  var mockAvg  = parseInt(document.getElementById("introMockAvgTotal").value||"0",10)||0;
  var grade    = document.getElementById("introGrade").value;

  var levelFromGoal = goalRank || "medium";
  var levelFromMock = classifyStudentFromMock(mockSys, mockAvg);
  var finalLevel = levelFromMock || levelFromGoal;

  var parts = [];

  // ุชูุถุญ ุณุทุญ
  if(finalLevel === "very_good"){
    parts.push("โ ุจุฑ ุงุณุงุณ ูุฏู ู ุชุฑุงุฒูุงุ ูุนูุงู ุฏุฑ ุณุทุญ ยซุฏุงูุดโุขููุฒ ุฎู ุฎูุจยป ูุฑุงุฑ ูโฺฏุฑ.");
  }else if(finalLevel === "good"){
    parts.push("โ ุจุฑ ุงุณุงุณ ูุฏู ู ุชุฑุงุฒูุงุ ูุนูุงู ุฏุฑ ุณุทุญ ยซุฏุงูุดโุขููุฒ ุฎูุจยป ูุณุช.");
  }else if(finalLevel === "medium"){
    parts.push("โ ุจุฑ ุงุณุงุณ ูุฏู ู ุชุฑุงุฒูุงุ ุฏุฑ ุณุทุญ ยซุฏุงูุดโุขููุฒ ูุชูุณุทยป ูุณุช.");
  }else{
    parts.push("โ ูุนูุงู ุฏุฑ ุณุทุญ ยซูุงุฒููุฏ ุชููุชยป ูุญุณูุจ ูโุดูุ ูู ุจุง ุจุฑูุงููโุฑุฒ ุฏุฑุณุช ูโุดูุฏ ุฌูุด ุงุฌุงุฏ ฺฉุฑุฏ.");
  }

  // ูพุดููุงุฏ ููุจุน ุชุณุช ุจุฑ ุงุณุงุณ ุณุทุญ
  if(finalLevel === "weak"){
    parts.push("๐ ุจุฑุง ุดุฑูุนุ ูพุดููุงุฏ ููุจุน ุชุณุช ุณุงุฏู: ยซุฎู ุณุจุฒยป ู ยซูุดุฑ ุงูฺฏูยป ุงุณุช. ฺฉ ุงุฒ ุงูโูุง ุฑุง ุจุฑุง ูุฑ ุฏุฑุณ ุงุตู ุงูุชุฎุงุจ ฺฉู.");
  }else if(finalLevel === "medium"){
    parts.push("๐ ุจุฑุง ุณุทุญ ูุชูุณุท: ุญุชูุงู ฺฉ ุงุฒ ููุงุจุน ุณุงุฏู (ุฎู ุณุจุฒ / ูุดุฑ ุงูฺฏู) ุฑุง ุฏุงุดุชู ุจุงุด ู ุฏุฑ ุตูุฑุช ุฏุงุดุชู ููุชุ ุงุฒ ููุงุจุน ูุชูุณุท ูุซู ยซูฺฉุฑู ฺฏุงุฌยป ุง ยซQB ูุจุชฺฉุฑุงูยป ุงุณุชูุงุฏู ฺฉู.");
  }else if(finalLevel === "good"){
    parts.push("๐ ุจุฑุง ุณุทุญ ุฎูุจ: ุฏุฑ ฺฉูุงุฑ ฺฉ ููุจุน ุณุงุฏูุ ฺฉ ููุจุน ุณุทุญ ุจุงูุงุชุฑ ูุซู ยซูุฑุฏุจุงูยป ุง ยซุชุชุงูููยป ูู ุฏุงุดุชู ุจุงุด ุชุง ุฑู ุชุณุชโูุง ุณุฎุชโุชุฑ ูู ูุณูุท ุดู.");
  }else if(finalLevel === "very_good"){
    parts.push("๐ ุจุฑุง ุณุทุญ ุฎู ุฎูุจ: ุชุฑฺฉุจ ุณู ูุงู ููุจุน (ุณุงุฏู + ูุชูุณุท + ุณุฎุช) ูพุดููุงุฏ ูโุดูุฏุ ูุซู: ุฎู ุณุจุฒ / ูุดุฑ ุงูฺฏู + ูฺฉุฑู ุง QB + ูุฑุฏุจุงู ุง ุชุชุงููู.");
  }

  // ุชูุถุญ ุงุณุงุชุฏ (ุณุทุญโุจูุฏ ฺฉู โ ุฎูุฏุช ุจุนุฏุงู ุงุณุงู ูุงูุน ุฑุง ุฌุงฺฏุฐุงุฑ ูโฺฉู)
  parts.push("๐ง ุฏุฑุจุงุฑูโ ฺฉูุงุณ ู ุงุณุชุงุฏ: ุงฺฏุฑ ุฏุฑ ุฏุฑุณ ูุฏูุช ุจุงูุงุชุฑ ุงุฒ ูุชุฌูโ ูุนูโุงุช ุงุณุชุ ุจูุชุฑ ุงุณุช ุณุฑุงุบ ุงุณุชุงุฏ ุจุง ุณุทุญ ุจุงูุงุชุฑ (ุฏูุฑูโูุง ูพุดุฑูุชูโุชุฑ ู ุชุณุชโูุญูุฑุชุฑ) ุจุฑู. ุงฺฏุฑ ูุฏูุช ุจุง ูุชุฌูโุงุช ููุงููฺฏ ุงุณุชุ ูุนูุงู ูุงุฒ ุจู ุชุนูุถ ุงุณุชุงุฏ ูุณุช.");

  // ุชูุถุญ ุฑูู ฺฉู
  parts.push("โน๏ธ ุงูโูุง ููุท ูพุดููุงุฏ ูุณุชูุฏ ู ุงูุชุฎุงุจ ููุง ุจุง ุฎูุฏุช ุงุณุช. ูุฑ ฺุฒ ฺฉู ูุงูุนุงู ุงุณุชูุงุฏู ฺฉูุ ุฏุฑ ูุฑู ุณุงุฎุช ุจุฑูุงูู (ฺฉุงุฑุช ุขุฒูููุ ุนูุจโูุงูุฏฺฏ ู ...) ูุงุฑุฏ ูโฺฉู ู ุงูฺฏูุฑุชู ุฑู ููุงู ุงุฌุฑุง ูโุดูุฏ.");

  box.value = parts.join("\n\n");
}
function computePersonality(){
  var scores = {obsessive:0, runner:0, steady:0, lastminute:0};
  for(var q=1;q<=16;q++){
    var name = "q"+q;
    var radios = document.getElementsByName(name);
    var val = null;
    for(var i=0;i<radios.length;i++){
      if(radios[i].checked){ val = parseInt(radios[i].value,10); break; }
    }
    if(!val){
      alert("ูุทูุงู ุจู ูููโ ุณุคุงูุงุช ูพุงุณุฎ ุจุฏู. ุณุคุงู "+q+" ุฎุงู ุงุณุช.");
      return;
    }
    var cfg = personalityConfig[name];
    if(!cfg) continue;
    var baseScore = val-1; // 0 ุชุง 4
    for(var key in cfg){
      scores[key] += baseScore * cfg[key];
    }
  }
  var bestType = null;
  var bestScore = -9999;
  for(var t in scores){
    if(scores[t] > bestScore){
      bestScore = scores[t];
      bestType = t;
    }
  }
  computedPersonalityType = bestType;
  var label = PERSONALITY_LABELS[bestType] || bestType;
  var desc  = PERSONALITY_DESCRIPTIONS[bestType] || "";
  var resDiv = document.getElementById("personalityResult");
  resDiv.innerHTML =
    "ุชูพ ูพุดููุงุฏ ุดูุง: <b>"+label+"</b><br>"+desc+
    "<br><span style='font-size:11px;color:#666'>ุจุฑุง ุงุนูุงู ุงู ุชูพ ุฏุฑ ุจุฑูุงููโุฑุฒ ู ุชู ุธุงูุฑ ุงูพุ ุฑู ยซุซุจุช ุชูพ ุฏุฑ ุญุณุงุจ ููยป ุจุฒู.</span>";
  document.getElementById("savePersonalityBtn").disabled = false;
}
async function savePersonality(){
  if(!computedPersonalityType){
    alert("ุงูู ุชูพ ุฎูุฏุช ุฑุง ุจุง ุฒุฏู ยซูุญุงุณุจู ุชูพยป ุจูโุฏุณุช ุจุงูุฑ.");
    return;
  }
  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    alert("ุงุจุชุฏุง ูุงุฑุฏ ุญุณุงุจ ฺฉุงุฑุจุฑ ุดู.");
    return;
  }
  var email = userRes.data.user.email;
  var today = new Date().toISOString().slice(0,10);
  if(currentPersonalityUpdated){
    var diff = daysBetween(currentPersonalityUpdated, today);
    if(diff < 60){
      alert("ูุนูุงู ฺฉูุชุฑ ุงุฒ ถฐ ุฑูุฒ ุงุฒ ุขุฎุฑู ุซุจุช ุชูพ ฺฏุฐุดุชู. ุจุนุฏุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู.");
      return;
    }
  }
  var upRes = await supabase
    .from("student_profile")
    .upsert({
      email: email,
      personality_type: computedPersonalityType,
      personality_updated: today
    });
  if(upRes.error){
    alert("ุฎุทุง ุฏุฑ ุฐุฎุฑู ุชูพ: "+upRes.error.message);
    console.log(upRes.error);
    return;
  }
  currentPersonalityType = computedPersonalityType;
  currentPersonalityUpdated = today;
  updatePersonalityUI();
  alert("ุชูพ ุดุฎุตุชุช ุฐุฎุฑู ุดุฏ.");
}

/* ===== ุนูุจโูุงูุฏฺฏ ุงุฒ ุจุฑูุงููโูุง ูุจู ===== */
function parseHoursFromText(txt){
  var m = txt.match(/ูุฏุช:\s*([\d\.]+)\s*ุณุงุนุช/);
  if(m) return parseFloat(m[1])||1.5;
  var m2 = txt.match(/(\d+)\s*ุฏููู/);
  if(m2){
    var min = parseInt(m2[1],10)||0;
    return min/60;
  }
  return 1.5;
}
function appendOfflineBacklogRow(subject, topic, hours){
  var tbody=document.getElementById("offlineBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="off-subject" onchange="updateTopicOptions(this, \'off-topic\')">'+
      '<option'+(subject==="ุฒุณุช"?' selected':'')+'>ุฒุณุช</option>'+
      '<option'+(subject==="ุดู"?' selected':'')+'>ุดู</option>'+
      '<option'+(subject==="ูุฒฺฉ"?' selected':'')+'>ูุฒฺฉ</option>'+
      '<option'+(subject==="ุฑุงุถ"?' selected':'')+'>ุฑุงุถ</option>'+
      '<option'+(subject==="ุงุฏุจุงุช"?' selected':'')+'>ุงุฏุจุงุช</option>'+
      '<option'+(subject==="ุฏู"?' selected':'')+'>ุฏู</option>'+
      '<option'+(subject==="ุนุฑุจ"?' selected':'')+'>ุนุฑุจ</option>'+
      '<option'+(subject==="ุฒุจุงู"?' selected':'')+'>ุฒุจุงู</option>'+
    '</select></td>'+
    '<td><select class="off-topic"></select></td>'+
    '<td><input type="number" step="0.5" class="off-hours" value="'+(hours||1.5)+'"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  var subjSel=tr.querySelector(".off-subject");
  updateTopicOptions(subjSel,"off-topic");
  if(topic){
    var topicSel=tr.querySelector(".off-topic");
    var found=false;
    for(var i=0;i<topicSel.options.length;i++){
      if(topicSel.options[i].value===topic){found=true;break;}
    }
    if(found) topicSel.value=topic;
  }
}
function appendLagBacklogRow(subject, topic, resource, count){
  var tbody=document.getElementById("lagBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="lag-subject" onchange="updateTopicOptions(this, \'lag-topic\')">'+
      '<option'+(subject==="ุฒุณุช"?' selected':'')+'>ุฒุณุช</option>'+
      '<option'+(subject==="ุดู"?' selected':'')+'>ุดู</option>'+
      '<option'+(subject==="ูุฒฺฉ"?' selected':'')+'>ูุฒฺฉ</option>'+
      '<option'+(subject==="ุฑุงุถ"?' selected':'')+'>ุฑุงุถ</option>'+
    '</select></td>'+
    '<td><select class="lag-topic"></select></td>'+
    '<td><select class="lag-source">'+
      ['ุฎู ุณุจุฒ','ูุฑุฏุจุงู','ูุจุชฺฉุฑุงู','ูุดุฑุงูฺฏู','ุณู ุณุทุญ','QB','ููุฌ ุขุฒููู','ูุตู ุขุฒููู','IQ','ูฺฉุฑู ฺฏุงุฌ','ุชุชุงููู']
        .map(function(src){
          return '<option'+(src===resource?' selected':'')+'>'+src+'</option>';
        }).join("")+
    '</select></td>'+
    '<td><input type="number" class="lag-count" min="10" step="10" value="'+(count||80)+'"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  var subjSel=tr.querySelector(".lag-subject");
  updateTopicOptions(subjSel,"lag-topic");
  if(topic){
    var topicSel=tr.querySelector(".lag-topic");
    var found=false;
    for(var i=0;i<topicSel.options.length;i++){
      if(topicSel.options[i].value===topic){found=true;break;}
    }
    if(found) topicSel.value=topic;
  }
}
async function prefillBacklogFromAllPlans(){
  if(backlogPrefilled) return;
  backlogPrefilled = true;
  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user) return;
  var user = userRes.data.user;
  var pRes = await supabase
    .from("plans")
    .select("id,program_date")
    .eq("email", user.email)
    .order("program_date", { ascending:true });
  if(pRes.error || !pRes.data) return;
  var plans=pRes.data;
  if(!plans.length) return;
  var today = new Date();
  today.setHours(0,0,0,0);

  for(var pi=0;pi<plans.length;pi++){
    var p=plans[pi];
    var labels=getDateLabelsFromProgramDate(p.program_date);
    var tRes=await supabase
      .from("task_status")
      .select("id,day,task_text,status,leftover,done")
      .eq("plan_id", p.id);
    if(tRes.error || !tRes.data) continue;
    var tasks=tRes.data;
    for(var ti=0;ti<tasks.length;ti++){
      var t=tasks[ti];
      var dayIndex=t.day-1;
      if(dayIndex<0 || dayIndex>=14) continue;
      var dLabel=labels[dayIndex];
      if(!dLabel) continue;
      var datePart=dLabel.split(" ")[1];
      var parts=datePart.split("/");
      var yy=parseInt(parts[0],10);
      var mm=parseInt(parts[1],10)-1;
      var dd=parseInt(parts[2],10);
      var dateObj=new Date(yy,mm,dd);
      dateObj.setHours(0,0,0,0);
      if(dateObj>=today) continue;
      var st = t.status || (t.done?TASK_STATUS.DONE:TASK_STATUS.TODO);
      if(st===TASK_STATUS.DONE) continue;

      var leftoverVal = t.leftover || 0;
      var txt=t.task_text || "";

      if(txt.indexOf("ููู ุขููุงู")>-1 || txt.indexOf("ฺฉูุงุณ ุขููุงู")>-1){
        var subMatch = txt.match(/(ููู ุขููุงู|ฺฉูุงุณ ุขููุงู)\s+(\S+)/);
        var subject = subMatch ? subMatch[2] : "ุฒุณุช";
        var topic = "";
        var dashIndex = txt.indexOf("โ");
        if(dashIndex>-1){
          var subStr = txt.substring(dashIndex+1);
          var idxMed = subStr.indexOf("ูุฏุช:");
          if(idxMed>-1) subStr = subStr.substring(0,idxMed);
          topic = subStr.trim();
        }
        var hours;
        if(st===TASK_STATUS.PARTIAL && leftoverVal>0){
          hours = leftoverVal;
        }else{
          hours = parseHoursFromText(txt);
        }
        appendOfflineBacklogRow(subject,topic,hours);
        continue;
      }

      if(txt.indexOf("ุชุณุช")>-1 || txt.indexOf("ูุทุงูุนู")>-1){
        var subjMatch = txt.match(/(ุชุณุช|ูุทุงูุนู)\s+(\S+)/);
        var subject2 = subjMatch ? subjMatch[2] : "ุฒุณุช";
        var resMatch = txt.match(/ููุจุน:\s*([^\s]+)/);
        var resource = resMatch ? resMatch[1] : "ุฎู ุณุจุฒ";
        var count;
        if(st===TASK_STATUS.PARTIAL && leftoverVal>0){
          count = Math.round(leftoverVal);
        }else{
          var countMatch = txt.match(/ุญุฏูุฏ\s+(\d+)\s+ุชุณุช/);
          if(countMatch){
            count = parseInt(countMatch[1],10)||0;
          }else{
            var h = parseHoursFromText(txt);
            var perMin=SOURCE_MIN_PER_QUESTION[resource]||2.0;
            count = Math.round((h*60)/perMin);
          }
        }
        if(count>0){
          var topic2="";
          var dash2 = txt.indexOf("โ");
          if(dash2>-1){
            var sub2 = txt.substring(dash2+1);
            var idxRes = sub2.indexOf("ููุจุน:");
            if(idxRes>-1) sub2=sub2.substring(0,idxRes);
            var idxHor = sub2.indexOf("ุญุฏูุฏ");
            if(idxHor>-1) sub2=sub2.substring(0,idxHor);
            topic2=sub2.trim();
          }
          appendLagBacklogRow(subject2,topic2,resource,count);
        }
      }
    }
  }
}

/* ===== ุฌูุนโุขูุฑ ุฏุงุฏู ุจุฑูุงูู ฑดุฑูุฒู ===== */
function collectStudentDataFromForm(){
  var fname=document.getElementById("fname").value.trim();
  var lname=document.getElementById("lname").value.trim();
  var phone=document.getElementById("phone").value.trim();
  var city=document.getElementById("city").value.trim();
  var school=document.getElementById("school").value.trim();
  var grade=document.getElementById("grade").value;
  var major=document.getElementById("major").value;
  var whiteDay=parseFloat(document.getElementById("whiteDay").value)||0;
  var schoolDay=parseFloat(document.getElementById("schoolDay").value)||0;

  var attendance=[];
  var attSel=document.querySelectorAll(".att-select");
  for(var i=0;i<attSel.length;i++){
    var sel=attSel[i];
    attendance.push({
      day:parseInt(sel.getAttribute("data-day"),10),
      goesToSchool:sel.value
    });
  }

  var classes=[];
  var clsRows=document.querySelectorAll("#classesBody tr");
  for(var c=0;c<clsRows.length;c++){
    var tr=clsRows[c];
    var d=parseInt(tr.querySelector(".class-day").value||"0",10);
    if(!d) continue;
    classes.push({
      day:d,
      subject:tr.querySelector(".class-subject").value,
      duration:parseFloat(tr.querySelector(".class-duration").value)||0,
      topic:tr.querySelector(".class-topic").value
    });
  }

  var exams=[];
  var cards=document.querySelectorAll(".exam-card");
  for(var i2=0;i2<cards.length;i2++){
    var card=cards[i2];
    var day=parseInt(card.querySelector(".exam-day").value||"0",10);
    if(!day) continue;
    var subject=card.querySelector(".exam-subject").value;
    var type=card.querySelector(".exam-type").value;
    var duration=card.querySelector(".exam-duration").value;
    var needsAnalysis = card.querySelector(".exam-analysis-need").checked;
    var analysisStartDay = parseInt(card.querySelector(".exam-analysis-start").value||"0",10);
    var allowExamDayStudy = card.querySelector(".exam-allow-today").checked;

    var topics=[];
    var tSel=card.querySelectorAll(".exam-chapter");
    for(var j=0;j<tSel.length;j++){
      topics.push(tSel[j].value);
    }
    if(!topics.length) topics=["ูุตู ูุงูุดุฎุต"];

    var resources=[];
    var srcSel=card.querySelectorAll(".exam-source");
    var cntSel=card.querySelectorAll(".exam-count");
    for(j=0;j<srcSel.length;j++){
      var cnum=parseInt(cntSel[j].value||"0",10);
      if(cnum>0){
        resources.push({name:srcSel[j].value,count:cnum});
      }
    }
    if(!resources.length) continue;

    exams.push({
      day:day,
      subject:subject,
      type:type,
      duration:duration,
      topics:topics,
      resources:resources,
      needsAnalysis:needsAnalysis,
      analysisStartDay:analysisStartDay,
      allowExamDayStudy:allowExamDayStudy
    });
  }

  var offlineVideos=[];
  var offRows=document.querySelectorAll("#offlineBody tr");
  for(var o=0;o<offRows.length;o++){
    var tro=offRows[o];
    var subjectO=tro.querySelector(".off-subject").value;
    var topicO=tro.querySelector(".off-topic").value;
    var hours=parseFloat(tro.querySelector(".off-hours").value)||0;
    if(hours>0) offlineVideos.push({subject:subjectO,topic:topicO,hours:hours});
  }

  var backlogTests=[];
  var lagRows=document.querySelectorAll("#lagBody tr");
  for(var l=0;l<lagRows.length;l++){
    var trl=lagRows[l];
    var subjectL=trl.querySelector(".lag-subject").value;
    var topicL=trl.querySelector(".lag-topic").value;
    var sourceL=trl.querySelector(".lag-source").value;
    var countL=parseInt(trl.querySelector(".lag-count").value||"0",10);
    if(countL>0) backlogTests.push({subject:subjectL,topic:topicL,resource:sourceL,count:countL});
  }

  var progressTargets=[];
  var progRows=document.querySelectorAll("#progBody tr");
  for(var p=0;p<progRows.length;p++){
    var trp=progRows[p];
    var subjectP=trp.querySelector(".prog-subject").value;
    var topicP=trp.querySelector(".prog-topic").value;
    var sourceP=trp.querySelector(".prog-source").value;
    var countP=parseInt(trp.querySelector(".prog-count").value||"0",10);
    if(countP>0) progressTargets.push({subject:subjectP,topic:topicP,resource:sourceP,count:countP});
  }

  var stats={
    biology:{avgRank:parseInt(document.getElementById("rankBio").value||"0",10)||0},
    chemistry:{avgRank:parseInt(document.getElementById("rankChem").value||"0",10)||0},
    physics:{avgRank:parseInt(document.getElementById("rankPhys").value||"0",10)||0},
    math:{avgRank:parseInt(document.getElementById("rankMath").value||"0",10)||0}
  };

  return {
    fname:fname,lname:lname,phone:phone,city:city,school:school,grade:grade,major:major,
    whiteDay:whiteDay,schoolDay:schoolDay,
    attendance:attendance,classes:classes,exams:exams,
    offlineVideos:offlineVideos,backlogTests:backlogTests,progressTargets:progressTargets,
    stats:stats
  };
}

/* ===== ุงูฺฏูุฑุชู ุณุงุฎุช ุจุฑูุงูู ฑดุฑูุฒู (ูุซู ูุจู) ===== */
/* (ุงู ูุณูุช ููุงู ุงูฺฏูุฑุชู ุงุณุช ฺฉู ุฏุงุดุชุ ููุท ุงุณู ุจุฑูุงูู ู ุชุงุฑุฎ ูุงูุน ุฑุง ุญูุธ ฺฉุฑุฏูโุงู)
   ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุทูู ุจุด ุงุฒ ุญุฏ ูพุงูุ ุณุงุฎุชุงุฑ ููุงู ุงุณุช ฺฉู ุฎูุฏุช ุฏุงุดุช:
   - ูุญุงุณุจู dayFree
   - ุนูููโูุง
   - ุนูุจโูุงูุฏฺฏ
   - ุขุฒููู
   - ุชุญูู
   - ูพุดุฑู
   - ุชููุฏ result.plan ู result.html
   ุฏููุง ููุงู ฺฉุฏ ูุจูโุงุช ุฑุง ุงูุฌุง ุจฺฏุฐุงุฑ (ุงฺฏุฑ ูุงุฒู ุดุฏ ุฏูุจุงุฑู ูพุณุชุด ฺฉู).
*/

/* ุจุฑุง ฺฉูุชุงู ฺฉุฑุฏูุ ูุฑุถ ูโฺฉูู ููู ุญุงูุง buildPlan ู onMakePlanClicked
   ู ุจูู ุชูุงุจุน student/admin/backlog ุฑุง ุฏููุงู ูุซู ูุณุฎูโุง ฺฉู ูุฑุณุชุงุฏ
   ูพุงู ููู ูุงู ูุฑุงุฑ ูโุฏู (ฺฉุฏ ฺฉุงูู ฺฉู ุฎูุฏุช ุฏุฑ ุฏู ุชฺฉู ุฏุงุฏ). */

/* ===== ุณุงุฎุช ู ุฐุฎุฑู ุจุฑูุงูู ฑดุฑูุฒู + ูพุฑูุช ===== */
async function onMakePlanClicked(){
  var status=document.getElementById("statusMsg");
  var coverageDiv=document.getElementById("coverageSummary");
  status.textContent="";
  coverageDiv.textContent="";

  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    alert("ุงูู ุจุงุฏ ูุงฺฏู ฺฉู.");
    return;
  }
  var user=userRes.data.user;

  var planMode = document.getElementById("planMode").value;

  if(planMode === "personality" && !currentPersonalityType){
    if(!confirm("ุชูพ ุดุฎุตุช ุซุจุชโุดุฏูโุง ุจุฑุง ุงู ุญุณุงุจ ูุฌูุฏ ูุฏุงุฑุฏ.\nุงฺฏุฑ ูโุฎูุงู ุชูพ ุฑู ุจุฑูุงูู ุงุซุฑ ุจฺฏุฐุงุฑุฏุ ุงูู ุงุฒ ุชุจ ยซุขุฒููู ุดุฎุตุชยป ุชูพ ุฑุง ุซุจุช ฺฉู.\nุงูุงู ุงฺฏุฑ ุงุฏุงูู ุฏูุ ูุซู ุญุงูุช ุนุงุฏ (steady) ุจุฑูุงูู ูโฺูู. ุงุฏุงูู ุจุฏููุ")){
      showTab("personalityTab");
      return;
    }
  }

  var s=collectStudentDataFromForm();
  if(!s.fname || !s.lname || !s.phone || !s.city || !s.school || !s.grade || !s.major){
    alert("ูุงูุ ูุงู ุฎุงููุงุฏฺฏุ ุดูุงุฑู ููุจุงูุ ุดูุฑุ ูุฏุฑุณูุ ูพุงู ู ุฑุดุชู ุญุชูุงู ุจุงุฏ ูพุฑ ุดููุฏ.");
    return;
  }
  var reg=/^09\d{9}$/;
  if(!reg.test(s.phone)){
    alert("ุดูุงุฑู ููุจุงู ุจุงุฏ ุจุง 09 ุดุฑูุน ุดูุฏ ู ุฏููุงู 11 ุฑูู ุจุงุดุฏ.");
    return;
  }

  var programDate=new Date().toISOString().slice(0,10);
  var dateLabels = getDateLabelsFromProgramDate(programDate);
  var result=buildPlan(s,dateLabels,planMode); // buildPlan ููุงู ุงูฺฏูุฑุชู ูุจูโ

  document.getElementById("scheduleTable").innerHTML=result.html;
  var examCov = (result.coverage.exam!=null? result.coverage.exam+"ูช":"โ");
  var backCov = (result.coverage.backlog!=null? result.coverage.backlog+"ูช":"โ");
  var progCov = (result.coverage.progress!=null? result.coverage.progress+"ูช":"โ");
  var anaCov  = (result.coverage.analysis!=null? result.coverage.analysis+"ูช":"โ");
  coverageDiv.textContent =
    "ูพูุดุด ุขุฒูููโูุง: "+examCov+
    " | ูพูุดุด ุนูุจโูุงูุฏฺฏ (ููู + ุชุณุช): "+backCov+
    " | ุงุณุชูุงุฏู ุงุฒ ุงูุฏุงู ูพุดุฑู: "+progCov+
    " | ูพูุดุด ุชุญูู ุขุฒูููโูุง: "+anaCov;

  status.style.color="#b30000";
  status.textContent="ุฏุฑ ุญุงู ุฐุฎุฑู ุจุฑูุงูู ุฏุฑ Supabase...";

  var insertRes=await supabase
    .from("plans")
    .insert({
      email:user.email,
      fname:s.fname,
      lname:s.lname,
      phone:s.phone,
      city:s.city,
      school:s.school,
      grade:s.grade,
      major:s.major,
      program_date:programDate,
      plan_type: planMode
    })
    .select()
    .single();
  if(insertRes.error){
    console.log(insertRes.error);
    status.textContent="โ ุฎุทุง ุฏุฑ ุฐุฎุฑู ุจุฑูุงูู: "+insertRes.error.message;
    return;
  }
  var planId=insertRes.data.id;
  var rows=[];
  for(var d=0;d<result.plan.length;d++){
    var dayTasks=result.plan[d];
    for(var i=0;i<dayTasks.length;i++){
      var txt=dayTasks[i].replace(/<br>/g," ").replace(/<\/?[^>]+(>|$)/g,"").trim();
      rows.push({
        plan_id:planId,
        day:d+1,
        task_text:txt,
        status:TASK_STATUS.TODO,
        leftover:0,
        done:false
      });
    }
  }
  if(rows.length){
    var tRes=await supabase.from("task_status").insert(rows);
    if(tRes.error){
      console.log(tRes.error);
      status.textContent="โ๏ธ ุจุฑูุงูู ุฐุฎุฑู ุดุฏ ุงูุง ุชุณฺฉโูุง ุฐุฎุฑู ูุดุฏูุฏ: "+tRes.error.message;
    }else{
      status.style.color="green";
      status.textContent="โ ุจุฑูุงูู ู ุชุณฺฉโูุง ุฐุฎุฑู ุดุฏูุฏ.";
    }
  }else{
    status.style.color="green";
    status.textContent="โ ุจุฑูุงูู ุฐุฎุฑู ุดุฏ (ุชุณฺฉ ุซุจุช ูุดุฏ).";
  }
  loadStudentPlans();
  loadBacklogView();
  var u = user.email;
  if(ADMIN_EMAILS.indexOf(u)>=0){
    loadAdminPlans();
  }
}

/* ุฎุฑูุฌ ูุงุจู ูพุฑูุช ุงุฒ ุฌุฏูู ุจุฑูุงูู ฑดุฑูุฒู */
function downloadPlanTable(){
  var table = document.getElementById("scheduleTable");
  if(!table || !table.innerHTML.trim()){
    alert("ุงูู ฺฉ ุจุฑูุงูู ุจุณุงุฒุ ุจุนุฏ ุฎุฑูุฌ ุจฺฏุฑ.");
    return;
  }
  var html = '<html><head><meta charset="UTF-8"><title>ุจุฑูุงูู ูุทุงูุนู</title></head><body>'+
             '<h2>ุจุฑูุงูู ูุทุงูุนู</h2>'+table.outerHTML+'</body></html>';
  var blob = new Blob([html], {type: "text/html;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "program.html";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ===== ุชูุงุจุน ุจุฑูุงููโูุง ูู / ุนูุจโูุงูุฏฺฏ / ุงุฏูู =====
   (ููุงู ุชูุงุจุน loadStudentPlansุ loadStudentTasksForPlanุ renderStudentTasksFilteredุ
    onTaskStatusChangeุ onLeftoverChangeุ showInstantReportุ loadBacklogViewุ
    loadAdminPlansุ loadAdminTasksุ adminAddTaskุ adminDeleteTask ฺฉู ุฎูุฏุช ุฏุงุดุช.
    ุขูโูุง ุฑุง ุจุฏูู ุชุบุฑ ููุทู ููู ูพุงู ุจฺุณุจุงู.)
*/

/* ===== ุงูฺฏูุฑุชู ุงูุชุญุงูุงุช ุฏโูุงู ===== */

/* ฺฉูฺฉโุชุงุจุน: ุณุงุฎุช ูุณุช ุฑูุฒูุง ุจุงุฒู */
function buildDeyDays(){
  var start = document.getElementById("deyStartDate").value;
  var end   = document.getElementById("deyEndDate").value;
  var status = document.getElementById("deyRangeStatus");
  var tbody = document.getElementById("deyDaysBody");
  tbody.innerHTML="";
  status.textContent="";
  if(!start || !end){
    status.textContent="ุชุงุฑุฎ ุดุฑูุน ู ูพุงุงู ุฑุง ูุงุฑุฏ ฺฉู.";
    return;
  }
  var ds = new Date(start);
  var de = new Date(end);
  if(isNaN(ds.getTime()) || isNaN(de.getTime()) || ds>de){
    status.textContent="ุจุงุฒู ุชุงุฑุฎ ูุนุชุจุฑ ูุณุช.";
    return;
  }
  var weekdays = ["ฺฉุดูุจู","ุฏูุดูุจู","ุณูโุดูุจู","ฺูโุดูุจู","ูพูุฌโุดูุจู","ุฌูุนู","ุดูุจู"];
  var idx=1;
  while(ds<=de){
    var yy = ds.getFullYear();
    var mm = (ds.getMonth()+1).toString().padStart(2,'0');
    var dd = ds.getDate().toString().padStart(2,'0');
    var iso = yy+"-"+mm+"-"+dd;
    var label = yy+"/"+mm+"/"+dd;
    var wd = weekdays[ds.getDay()];
    var tr = document.createElement("tr");
    tr.innerHTML =
      '<td style="text-align:center">'+idx+'</td>'+
      '<td>'+label+'</td>'+
      '<td>'+wd+'</td>'+
      '<td><select class="dey-gotoschool" data-date="'+iso+'">'+
        '<option value="ุจูู">ุจูู (ูุฏุฑุณู ูโุฑูุฏ)</option>'+
        '<option value="ุฎุฑ">ุฎุฑ</option>'+
      '</select></td>';
    tbody.appendChild(tr);
    ds.setDate(ds.getDate()+1);
    idx++;
  }
}

/* ุฑุฏูโูุง ฺฉูุงุณ ู ุงูุชุญุงู ู ูุณุชูุฑ ุฏโูุงู */
function addDeyClassRow(){
  var tbody = document.getElementById("deyClassesBody");
  var tr = document.createElement("tr");
  tr.innerHTML =
    '<td><input type="date" class="dey-class-date"></td>'+
    '<td><input type="text" class="dey-class-subject" placeholder="ูุซู ุฒุณุช"></td>'+
    '<td><input type="number" step="0.5" min="0" class="dey-class-hours" value="1.5"></td>'+
    '<td><input type="text" class="dey-class-desc" placeholder="ูุตู ุง ุชูุถุญ"></td>'+
    '<td><button class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
}
function addDeyExamRow(){
  var tbody = document.getElementById("deyExamsBody");
  var tr = document.createElement("tr");
  tr.innerHTML =
    '<td><input type="date" class="dey-exam-date"></td>'+
    '<td><input type="text" class="dey-exam-subject" placeholder="ูุซู ุนุฑุจ"></td>'+
    '<td><select class="dey-exam-type">'+
      '<option>ุงูุชุญุงู ูุฏุฑุณู</option>'+
      '<option>ุขุฒููู ูุงูโุชุฑู</option>'+
      '<option>ุขุฒููู ุขุฒูุงุด</option>'+
    '</select></td>'+
    '<td><input type="number" class="dey-exam-duration" min="20" step="10" value="90"></td>'+
    '<td><button class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
}
function addDeyHistoryRow(){
  var tbody = document.getElementById("deyHistoryBody");
  var tr = document.createElement("tr");
  tr.innerHTML =
    '<td><input type="text" class="dey-history-subject" placeholder="ูุซู ุฏู ุงุฒุฏูู"></td>'+
    '<td><input type="text" class="dey-history-chapter" placeholder="ูุซู ุฏุฑุณ ณ"></td>'+
    '<td><select class="dey-history-inbudget"><option value="ุจูู">ุจูู</option><option value="ุฎุฑ">ุฎุฑ</option></select></td>'+
    '<td style="text-align:center;"><input type="checkbox" class="dey-history-studied"></td>'+
    '<td style="text-align:center;"><input type="checkbox" class="dey-history-practiced"></td>'+
    '<td><input type="text" class="dey-history-test-resource" placeholder="ููุท ุจุฑุง ุงุฎุชุตุงุต (ุฎู ุณุจุฒ ู...)"></td>'+
    '<td><input type="number" class="dey-history-test-remaining" min="0" step="10" value="0"></td>'+
    '<td><button class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
}

/* ุฌูุนโุขูุฑ ุฏุงุฏู ุฏโูุงู */
function collectDeyData(){
  var fname=document.getElementById("fname").value.trim();
  var lname=document.getElementById("lname").value.trim();
  var phone=document.getElementById("phone").value.trim();
  var city=document.getElementById("city").value.trim();
  var school=document.getElementById("school").value.trim();
  var grade=document.getElementById("grade").value;
  var major=document.getElementById("major").value;
  var whiteDay=parseFloat(document.getElementById("deyWhiteDay").value)||0;
  var schoolDay=parseFloat(document.getElementById("deySchoolDay").value)||0;
  var start=document.getElementById("deyStartDate").value;
  var end=document.getElementById("deyEndDate").value;

  var days=[];
  var dayRows=document.querySelectorAll("#deyDaysBody tr");
  for(var i=0;i<dayRows.length;i++){
    var tds = dayRows[i].querySelectorAll("td");
    var dateLabel=tds[1].textContent.trim(); // yyyy/mm/dd
    var parts=dateLabel.split("/");
    var iso=parts[0]+"-"+parts[1]+"-"+parts[2];
    var sel=dayRows[i].querySelector(".dey-gotoschool");
    days.push({
      iso:iso,
      goesToSchool:sel.value
    });
  }

  var classes=[];
  var cRows=document.querySelectorAll("#deyClassesBody tr");
  for(i=0;i<cRows.length;i++){
    var r=cRows[i];
    var dt=r.querySelector(".dey-class-date").value;
    if(!dt) continue;
    classes.push({
      date:dt,
      subject:(r.querySelector(".dey-class-subject").value||"").trim(),
      hours:parseFloat(r.querySelector(".dey-class-hours").value)||0,
      desc:(r.querySelector(".dey-class-desc").value||"").trim()
    });
  }

  var exams=[];
  var eRows=document.querySelectorAll("#deyExamsBody tr");
  for(i=0;i<eRows.length;i++){
    var rr=eRows[i];
    var edt=rr.querySelector(".dey-exam-date").value;
    if(!edt) continue;
    exams.push({
      date:edt,
      subject:(rr.querySelector(".dey-exam-subject").value||"").trim(),
      type:rr.querySelector(".dey-exam-type").value,
      durationMin:parseInt(rr.querySelector(".dey-exam-duration").value||"0",10)||0
    });
  }

  var history=[];
  var hRows=document.querySelectorAll("#deyHistoryBody tr");
  for(i=0;i<hRows.length;i++){
    var hr=hRows[i];
    history.push({
      subject:(hr.querySelector(".dey-history-subject").value||"").trim(),
      chapter:(hr.querySelector(".dey-history-chapter").value||"").trim(),
      inBudget:hr.querySelector(".dey-history-inbudget").value==="ุจูู",
      studied:hr.querySelector(".dey-history-studied").checked,
      practiced:hr.querySelector(".dey-history-practiced").checked,
      testResource:(hr.querySelector(".dey-history-test-resource").value||"").trim(),
      testRemaining:parseInt(hr.querySelector(".dey-history-test-remaining").value||"0",10)||0
    });
  }

  return {
    basic:{fname,lname,phone,city,school,grade,major},
    range:{start,end},
    hours:{whiteDay,schoolDay},
    days:days,
    classes:classes,
    exams:exams,
    history:history
  };
}

/* ูุญุงุณุจู ุฏุฑุตุฏ ุงูุชุงุฒ ูุฑ ุฏุฑุณ ุงุฒ ูุณุชูุฑ */
function computeSubjectScoreMap(history){
  var map={}; // subject -> {score, possible}
  history.forEach(function(h){
    if(!h.inBudget) return;
    var subj = h.subject || "ูุงูุดุฎุต";
    if(!map[subj]) map[subj]={score:0,possible:0};
    map[subj].possible += 2; // ูุทุงูุนู + ุชูุฑู
    if(h.studied) map[subj].score += 1;
    if(h.practiced) map[subj].score += 1;
  });
  var percent={};
  for(var s in map){
    if(map[s].possible>0) percent[s] = (map[s].score*100)/map[s].possible;
    else percent[s]=0;
  }
  return percent;
}
function getSubjectCategory(subj){
  if(subj==="ุฒุจุงู" || subj==="ุงูฺฏูุณ" || subj==="ุนุฑุจ") return "lang";
  if(subj==="ุงุฏุจุงุช" || subj==="ูุงุฑุณ" || subj==="ุฏู") return "adab";
  if(subj==="ุฒุณุช" || subj==="ุฒุณุชโุดูุงุณ") return "bio";
  if(subj==="ุดู") return "chem";
  if(subj==="ูุฒฺฉ") return "phys";
  if(subj==="ุฑุงุถ") return "math";
  // ุฏุฑูุณ ุงุถุงูู ุจุฑ ุงุณุงุณ ูุชู
  if(subj.indexOf("ุฌุบุฑุงู")>-1 || subj.indexOf("ุชุงุฑุฎ")>-1 || subj.indexOf("ุฏูุงุน")>-1 ||
     subj.indexOf("ุฒูู")>-1 || subj.indexOf("ุณูุงูุช")>-1 || subj.indexOf("ููุช")>-1){
    return "extra";
  }
  return "other";
}

/* ุณุงุฎุช ุจุฑูุงูู ุฏโูุงู */
async function onMakeDeyPlan(){
  var status = document.getElementById("deyStatusMsg");
  var table  = document.getElementById("deyScheduleTable");
  status.textContent="";
  table.innerHTML="";

  var data = collectDeyData();
  var b = data.basic;
  if(!b.fname || !b.lname || !b.phone || !b.city || !b.school || !b.grade || !b.major){
    alert("ุจุฎุด ุงุทูุงุนุงุช ูพุงู (ูุงูุ ูุงู ุฎุงููุงุฏฺฏุ ุดูุงุฑูุ ุดูุฑุ ูุฏุฑุณูุ ูพุงูุ ุฑุดุชู) ุจุงุฏ ฺฉุงูู ุจุงุดุฏ.");
    return;
  }
  if(!data.range.start || !data.range.end){
    alert("ุชุงุฑุฎ ุดุฑูุน ู ูพุงุงู ุงูุชุญุงูุงุช ุฑุง ูุดุฎุต ฺฉู.");
    return;
  }
  if(!data.days.length){
    alert("ุงูู ุฏฺฉูู ยซุณุงุฎุช ุฌุฏูู ุฑูุฒูุงยป ุฑุง ุจุฒู ู ูุถุนุช ูุฏุฑุณู ุฑุง ุชูุธู ฺฉู.");
    return;
  }
  if(!data.exams.length){
    alert("ุญุฏุงูู ฺฉ ุงูุชุญุงู ุชุนุฑู ฺฉู.");
    return;
  }

  // ุณุงุฎุช ุขุฑุงู ุฑูุฒูุง
  var ds = new Date(data.range.start);
  var de = new Date(data.range.end);
  var dayDates=[], dayFree=[], dayUsed=[], dayTasks=[];
  var daySchoolFlag=[];
  var classMap={};// iso -> total hours
  data.classes.forEach(function(c){
    classMap[c.date] = (classMap[c.date]||0) + (c.hours||0);
  });

  while(ds<=de){
    var yy=ds.getFullYear();
    var mm=(ds.getMonth()+1).toString().padStart(2,'0');
    var dd=ds.getDate().toString().padStart(2,'0');
    var iso=yy+"-"+mm+"-"+dd;
    dayDates.push(iso);
    var infoDay = data.days.find(function(d){return d.iso===iso;});
    var goes = infoDay ? infoDay.goesToSchool : "ุฎุฑ";
    var base = (goes==="ุจูู")? data.hours.schoolDay : data.hours.whiteDay;
    var cl  = classMap[iso] || 0;
    var free = Math.max(0, base - cl);
    dayFree.push(free);
    dayUsed.push(0);
    dayTasks.push([]);
    daySchoolFlag.push(goes==="ุจูู");
    ds.setDate(ds.getDate()+1);
  }

  // ฺฉู ฺฉุฑุฏู ุฒูุงู ุฎูุฏ ุงูุชุญุงูโูุง
  data.exams.forEach(function(ex){
    var idx = dayDates.indexOf(ex.date);
    if(idx>=0){
      var h = (ex.durationMin||0)/60;
      dayFree[idx] = Math.max(0, dayFree[idx]-h);
    }
  });

  // ุฏุณุชูโุจูุฏ ุงูุชุญุงูโูุง ุจุฑ ุงุณุงุณ ุชุงุฑุฎ
  data.exams.sort(function(a,b){
    return new Date(a.date) - new Date(b.date);
  });

  // ุฏุฑุตุฏ ุงูุชุงุฒ ูุฑ ุฏุฑุณ ุงุฒ ูุณุชูุฑ
  var subjectScores = computeSubjectScoreMap(data.history);

  // ุณุงุฎุช ุจุฑูุงูู ุจู ุงุฒุง ูุฑ ุงูุชุญุงู
  var scheduleByExam=[];
  for(var ei=0; ei<data.exams.length; ei++){
    var exam = data.exams[ei];
    var examIdx = dayDates.indexOf(exam.date);
    if(examIdx<0) continue;
    var prevExamDate = (ei===0 ? data.range.start : data.exams[ei-1].date);
    var winStartIdx = dayDates.indexOf(prevExamDate);
    if(winStartIdx<0) winStartIdx = 0;
    var winEndIdx = examIdx-1;
    if(winEndIdx<winStartIdx) continue;

    // ุฌูุน ุณุงุนุช ุขุฒุงุฏ ูพูุฌุฑู
    var winHours=0;
    for(var di=winStartIdx; di<=winEndIdx; di++){
      winHours += Math.max(0, dayFree[di]-dayUsed[di]);
    }
    if(winHours<=0) continue;

    var subj = exam.subject;
    var cat  = getSubjectCategory(subj);
    var perc = subjectScores[subj] || 0;
    var shareStudyPercent = 0.8; // ูพุดโูุฑุถ

    if(cat==="lang"){ // ุฒุจุงู/ุนุฑุจ
      shareStudyPercent = (perc>60? 0.70 : 0.75);
    }else if(cat==="adab"){ // ุงุฏุจุงุช/ุฏู
      shareStudyPercent = (perc>70? 0.80 : 0.85);
    }else if(cat==="extra"){ // ุชุงุฑุฎุ ุฌุบุฑุงูุงุ ุณูุงูุช...
      shareStudyPercent = (perc>70? 0.70 : 0.90);
    }else if(cat==="bio" || cat==="chem" || cat==="phys" || cat==="math"){
      // ุงุฎุชุตุงุต: ุฏุฑุตุฏ ุจุฑุง ูุทุงูุนู+ุญู ุชูุฑู
      if(cat==="bio" || cat==="chem"){
        shareStudyPercent = (perc>40? 0.50 : 0.65);
      }else{
        shareStudyPercent = (perc>40? 0.20 : 0.40);
      }
    }else{
      shareStudyPercent = 0.8;
    }

    // ููููู ุณุคุงู ฒ ุณุงุนุชู ุฑูุฒ ูุจู ุงูุชุญุงู (ุฌุฒู ููู ูุทุงูุนู ุญุณุงุจ ูโุดูุฏ)
    var sampleHours = Math.min(2, winHours);
    var totalStudyHours = Math.max(sampleHours, winHours*shareStudyPercent);
    if(totalStudyHours>winHours) totalStudyHours=winHours;
    var testHours = 0;
    if(cat==="bio" || cat==="chem" || cat==="phys" || cat==="math"){
      testHours = Math.max(0, winHours - totalStudyHours);
    }

    // ุชูุฒุน ุฑู ุฑูุฒูุง
    var remainingStudy = totalStudyHours;
    var remainingTest  = testHours;

    for(var di2=winStartIdx; di2<=winEndIdx; di2++){
      var cap = Math.max(0, dayFree[di2]-dayUsed[di2]);
      if(cap<0.25) continue;

      // ุงฺฏุฑ ุฑูุฒ ูุจู ุงูุชุญุงู => ููููู ุณูุงู
      if(di2===winEndIdx && sampleHours>0){
        var allocSample = Math.min(sampleHours, cap);
        if(allocSample>=0.5){
          dayTasks[di2].push(
            '๐ ุญู ููููู ุณุคุงู '+subj+
            '<br>ูุฏุช: '+formatHoursWithMinutes(allocSample)
          );
          dayUsed[di2]+=allocSample;
          sampleHours -= allocSample;
          remainingStudy -= allocSample;
          cap = Math.max(0, dayFree[di2]-dayUsed[di2]);
        }
      }

      // ูุทุงูุนู + ุญู ุชูุฑู
      if(remainingStudy>0 && cap>0.25){
        var sAlloc = Math.min(remainingStudy, cap*0.7); // ฺฉู ุฌุง ุจุฑุง ุชุณุช ุงุญุชูุงู
        if(sAlloc>=0.5){
          dayTasks[di2].push(
            '๐ ูุทุงูุนู ู ุญู ุชูุฑู '+subj+
            '<br>ูุฏุช: '+formatHoursWithMinutes(sAlloc)
          );
          dayUsed[di2]+=sAlloc;
          remainingStudy -= sAlloc;
          cap = Math.max(0, dayFree[di2]-dayUsed[di2]);
        }
      }

      // ุชุณุช (ููุท ุงุฎุชุตุงุต)
      if(remainingTest>0 && cap>0.25){
        var tAlloc = Math.min(remainingTest, cap);
        if(tAlloc>=0.5){
          var perMin = 2.0;
          var testsCount = Math.round((tAlloc*60)/perMin);
          dayTasks[di2].push(
            '๐งช ุชุณุช '+subj+
            '<br>ุญุฏูุฏ '+testsCount+' ุชุณุช ุฏุฑ '+formatHoursWithMinutes(tAlloc)
          );
          dayUsed[di2]+=tAlloc;
          remainingTest -= tAlloc;
        }
      }
    }

    scheduleByExam.push({
      subject:subj,
      examDate:exam.date,
      studyHours:totalStudyHours,
      testHours:testHours
    });
  }

  // ูพุฑ ฺฉุฑุฏู ุฑูุฒูุง ุฎุงู
  for(var di3=0; di3<dayTasks.length; di3++){
    if(dayTasks[di3].length===0){
      dayTasks[di3].push("โช ุงุณุชุฑุงุญุช / ูุฑูุฑ ุณุจฺฉ");
    }
  }

  // ุฑูุฏุฑ ุฌุฏูู
  var weekdays = ["ฺฉุดูุจู","ุฏูุดูุจู","ุณูโุดูุจู","ฺูุงุฑุดูุจู","ูพูุฌโุดูุจู","ุฌูุนู","ุดูุจู"];
  var html = '<tr><th>ุชุงุฑุฎ</th><th>ุฑูุฒ ููุชู</th><th>ุจุฑูุงูู</th></tr>';
  for(var iDay=0;iDay<dayDates.length;iDay++){
    var dObj = new Date(dayDates[iDay]);
    var yy=dObj.getFullYear();
    var mm=(dObj.getMonth()+1).toString().padStart(2,'0');
    var dd=dObj.getDate().toString().padStart(2,'0');
    var labelDate = yy+"/"+mm+"/"+dd;
    var wd = weekdays[dObj.getDay()];
    var tasksHTML="";
    dayTasks[iDay].forEach(function(t){
      tasksHTML+='<div class="task-block">'+t+'</div>';
    });
    html += '<tr>'+
      '<td style="text-align:center">'+labelDate+'</td>'+
      '<td style="text-align:center">'+wd+'</td>'+
      '<td>'+tasksHTML+'</td>'+
      '</tr>';
  }
  table.innerHTML = html;

  // ุฐุฎุฑู ุฏุฑ Supabase (ุฏุฑ ููุงู ุฌุฏูู plans/task_status ุจุง ููุน plan_type = "dey")
  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    alert("ุจุฑุง ุฐุฎุฑู ุฏุฑ Supabase ุจุงุฏ ูุงฺฏู ุจุงุด.");
    return;
  }
  var user = userRes.data.user;

  status.style.color="#b30000";
  status.textContent="ุฏุฑ ุญุงู ุฐุฎุฑู ุจุฑูุงูู ุฏโูุงู ุฏุฑ Supabase...";

  var insertRes=await supabase
    .from("plans")
    .insert({
      email:user.email,
      fname:b.fname,
      lname:b.lname,
      phone:b.phone,
      city:b.city,
      school:b.school,
      grade:b.grade,
      major:b.major,
      program_date:data.range.start,
      plan_type:"dey" // ููุน ุฎุงุต ุฏโูุงู
    })
    .select()
    .single();
  if(insertRes.error){
    console.log(insertRes.error);
    status.textContent="โ ุฎุทุง ุฏุฑ ุฐุฎุฑู ุจุฑูุงูู ุฏโูุงู: "+insertRes.error.message;
    return;
  }
  var planId = insertRes.data.id;
  var rows=[];
  for(var dIdx=0; dIdx<dayTasks.length; dIdx++){
    var tasks=dayTasks[dIdx];
    for(var ti=0; ti<tasks.length; ti++){
      var txt=tasks[ti].replace(/<br>/g," ").replace(/<\/?[^>]+(>|$)/g,"").trim();
      rows.push({
        plan_id:planId,
        day:dIdx+1,
        task_text:txt,
        status:TASK_STATUS.TODO,
        leftover:0,
        done:false
      });
    }
  }
  if(rows.length){
    var tRes=await supabase.from("task_status").insert(rows);
    if(tRes.error){
      console.log(tRes.error);
      status.textContent="โ๏ธ ุจุฑูุงูู ุฏโูุงู ุฐุฎุฑู ุดุฏ ุงูุง ุชุณฺฉโูุง ุฐุฎุฑู ูุดุฏูุฏ: "+tRes.error.message;
    }else{
      status.style.color="green";
      status.textContent="โ ุจุฑูุงูู ู ุชุณฺฉโูุง ุฏโูุงู ุฐุฎุฑู ุดุฏูุฏ.";
    }
  }else{
    status.style.color="green";
    status.textContent="โ ุจุฑูุงูู ุฏโูุงู ุฐุฎุฑู ุดุฏ (ุจุฏูู ุชุณฺฉ).";
  }
  loadStudentPlans();
}

/* ===== ูพุงูโูุง ู ฺฏุฒุงุฑุดโูุง ุฑูุฒุงูู ===== */
async function sendManualMessage(){
  var txt = document.getElementById("manualMessageText").value.trim();
  if(!txt){
    alert("ูุชู ูพุงู ุฑุง ุจููุณ.");
    return;
  }
  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    alert("ุจุฑุง ุฐุฎุฑู ูพุงู ุจุงุฏ ูุงฺฏู ุจุงุด.");
    return;
  }
  var email = userRes.data.user.email;
  var now = new Date().toISOString();
  var res = await supabase
    .from("messages")
    .insert({
      email:email,
      message_type:"manual",
      text:txt,
      created_at:now
    });
  if(res.error){
    alert("ุฎุทุง ุฏุฑ ุฐุฎุฑู ูพุงู.");
    console.log(res.error);
    return;
  }
  document.getElementById("manualMessageText").value="";
  loadMessages();
}

async function generateTodayReport(){
  await generateTodayReportCore(false);
}
async function tryAutoDailyReport(){
  // ุชูุงุด ูโฺฉูู ุงฺฏุฑ ุงูุฑูุฒ ฺฏุฒุงุฑุด ูุฏุงุฑูุ ฺฉ ฺฏุฒุงุฑุด ุฎูุฏฺฉุงุฑ ุซุจุช ฺฉูู
  await generateTodayReportCore(true);
}

async function generateTodayReportCore(isAuto){
  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user) return;
  var email = userRes.data.user.email;

  var todayIso = new Date().toISOString().slice(0,10);

  // ุงฺฏุฑ ุงุชููุงุช ุงุณุชุ ุจุจูู ูุจูุงู ฺฏุฒุงุฑุด ุงูุฑูุฒ ูุณุช ุง ูู
  if(isAuto){
    var q = await supabase
      .from("messages")
      .select("id")
      .eq("email", email)
      .eq("message_type","auto_daily")
      .eq("report_date", todayIso)
      .limit(1);
    if(!q.error && q.data && q.data.length>0){
      return; // ูุจูุงู ุซุจุช ุดุฏู
    }
  }

  // ุณุงุฏู: ุขุฎุฑู ุจุฑูุงูู ฺฉุงุฑุจุฑ
  var pRes = await supabase
    .from("plans")
    .select("id,program_date")
    .eq("email", email)
    .order("id",{ascending:false})
    .limit(1);
  if(pRes.error || !pRes.data || !pRes.data.length) return;
  var plan = pRes.data[0];

  var tRes = await supabase
    .from("task_status")
    .select("day,task_text,status,done")
    .eq("plan_id", plan.id);
  if(tRes.error || !tRes.data) return;
  var tasks = tRes.data;

  var labels = getDateLabelsFromProgramDate(plan.program_date);
  var todayDayIndex = null;
  for(var i=0;i<labels.length;i++){
    var parts=labels[i].split(" ");
    var datePart=parts[1];
    var spl=datePart.split("/");
    var y=parseInt(spl[0],10);
    var m=parseInt(spl[1],10)-1;
    var d=parseInt(spl[2],10);
    var dt=new Date(y,m,d);
    var iso=dt.toISOString().slice(0,10);
    if(iso===todayIso){
      todayDayIndex=i+1;
      break;
    }
  }

  var done=0,partial=0,todo=0;
  var todayDone=[],todayPartial=[],todayTodo=[];
  for(var j=0;j<tasks.length;j++){
    var st = tasks[j].status || (tasks[j].done?TASK_STATUS.DONE:TASK_STATUS.TODO);
    if(st===TASK_STATUS.DONE) done++;
    else if(st===TASK_STATUS.PARTIAL) partial++;
    else todo++;
    if(todayDayIndex && tasks[j].day===todayDayIndex){
      if(st===TASK_STATUS.DONE) todayDone.push(tasks[j].task_text);
      else if(st===TASK_STATUS.PARTIAL) todayPartial.push(tasks[j].task_text);
      else todayTodo.push(tasks[j].task_text);
    }
  }
  var total = tasks.length||1;
  var percent = Math.round((done*100)/total);
  var text = "ฺฏุฒุงุฑุด ุฑูุฒ "+todayIso+
    " | ฺฉู ุชุณฺฉโูุง: "+total+
    " | ุงูุฌุงู ุดุฏู: "+done+
    " | ูุงูุต: "+partial+
    " | ุงูุฌุงูโูุดุฏู: "+todo+
    " | ุฏุฑุตุฏ ุงูุฌุงู ฺฉุงูู: "+percent+"ูช";

  if(todayDayIndex){
    text += "\n\nูุถุนุช ุงูุฑูุฒ:\n";
    if(todayDone.length){
      text+="โ ุงูุฌุงู ุดุฏู:\n";
      todayDone.forEach(function(t){text+="- "+t+"\n";});
    }
    if(todayPartial.length){
      text+="โณ ูุงูุต:\n";
      todayPartial.forEach(function(t){text+="- "+t+"\n";});
    }
    if(todayTodo.length){
      text+="โ ุงูุฌุงูโูุดุฏู:\n";
      todayTodo.forEach(function(t){text+="- "+t+"\n";});
    }
  }

  var res = await supabase
    .from("messages")
    .insert({
      email:email,
      message_type: (isAuto?"auto_daily":"auto_manual"),
      text:text,
      report_date:todayIso
    });
  if(res.error){
    if(!isAuto) alert("ุฎุทุง ุฏุฑ ุฐุฎุฑู ฺฏุฒุงุฑุด.");
    console.log(res.error);
    return;
  }
  if(!isAuto){
    alert("ฺฏุฒุงุฑุด ุงูุฑูุฒ ุฐุฎุฑู ุดุฏ.");
  }
  loadMessages();
}

/* ููุฏ ูุณุช ูพุงูโูุง */
async function loadMessages(){
  var box = document.getElementById("messagesList");
  if(!box) return;
  box.innerHTML="ุฏุฑ ุญุงู ุฎูุงูุฏู ูพุงูโูุง...";
  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    box.innerHTML="ุงุจุชุฏุง ูุงฺฏู ฺฉู.";
    return;
  }
  var email = userRes.data.user.email;
  var res = await supabase
    .from("messages")
    .select("id,message_type,text,created_at,report_date")
    .eq("email", email)
    .order("created_at",{ascending:false})
    .limit(100);
  if(res.error){
    box.innerHTML="ุฎุทุง ุฏุฑ ุฎูุงูุฏู ูพุงูโูุง.";
    console.log(res.error);
    return;
  }
  var rows = res.data || [];
  if(!rows.length){
    box.innerHTML="ูููุฒ ูพุงู ุซุจุช ูุดุฏู.";
    return;
  }
  var html="";
  rows.forEach(function(m){
    var typeLabel = (m.message_type==="manual"?"ูพุงู ุฏุณุช":
                     m.message_type==="auto_daily"?"ฺฏุฒุงุฑุด ุฎูุฏฺฉุงุฑ ุฑูุฒุงูู":"ฺฏุฒุงุฑุด");
    var dt = m.created_at ? m.created_at.replace("T"," ").slice(0,16) : "";
    html+='<div class="task-block">'+
      '<div style="font-size:11px;color:#555;">'+typeLabel+
      (m.report_date?(" | ูุฑุจูุท ุจู "+m.report_date):"")+
      " | ุซุจุช: "+dt+
      '</div>'+
      '<div style="margin-top:4px;font-size:12px;white-space:pre-wrap;">'+m.text+'</div>'+
      '</div>';
  });
  box.innerHTML=html;
}

/* ===== ูพุงุงู ุงุณฺฉุฑูพุช ===== */
</script>

<!-- ===== ุงุณฺฉุฑูพุช ูฺฉูู ุงูุชุญุงูุงุช ุฏโูุงู (Midterm) ===== -->
<script>
// ======================
// ฐ) ฺฉูฺฉโุชุงุจุน ุชุงุฑุฎ (Override)
// ======================
function getDateLabelsFromProgramDate(programDateStr, totalDays){
  totalDays = totalDays || 14;
  var arr = [];
  if(!programDateStr){
    for(var i=1;i<=totalDays;i++){
      arr.push("ุฑูุฒ "+i);
    }
    return arr;
  }
  try{
    var parts = programDateStr.split("-");
    var y = parseInt(parts[0],10);
    var m = parseInt(parts[1],10)-1;
    var d = parseInt(parts[2],10);
    var base = new Date(y,m,d);
    var weekDays = ["ฺฉุดูุจู","ุฏูุดูุจู","ุณูโุดูุจู","ฺูุงุฑุดูุจู","ูพูุฌุดูุจู","ุฌูุนู","ุดูุจู"];
    for(var i=0;i<totalDays;i++){
      var dt = new Date(base.getTime());
      dt.setDate(dt.getDate()+i);
      var jy = dt.getFullYear();
      var jm = dt.getMonth()+1;
      var jd = dt.getDate();
      var w  = weekDays[dt.getDay()];
      var labelDate = jy+"/"+(jm<10?"0"+jm:jm)+"/"+(jd<10?"0"+jd:jd);
      arr.push("ุฑูุฒ "+(i+1)+" - "+labelDate+" ("+w+")");
    }
    return arr;
  }catch(e){
    var out=[];
    for(var j=1;j<=totalDays;j++) out.push("ุฑูุฒ "+j);
    return out;
  }
}

function daysBetween(date1, date2){
  try{
    var d1 = new Date(date1);
    var d2 = new Date(date2);
    var diff = d2.getTime() - d1.getTime();
    return Math.floor(diff / (1000*60*60*24));
  }catch(e){
    return 9999;
  }
}

// ======================
// ฐูซต) ุจุฑฺุณุจ ููุน ุจุฑูุงูู (Override)
// ======================
function planTypeLabel(t){
  if(t === "personality") return "ุชูพ ุดุฎุตุช";
  if(t === "ai")          return "ููุด ูุตููุน";
  if(t === "midterm")     return "ุงูุชุญุงูุงุช ุฏโูุงู";
  return "ุนุงุฏ";
}

// ======================
// ฑ) ุณุงุฎุช ุฌุฏูู ุฑูุฒูุง (dmGenerateDays)
// ======================
function dmGenerateDays(){
  var startStr  = document.getElementById("dmStartDate").value;
  var endStr    = document.getElementById("dmEndDate").value;
  var info      = document.getElementById("dmDayRangeInfo");
  var cntInput  = document.getElementById("dmDayCount");
  var tbody     = document.getElementById("dmAttendanceBody");

  if(!startStr || !endStr){
    alert("ุงูู ุชุงุฑุฎ ุดุฑูุน ู ูพุงุงู ุงูุชุญุงูุงุช ุฏโูุงู ุฑุง ูุงุฑุฏ ฺฉู.");
    return;
  }
  var d1 = new Date(startStr);
  var d2 = new Date(endStr);
  if(isNaN(d1.getTime()) || isNaN(d2.getTime())){
    alert("ูุฑูุช ุชุงุฑุฎโูุง ุงุดุชุจุงู ุงุณุช.");
    return;
  }
  if(d2 < d1){
    alert("ุชุงุฑุฎ ูพุงุงู ูุจุงุฏ ูุจู ุงุฒ ุชุงุฑุฎ ุดุฑูุน ุจุงุดุฏ.");
    return;
  }

  var diff = daysBetween(startStr,endStr) + 1; // ูุงุตูู + ุฑูุฒ ุดุฑูุน
  if(diff <= 0){
    alert("ุจุงุฒูโ ุฑูุฒูุง ูุงูุนุชุจุฑ ุงุณุช.");
    return;
  }
  if(diff > 60){
    if(!confirm("ุจุงุฒูโ ุงูุชุฎุงุจ ุดุฏู ุจุด ุงุฒ ถฐ ุฑูุฒ ุงุณุช. ูุทูุฆูุ")){
      return;
    }
  }

  cntInput.value = diff;
  info.textContent = "ุชุนุฏุงุฏ ุฑูุฒูุง ุจู ุงู ุฏู ุชุงุฑุฎ: "+diff+" ุฑูุฒ";

  // ุณุงุฎุช ุฌุฏูู ุญุถูุฑ ุฏุฑ ูุฏุฑุณู
  tbody.innerHTML = "";
  var labels = getDateLabelsFromProgramDate(startStr, diff);
  for(var i=1;i<=diff;i++){
    var tr = document.createElement("tr");
    var lbl = labels[i-1] || ("ุฑูุฒ "+i);
    tr.innerHTML =
      '<td style="text-align:center;">'+lbl+'</td>'+
      '<td style="text-align:center;">'+
        '<select class="dm-go-school" data-day="'+i+'">'+
          '<option value="ุจูู">ุจูู</option>'+
          '<option value="ุฎุฑ">ุฎุฑ</option>'+
        '</select>'+
      '</td>';
    tbody.appendChild(tr);
  }
}

// ======================
// ฒ) ุงูุฒูุฏู ฺฉูุงุณ ุขููุงู (dmAddClassRow)
// ======================
function dmAddClassRow(){
  var tbody = document.getElementById("dmClassesBody");
  var dayCount = parseInt(document.getElementById("dmDayCount").value||"0",10);
  if(!dayCount){
    alert("ุงูู ุฑู ยซูุญุงุณุจู ุฑูุฒูุงยป ุจุฒู ุชุง ุชุนุฏุงุฏ ุฑูุฒูุง ูุดุฎุต ุดูุฏ.");
    return;
  }
  var tr = document.createElement("tr");
  tr.innerHTML =
    '<td><input type="number" min="1" step="1" class="dm-class-day" style="width:60px;"></td>'+
    '<td><input type="text" class="dm-class-subject" placeholder="ูุซูุงู ุฒุณุช" style="width:100px;"></td>'+
    '<td><input type="number" step="0.5" min="0" class="dm-class-duration" style="width:70px;" placeholder="ุณุงุนุช"></td>'+
    '<td><input type="text" class="dm-class-topic" placeholder="ุนููุงู ุฌูุณู"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
}

// ======================
// ณ) ุงูุฒูุฏู ุงูุชุญุงู (dmAddExamRow)
// ======================
function dmAddExamRow(){
  var tbody = document.getElementById("dmExamBody");
  var dayCount = parseInt(document.getElementById("dmDayCount").value||"0",10);
  if(!dayCount){
    alert("ุงูู ุฑู ยซูุญุงุณุจู ุฑูุฒูุงยป ุจุฒู ุชุง ุชุนุฏุงุฏ ุฑูุฒูุง ูุดุฎุต ุดูุฏ.");
    return;
  }
  var tr = document.createElement("tr");
  tr.className = "dm-exam-row";
  tr.innerHTML =
    '<td><input type="text" class="dm-exam-subject" placeholder="ูุซูุงู ุฒุณุช" style="width:100px;"></td>'+
    '<td>'+
      '<select class="dm-exam-type">'+
        '<option value="ุนููู">ุนููู</option>'+
        '<option value="ุชุฎุตุต">ุชุฎุตุต</option>'+
        '<option value="ูพุงูโุง/ุฌุงูุจ">ูพุงูโุง/ุฌุงูุจ</option>'+
      '</select>'+
    '</td>'+
    '<td><input type="number" min="1" step="1" class="dm-exam-day" style="width:60px;" placeholder="ุฑูุฒ"></td>'+
    '<td><input type="text" class="dm-exam-date" placeholder="ูุซูุงู ฑด ุฏ"></td>'+
    '<td style="text-align:center;">'+
      '<input type="checkbox" class="dm-exam-allow-study" checked>'+
    '</td>'+
    '<td><input type="text" class="dm-exam-notes" placeholder="ุชูุถุญุงุช ุชฺฉูู"></td>'+
    '<td style="text-align:center;"><button type="button" class="small-btn del" onclick="this.closest(\\\'tr\\\').remove()">ุญุฐู</button></td>';
  // (ูุดุงูโฺฏุฐุงุฑ "del" ฺฉุงู ุงุณุชุ remove ฺฉุงุฑ ูโฺฉูุฏ)
  tr.innerHTML = tr.innerHTML.replace(/\\\\'/g,"'");
  tbody.appendChild(tr);
}

// ======================
// ด) ุฌูุนโุขูุฑ ุฏุงุฏูโ ูุฑู ุฏโูุงู
// ======================
function dmCollectBasicStudentInfo(){
  // ุงุฒ ููุงู ููุฏูุง ูุฑู ุงุตู ุงุณุชูุงุฏู ูโฺฉูู
  var fname  = document.getElementById("fname").value.trim();
  var lname  = document.getElementById("lname").value.trim();
  var phone  = document.getElementById("phone").value.trim();
  var city   = document.getElementById("city").value.trim();
  var school = document.getElementById("school").value.trim();
  var grade  = document.getElementById("grade").value;
  var major  = document.getElementById("major").value;

  if(!fname || !lname || !phone || !city || !school || !grade || !major){
    alert("ุจุฑุง ุงูุชุญุงูุงุช ุฏโูุงู ูู ุจุงุฏ ูุงูุ ูุงู ุฎุงููุงุฏฺฏุ ุดูุงุฑู ููุจุงูุ ุดูุฑุ ูุฏุฑุณูุ ูพุงู ู ุฑุดุชู ุฑุง ูพุฑ ฺฉู.");
    return null;
  }
  var reg=/^09\d{9}$/;
  if(!reg.test(phone)){
    alert("ุดูุงุฑู ููุจุงู ุจุงุฏ ุจุง 09 ุดุฑูุน ุดูุฏ ู ุฏููุงู 11 ุฑูู ุจุงุดุฏ.");
    return null;
  }
  return {fname,lname,phone,city,school,grade,major};
}

function dmCollectMidtermData(){
  var startStr  = document.getElementById("dmStartDate").value;
  var endStr    = document.getElementById("dmEndDate").value;
  var whiteDay  = parseFloat(document.getElementById("dmWhiteDay").value)||0;
  var schoolDay = parseFloat(document.getElementById("dmSchoolDay").value)||0;
  var dayCount  = parseInt(document.getElementById("dmDayCount").value||"0",10);

  if(!startStr || !endStr){
    alert("ุชุงุฑุฎ ุดุฑูุน ู ูพุงุงู ุงูุชุญุงูุงุช ุฏโูุงู ุฑุง ูุงุฑุฏ ฺฉู.");
    return null;
  }
  if(!dayCount || dayCount<=0){
    alert("ุฑู ยซูุญุงุณุจู ุฑูุฒูุงยป ุจุฒู ุชุง ุชุนุฏุงุฏ ุฑูุฒูุง ูุดุฎุต ุดูุฏ.");
    return null;
  }

  var attendance=[];
  var attRows=document.querySelectorAll("#dmAttendanceBody .dm-go-school");
  if(!attRows.length){
    alert("ุฌุฏูู ุญุถูุฑ ุฏุฑ ูุฏุฑุณู ุฎุงู ุงุณุช. ุฑู ยซูุญุงุณุจู ุฑูุฒูุงยป ุจุฒู.");
    return null;
  }
  for(var i=0;i<attRows.length;i++){
    var sel=attRows[i];
    var d=parseInt(sel.getAttribute("data-day")||"0",10);
    if(!d) continue;
    attendance.push({
      day:d,
      goesToSchool: sel.value
    });
  }

  var classes=[];
  var clsRows=document.querySelectorAll("#dmClassesBody tr");
  for(var c=0;c<clsRows.length;c++){
    var tr=clsRows[c];
    var day = parseInt(tr.querySelector(".dm-class-day").value||"0",10);
    if(!day) continue;
    classes.push({
      day:day,
      subject: (tr.querySelector(".dm-class-subject").value||"").trim() || "ฺฉูุงุณ ุขููุงู",
      duration: parseFloat(tr.querySelector(".dm-class-duration").value)||0,
      topic: (tr.querySelector(".dm-class-topic").value||"").trim()
    });
  }

  var exams=[];
  var exRows=document.querySelectorAll("#dmExamBody .dm-exam-row");
  if(!exRows.length){
    alert("ุญุฏุงูู ฺฉ ุงูุชุญุงู ุฏุฑ ุฌุฏูู ุงูุชุญุงูุงุช ุฏโูุงู ุชุนุฑู ฺฉู.");
    return null;
  }
  for(var e=0;e<exRows.length;e++){
    var row=exRows[e];
    var subj = (row.querySelector(".dm-exam-subject").value||"").trim();
    var type = row.querySelector(".dm-exam-type").value;
    var day  = parseInt(row.querySelector(".dm-exam-day").value||"0",10);
    var dateText = (row.querySelector(".dm-exam-date").value||"").trim();
    var allowStudy = row.querySelector(".dm-exam-allow-study").checked;
    var notes = (row.querySelector(".dm-exam-notes").value||"").trim();

    if(!subj){
      alert("ูุงู ุฏุฑุณ ฺฉ ุงุฒ ุงูุชุญุงูโูุง ุฎุงู ุงุณุช.");
      return null;
    }
    if(!day || day<1 || day>dayCount){
      alert("ุฑูุฒ ุงูุชุญุงู "+subj+" ุจุงุฏ ุจู ฑ ุชุง "+dayCount+" ุจุงุดุฏ.");
      return null;
    }

    exams.push({
      subject:subj,
      type:type,
      day:day,
      displayDate:dateText,
      allowStudy:allowStudy,
      notes:notes
    });
  }

  exams.sort(function(a,b){ return a.day - b.day; });

  return {
    startDate:startStr,
    endDate:endStr,
    totalDays:dayCount,
    whiteDay:whiteDay,
    schoolDay:schoolDay,
    attendance:attendance,
    classes:classes,
    exams:exams
  };
}

// ======================
// ต) ุงูฺฏูุฑุชู ุณุงุฏูโ ุณุงุฎุช ุจุฑูุงูู ุฏโูุงู
// ======================
function buildMidtermPlan(dm, dateLabels){
  var DAYS = dm.totalDays;
  var free = new Array(DAYS).fill(0);
  var classHoursPerDay = new Array(DAYS).fill(0);

  // ุณุงุนุช ูพุงู ูุฑ ุฑูุฒ
  for(var i=1;i<=DAYS;i++){
    var att = dm.attendance.find(function(a){return a.day===i;});
    var base = (att && att.goesToSchool==="ุจูู")? dm.schoolDay : dm.whiteDay;
    free[i-1] = base || 0;
  }

  // ฺฉูุงุณโูุง ุขููุงู
  for(var c=0;c<dm.classes.length;c++){
    var cl = dm.classes[c];
    if(cl.day>=1 && cl.day<=DAYS){
      var h = parseFloat(cl.duration)||0;
      classHoursPerDay[cl.day-1]+=h;
      free[cl.day-1]-=h;
    }
  }
  for(i=0;i<DAYS;i++){
    if(free[i]<0) free[i]=0;
  }

  // ููุดูโ ุงูุชุญุงูุงุช ุฏุฑ ุฑูุฒ
  var examsByDay = {};
  for(i=0;i<dm.exams.length;i++){
    var ex = dm.exams[i];
    if(!examsByDay[ex.day]) examsByDay[ex.day]=[];
    examsByDay[ex.day].push(ex);
  }

  var plan=[];
  var html='<tr><th>ุฑูุฒ</th><th>ุจุฑูุงูู ุฏโูุงู</th></tr>';

  for(var d=1;d<=DAYS;d++){
    var dayTasks=[];
    var label = (dateLabels && dateLabels[d-1]) ? dateLabels[d-1] : ("ุฑูุฒ "+d);
    var freeH = free[d-1];

    // ฺฉูุงุณโูุง ุขููุงู
    for(c=0;c<dm.classes.length;c++){
      var cl2 = dm.classes[c];
      if(cl2.day===d){
        dayTasks.push(
          '๐ง ฺฉูุงุณ ุขููุงู '+cl2.subject+' โ '+(cl2.topic||"ููุถูุน ูุงูุดุฎุต")+
          '<br>ูุฏุช: '+formatHoursWithMinutes(cl2.duration||0)
        );
      }
    }

    // ุงฺฏุฑ ุฑูุฒ ุงูุชุญุงู ุงุณุช
    if(examsByDay[d]){
      var exList = examsByDay[d];
      for(i=0;i<exList.length;i++){
        var ex3=exList[i];
        var dateTxt = ex3.displayDate? (" ("+ex3.displayDate+")") : "";
        dayTasks.push(
          '๐จ ุงูุชุญุงู '+ex3.subject+dateTxt+
          '<br>ููุน ุฏุฑุณ: '+ex3.type+
          (ex3.notes? '<br>ุงุฏุฏุงุดุช: '+ex3.notes : "")
        );
      }
      if(freeH>0.5){
        var hRev = Math.min(2,freeH);
        dayTasks.push(
          'โ ูุฑูุฑ ุณุจฺฉ ู ุงุณุชุฑุงุญุช ูุจู/ุจุนุฏ ุงุฒ ุงูุชุญุงู<br>ูุฏุช: '+formatHoursWithMinutes(hRev)
        );
        freeH -= hRev;
      }
    }else{
      // ุฑูุฒูุง ูุจู ุงุฒ ุงูุชุญุงู
      var nextExam=null;
      for(i=0;i<dm.exams.length;i++){
        var exN = dm.exams[i];
        if(exN.day>d){
          if(!nextExam || exN.day < nextExam.day){
            nextExam = exN;
          }
        }
      }

      if(nextExam && freeH>0.25){
        var daysLeft = nextExam.day - d;
        var subj = nextExam.subject;
        var type = nextExam.type;

        // ุชูุณู ุณุงุฏู ูุทุงูุนู/ุญู ุชูุฑู
        var hStudy, hPractice;
        if(daysLeft<=2){
          hStudy   = freeH*0.5;
          hPractice= freeH*0.5;
        }else{
          hStudy   = freeH*0.6;
          hPractice= freeH*0.4;
        }

        if(hStudy>=0.5){
          dayTasks.push(
            '๐ ูุทุงูุนู '+subj+' ุจุฑุง ุงูุชุญุงู ุฑูุฒ '+nextExam.day+
            '<br>ููุน ุฏุฑุณ: '+type+
            '<br>ูุฏุช ูุทุงูุนู: '+formatHoursWithMinutes(hStudy)
          );
        }
        if(hPractice>=0.5){
          dayTasks.push(
            'โ๏ธ ุญู ุชูุฑู '+subj+
            '<br>ูุฏุช ุญู ุชูุฑู: '+formatHoursWithMinutes(hPractice)
          );
        }
        freeH = 0;
      }else{
        // ุจุนุฏ ุงุฒ ุขุฎุฑู ุงูุชุญุงู / ุจุฏูู ุงูุชุญุงู
        if(freeH>0.5){
          dayTasks.push(
            '๐ ูุทุงูุนู ุขุฒุงุฏ / ูุฑูุฑ ูุจุงุญุซ ููู ุฏุฑูุณ ูุฎุชูู<br>ูุฏุช: '+formatHoursWithMinutes(freeH)
          );
          freeH=0;
        }
      }
    }

    if(dayTasks.length===0){
      dayTasks.push("โช ุงุณุชุฑุงุญุช / ูุฑูุฑ ุขุฒุงุฏ");
    }

    var tasksHTML="";
    for(i=0;i<dayTasks.length;i++){
      tasksHTML+='<div class="task-block">'+dayTasks[i]+'</div>';
    }

    html+='<tr><td style="text-align:center">'+label+'</td><td>'+tasksHTML+'</td></tr>';
    plan.push(dayTasks);
  }

  // ูพูุดุด ุณุงุฏูุ ูุนูุงู ููุงุฏู
  return {
    plan:plan,
    html:html,
    coverage:{
      totalDays:DAYS,
      examsCount: dm.exams.length
    }
  };
}

// ======================
// ถ) ุฏฺฉูู ยซุณุงุฎุช ุจุฑูุงููโ ุฏโูุงูยป
// ======================
async function onBuildMidtermPlanClicked(){
  var status = document.getElementById("dmStatusMsg");
  var coverageDiv = document.getElementById("dmCoverageSummary");
  var schedTable = document.getElementById("dmScheduleTable");

  status.textContent = "";
  coverageDiv.textContent = "";
  schedTable.innerHTML = "";

  // ุงุทูุงุนุงุช ูพุงูโ ุฏุงูุดโุขููุฒ
  var basic = dmCollectBasicStudentInfo();
  if(!basic) return;

  // ุงุทูุงุนุงุช ุฏโูุงู
  var dm = dmCollectMidtermData();
  if(!dm) return;

  var dateLabels = getDateLabelsFromProgramDate(dm.startDate, dm.totalDays);
  var result = buildMidtermPlan(dm, dateLabels);

  schedTable.innerHTML = result.html;
  coverageDiv.textContent =
    "ุชุนุฏุงุฏ ุฑูุฒูุง: "+result.coverage.totalDays+
    " | ุชุนุฏุงุฏ ุงูุชุญุงูโูุง: "+result.coverage.examsCount;

  // ุฐุฎุฑู ุฏุฑ Supabase ุฏุฑ ููุงู ุฌุฏูู plans / task_status
  try{
    status.style.color="#b30000";
    status.textContent="ุฏุฑ ุญุงู ุฐุฎุฑู ุจุฑูุงููโ ุฏโูุงู ุฏุฑ Supabase...";

    var userRes = await supabase.auth.getUser();
    if(userRes.error || !userRes.data.user){
      alert("ุจุฑุง ุฐุฎุฑู ุจุฑูุงููโ ุฏโูุงู ุจุงุฏ ูุงฺฏู ุจุงุด.");
      status.textContent="ุงุจุชุฏุง ูุงฺฏู ฺฉู.";
      return;
    }
    var user = userRes.data.user;

    var programDate = dm.startDate; // ุดุฑูุน ุจุงุฒู ุฏโูุงู

    // ุซุจุช ุฏุฑ ุฌุฏูู plans ุจุง plan_type = 'midterm'
    var insertRes = await supabase
      .from("plans")
      .insert({
        email: user.email,
        fname: basic.fname,
        lname: basic.lname,
        phone: basic.phone,
        city: basic.city,
        school: basic.school,
        grade: basic.grade,
        major: basic.major,
        program_date: programDate,
        plan_type: "midterm"
      })
      .select()
      .single();

    if(insertRes.error){
      console.log(insertRes.error);
      status.textContent = "โ ุฎุทุง ุฏุฑ ุฐุฎุฑู ุจุฑูุงููโ ุฏโูุงู: "+insertRes.error.message;
      return;
    }

    var planId = insertRes.data.id;
    var rows=[];
    for(var d=0;d<result.plan.length;d++){
      var dayTasks = result.plan[d];
      for(var i=0;i<dayTasks.length;i++){
        // ุชุจุฏู HTML ฺฉูุชุงู ุจู ูุชู ุณุงุฏู
        var txt = dayTasks[i]
          .replace(/<br>/g," ")
          .replace(/<\/?[^>]+(>|$)/g,"")
          .trim();
        rows.push({
          plan_id:planId,
          day:d+1,
          task_text:txt,
          status:"todo",
          leftover:0,
          done:false
        });
      }
    }

    if(rows.length){
      var tRes = await supabase.from("task_status").insert(rows);
      if(tRes.error){
        console.log(tRes.error);
        status.textContent="โ๏ธ ุจุฑูุงููโ ุฏโูุงู ุฐุฎุฑู ุดุฏ ุงูุง ุชุณฺฉโูุง ุฐุฎุฑู ูุดุฏูุฏ: "+tRes.error.message;
      }else{
        status.style.color="green";
        status.textContent="โ ุจุฑูุงูู ู ุชุณฺฉโูุง ุฏโูุงู ุฐุฎุฑู ุดุฏูุฏ.";
      }
    }else{
      status.style.color="green";
      status.textContent="โ ุจุฑูุงููโ ุฏโูุงู ุฐุฎุฑู ุดุฏ (ุชุณฺฉ ุซุจุช ูุดุฏ).";
    }

    // ุจุฑูุงููโูุง ุฏุงูุดโุขููุฒ ุจุง ุฏโูุงู ูู ุจูโุฑูุฒ ุดูุฏ
    if(typeof loadStudentPlans === "function"){
      loadStudentPlans();
    }
    if(typeof loadBacklogView === "function"){
      loadBacklogView();
    }
  }catch(e){
    console.error(e);
    status.textContent="โ ุฎุทุง ุบุฑููุชุธุฑู ุฏุฑ ุฐุฎุฑู ุจุฑูุงููโ ุฏโูุงู.";
  }
}
</script>
</body>
</html>
