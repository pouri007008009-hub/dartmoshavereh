<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ุจุฑูุงููโุฑุฒ ฑด ุฑูุฒู ฺฉูฺฉูุฑ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* -------------- ูพุงู ูุฏุฑู + ุชูโูุง -------------- */

:root {
  --bg: #f3f4f6;
  --bg-soft: #eef2ff;
  --card-bg: #ffffff;
  --card-elevated: #f9fafb;
  --primary: #2563eb;
  --primary-soft: rgba(37, 99, 235, 0.1);
  --primary-soft-strong: rgba(37, 99, 235, 0.14);
  --border-soft: #e5e7eb;
  --border-strong: #d1d5db;
  --text-main: #111827;
  --text-muted: #6b7280;
  --text-softer: #9ca3af;
  --danger: #ef4444;
  --danger-soft: rgba(239, 68, 68, 0.08);
  --success: #16a34a;
  --success-soft: rgba(22, 163, 74, 0.09);
  --radius-lg: 18px;
  --radius-md: 12px;
  --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
  --shadow-subtle: 0 8px 24px rgba(15, 23, 42, 0.04);
  --input-bg: #f9fafb;
}

/* ูุณูุงุณ ุฏูู: ุณุจุฒ ุขุฑุงู ู ุจุณุงุฑ ูุฑุชุจ */
body.theme-obsessive {
  --primary: #0f766e;
  --primary-soft: rgba(15, 118, 110, 0.1);
  --primary-soft-strong: rgba(15, 118, 110, 0.16);
  --bg-soft: #ecfdf5;
}

/* ูพุฑุชูุงุด ุงูุง ูุฑุงุฑ: ูุงุฑูุฌ ูพุฑุงูุฑฺ */
body.theme-runner {
  --primary: #f97316;
  --primary-soft: rgba(249, 115, 22, 0.12);
  --primary-soft-strong: rgba(249, 115, 22, 0.18);
  --bg-soft: #fff7ed;
}

/* ุขูุณุชู ู ูพูุณุชู: ููุงู ุชู ูพุดโูุฑุถ ุขุฑุงู ู ุขุจ */
body.theme-steady {
  /* ุงุฒ default ุงุณุชูุงุฏู ูโฺฉูุฏ */
}

/* ููุฑูุงู ุฏููู ููุฏ: ุจููุด/ุตูุฑุช ูุฌุงู */
body.theme-lastminute {
  --primary: #9333ea;
  --primary-soft: rgba(147, 51, 234, 0.12);
  --primary-soft-strong: rgba(147, 51, 234, 0.18);
  --bg-soft: #faf5ff;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Tahoma,
    sans-serif;
  background: radial-gradient(circle at top left, #e0f2fe 0, transparent 40%),
    radial-gradient(circle at bottom right, #e5e7eb 0, transparent 45%),
    var(--bg);
  color: var(--text-main);
}

/* -------------- ุดูู ุงุตู ุงูพ -------------- */

.container {
  max-width: 1180px;
  margin: 24px auto 40px auto;
  background: linear-gradient(135deg, #ffffff, #f9fafb);
  border-radius: 26px;
  padding: 22px 24px 26px 24px;
  box-shadow: var(--shadow-soft);
  border: 1px solid rgba(148, 163, 184, 0.16);
}

/* ูุงฺฏู ฺฉุงุฑุช */

#loginContainer {
  max-width: 480px;
  margin-top: 60px;
  padding: 28px 26px 26px 26px;
  border-radius: 24px;
}

#loginContainer h2 {
  margin-bottom: 18px;
  font-weight: 700;
}

#loginContainer input {
  width: 100%;
}

#loginStatus {
  padding: 6px 10px;
  border-radius: 10px;
}

/* ูุฏุฑ ุงูพ */

.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  margin-bottom: 18px;
}

.app-title {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: radial-gradient(circle at left, var(--primary-soft-strong), transparent);
  color: var(--text-main);
  padding: 10px 16px;
  border-radius: 20px;
  font-size: 18px;
  font-weight: 700;
}

.app-title span.logo-dot {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background: var(--primary);
  box-shadow: 0 0 0 4px var(--primary-soft);
}

.user-chip {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: #f3f4ff;
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 11px;
  color: var(--text-muted);
  border: 1px solid rgba(129, 140, 248, 0.4);
}

/* -------------- ุชุจโูุง -------------- */

.tab-bar {
  display: inline-flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 4px;
  background: var(--card-elevated);
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  margin-bottom: 14px;
}

.tab-btn {
  border-radius: 999px !important;
  background: transparent;
  color: var(--text-muted);
  padding-inline: 12px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border: none;
}

.tab-btn.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 6px 16px rgba(15, 23, 42, 0.2);
}

/* -------------- ุณฺฉุดูโูุง / ฺฉุงุฑุชโูุง -------------- */

section {
  border-radius: var(--radius-lg);
  padding: 14px 16px 12px 16px;
  margin-bottom: 12px;
  background: var(--card-bg);
  border: 1px solid var(--border-soft);
  box-shadow: var(--shadow-subtle);
}

section h3 {
  margin-top: 0;
  margin-bottom: 4px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}

section h3::after {
  content: "";
  flex-grow: 1;
  height: 1px;
  margin-right: 8px;
  background: linear-gradient(
    90deg,
    rgba(148, 163, 184, 0.5),
    transparent 60%
  );
}

/* -------------- ูุฑูโูุง / ุงููพูุชโูุง -------------- */

label {
  font-size: 11px;
  color: var(--text-muted);
}

input,
select,
textarea {
  padding: 7px 8px;
  margin: 3px 0 7px 0;
  border-radius: 10px;
  border: 1px solid var(--border-soft);
  font-size: 12px;
  outline: none;
  background: var(--input-bg);
  transition: border-color 0.15s ease, box-shadow 0.15s ease,
    background-color 0.15s ease;
}

input:focus,
select:focus,
textarea:focus {
  border-color: var(--primary);
  background: #ffffff;
  box-shadow: 0 0 0 1px var(--primary-soft);
}

input[type="number"] {
  width: 90px;
}

textarea {
  resize: vertical;
}

input[type="radio"],
input[type="checkbox"] {
  width: auto;
  accent-color: var(--primary);
}

/* -------------- ุฏฺฉููโูุง -------------- */

.btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 7px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
  transition: transform 0.12s ease, box-shadow 0.12s ease,
    background-color 0.12s ease, opacity 0.12s ease;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 30px rgba(37, 99, 235, 0.35);
  opacity: 0.96;
}

.btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 18px rgba(15, 23, 42, 0.25);
}

.small-btn {
  background: #4b5563;
  color: #fff;
  border: none;
  padding: 4px 9px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 11px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  transition: background-color 0.15s ease, transform 0.1s ease;
}

.small-btn:hover {
  background: #374151;
  transform: translateY(-0.5px);
}

.small-btn.del {
  background: #b91c1c;
}

.small-btn.del:hover {
  background: #7f1d1d;
}

/* -------------- ุฌุฏููโูุง -------------- */

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11.5px;
  border-radius: var(--radius-md);
  overflow: hidden;
  background: var(--card-elevated);
}

th,
td {
  border: 1px solid rgba(209, 213, 219, 0.8);
  padding: 6px 7px;
  vertical-align: top;
}

th {
  background: linear-gradient(135deg, var(--primary), #111827);
  color: #f9fafb;
  font-weight: 500;
}

.table-soft th {
  background: #f3f4f6;
  color: var(--text-main);
}

table tr:nth-child(even) td {
  background: rgba(249, 250, 251, 0.9);
}

.sub-table th {
  font-size: 11px;
  padding: 5px 6px;
}

/* -------------- layout ูุง ุฏุงุฎู -------------- */

.row-flex {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.row-flex > div {
  min-width: 160px;
  flex: 1 1 160px;
}

/* -------------- ุชฺฏโูุง ู ุจูุฏุฌโูุง -------------- */

.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 10px;
  background: #e5e7eb;
  color: #374151;
  gap: 4px;
}

.badge.done {
  background: var(--success-soft);
  color: var(--success);
}

.badge.todo {
  background: var(--danger-soft);
  color: var(--danger);
}

.badge.partial {
  background: rgba(244, 114, 182, 0.12);
  color: #be185d;
}

/* -------------- ฺุฒูุง ุฑุฒ -------------- */

.task-block {
  margin-bottom: 6px;
  padding: 6px 8px;
  border-radius: 10px;
  background: #f9fafb;
  border: 1px dashed rgba(209, 213, 219, 0.9);
}

.task-block:last-child {
  margin-bottom: 0;
}

.hidden {
  display: none;
}

#coverageSummary {
  font-size: 11px;
  margin-top: 6px;
  color: var(--text-muted);
  background: var(--primary-soft);
  padding: 6px 8px;
  border-radius: 999px;
  display: inline-block;
}

/* ุฌุฏูู ุชูพ ุดุฎุตุช */

.personality-table td {
  border: none;
  padding: 5px 6px;
}

.personality-table th {
  background: var(--primary);
}

.personality-scale-header {
  font-size: 11px;
  text-align: center;
  color: #f9fafb;
}

/* ฺฉุงุฑุช ุขุฒูููโูุง */

.exam-card {
  border-radius: 14px;
  border: 1px solid var(--border-soft);
  background: #f9fafb;
  padding: 10px 10px 8px 10px;
  margin-top: 8px;
}

/* ุฑุณูพุงูุณู */

@media (max-width: 768px) {
  .container {
    margin: 12px;
    padding: 18px 14px 20px 14px;
    border-radius: 22px;
  }

  .app-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .tab-bar {
    width: 100%;
    justify-content: space-between;
  }
}
</style>
</head>
<body class="theme-steady">
<!-- ูุงฺฏู -->
<div id="loginContainer" class="container">
  <h2 style="text-align:center;margin-bottom:10px;">ูุฑูุฏ ุจู ุณุงูุงูู ุจุฑูุงููโุฑุฒ</h2>
  <div style="max-width:320px;margin:auto;">
    <label>ุงูู</label><br>
    <input id="loginEmail" type="email" placeholder="ูุซูุงู student@example.com"><br>
    <label>ูพุณูุฑุฏ (ุญุฏุงูู ถ ฺฉุงุฑุงฺฉุชุฑ)</label><br>
    <input id="loginPassword" type="password"><br>
    <button class="btn" style="width:100%;justify-content:center;margin-top:6px;" onclick="handleLogin()">ูุฑูุฏ ุจู ุญุณุงุจ</button>
    <div id="loginStatus" style="font-size:11px;color:#b30000;margin-top:6px;"></div>
  </div>
</div>

<!-- ุงูพ ุงุตู -->
<div id="appContainer" class="container hidden">
  <div class="app-header">
    <h1 class="app-title">
      <span class="logo-dot"></span>
      <span>ุจุฑูุงููโุฑุฒ ฑด ุฑูุฒู ฺฉูฺฉูุฑ</span>
    </h1>
    <div>
      <span id="currentUserEmail" class="user-chip"></span>
      <button class="small-btn" onclick="logout()">ุฎุฑูุฌ</button>
    </div>
  </div>

  <!-- ุชุจโูุง -->
  <div class="tab-bar">
    <button class="btn tab-btn active" id="personalityTabBtn" onclick="showTab('personalityTab')">๐งฌ ุขุฒููู ุดุฎุตุช</button>
    <button class="btn tab-btn" id="plannerTabBtn" onclick="showTab('plannerTab')">๐ง ุณุงุฎุช ุจุฑูุงูู</button>
    <button class="btn tab-btn" id="studentTabBtn" onclick="showTab('studentTab')">โ ุจุฑูุงููโูุง ูู</button>
    <button class="btn tab-btn" id="backlogTabBtn" onclick="showTab('backlogTab')">๐ฆ ุนูุจโูุงูุฏฺฏโูุง</button>
    <button class="btn tab-btn" id="adminTabBtn" style="display:none;" onclick="showTab('adminTab')">๐ ูพูู ุงุฏูู</button>
  </div>

  <!-- ุชุจ ุขุฒููู ุดุฎุตุช -->
  <div id="personalityTab">
    <section>
      <h3>๐งฌ ุขุฒููู ุดุฎุตุช ูุทุงูุนู</h3>
      <p id="personalityInfo" style="font-size:11px;color:#444;">
        ุงู ุขุฒููู ุจุฑุง ุชูพโุจูุฏ ุณุจฺฉ ูุทุงูุนู ุดูุงุณุช ุชุง ุจุฑูุงููโูุง ุจุฑ ุงุณุงุณ ุดุฎุตุชุชุงู ุชูุธู ุดููุฏ.
        ูุทูุงู ุจู ูููโ ุณุคุงูุงุช ุจุง ุฏูุช ู ุตุฏุงูุช ูพุงุณุฎ ุจุฏู.
      </p>

      <table class="personality-table table-soft">
        <tr>
          <th>ุณุคุงู</th>
          <th class="personality-scale-header">ฺฉุงููุงู ูุฎุงููู</th>
          <th class="personality-scale-header">ูุฎุงููู</th>
          <th class="personality-scale-header">ูุธุฑ ูุฏุงุฑู</th>
          <th class="personality-scale-header">ููุงููู</th>
          <th class="personality-scale-header">ฺฉุงููุงู ููุงููู</th>
        </tr>

        <!-- ุณุคุงูุงุช ฑ ุชุง ฑถ ุฏููุง ูุซู ูุจู -->
        <!-- ฑ -->
        <tr>
          <td>ฑ. ููุช ุจุฑูุงููโ ุฏูู ุฏุงุฑูุ ุงฺฏุฑ ุญุช ฺฉ ฺฉุงุฑุด ุงูุฌุงู ูุดูุฏุ ุชุง ุขุฎุฑ ุฑูุฒ ูฺฉุฑู ุฏุฑฺฏุฑ ูโูุงูุฏ.</td>
          <td><input type="radio" name="q1" value="1"></td>
          <td><input type="radio" name="q1" value="2"></td>
          <td><input type="radio" name="q1" value="3"></td>
          <td><input type="radio" name="q1" value="4"></td>
          <td><input type="radio" name="q1" value="5"></td>
        </tr>

        <!-- ฒ -->
        <tr>
          <td>ฒ. ุงฺฏุฑ ฺฉ ุฑูุฒ ุจุฑูุงููโุงู ุฎุฑุงุจ ุดูุฏุ ูุนูููุงู ูโฺฏูู ยซุจโุฎุงูุ ุงุฒ ูุฑุฏุง ุฌุฏ ุดุฑูุน ูโฺฉููยป.</td>
          <td><input type="radio" name="q2" value="1"></td>
          <td><input type="radio" name="q2" value="2"></td>
          <td><input type="radio" name="q2" value="3"></td>
          <td><input type="radio" name="q2" value="4"></td>
          <td><input type="radio" name="q2" value="5"></td>
        </tr>

        <!-- ณ -->
        <tr>
          <td>ณ. ุชุฑุฌุญ ูโุฏูู ูุฑ ุฑูุฒ ฺฉู ูพุด ุจุฑูู ุชุง ุงูฺฉู ููู ฺุฒ ุฑุง ุจฺฏุฐุงุฑู ุจุฑุง ุฑูุฒูุง ุขุฎุฑ.</td>
          <td><input type="radio" name="q3" value="1"></td>
          <td><input type="radio" name="q3" value="2"></td>
          <td><input type="radio" name="q3" value="3"></td>
          <td><input type="radio" name="q3" value="4"></td>
          <td><input type="radio" name="q3" value="5"></td>
        </tr>

        <!-- ด -->
        <tr>
          <td>ด. ูุนูููุงู ุจุฎุด ุฒุงุฏ ุงุฒ ุฏุฑุณโูุงู ุฑุง ูุฒุฏฺฉ ุขุฒููู ุง ุงูุชุญุงู ุงูุฌุงู ูโุฏูู.</td>
          <td><input type="radio" name="q4" value="1"></td>
          <td><input type="radio" name="q4" value="2"></td>
          <td><input type="radio" name="q4" value="3"></td>
          <td><input type="radio" name="q4" value="4"></td>
          <td><input type="radio" name="q4" value="5"></td>
        </tr>

        <!-- ต -->
        <tr>
          <td>ต. ุงฺฏุฑ ฺฉ ูุจุญุซ ุฑุง ฺฉุงูู ู ุจโููุต ูุจูู/ูุฒููุ ุญุณ ูโฺฉูู ุงุตูุงู ุขู ูุจุญุซ ุฑุง ุจูุฏ ูุณุชู.</td>
          <td><input type="radio" name="q5" value="1"></td>
          <td><input type="radio" name="q5" value="2"></td>
          <td><input type="radio" name="q5" value="3"></td>
          <td><input type="radio" name="q5" value="4"></td>
          <td><input type="radio" name="q5" value="5"></td>
        </tr>

        <!-- ถ -->
        <tr>
          <td>ถ. ุดุฑูุน ฺฉุฑุฏู ุจุฑุงู ุณุฎุช ุงุณุชุ ุงูุง ููุช ุดุฑูุน ฺฉููุ ูุนูููุงู ุฌุฏ ู ูุชูุฑฺฉุฒ ุฌูู ูโุฑูู.</td>
          <td><input type="radio" name="q6" value="1"></td>
          <td><input type="radio" name="q6" value="2"></td>
          <td><input type="radio" name="q6" value="3"></td>
          <td><input type="radio" name="q6" value="4"></td>
          <td><input type="radio" name="q6" value="5"></td>
        </tr>

        <!-- ท -->
        <tr>
          <td>ท. ุฏูุณุช ุฏุงุฑู ุญุฌู ุจุฑูุงููโุงู ุทูุฑ ุจุงุดุฏ ฺฉู ุจุง ุฎุงู ุฑุงุญุช ุจุชูุงูู ุฑูุฒุงูู ุงูุฌุงูุด ุฏููุ ูู ูุดุฑุฏู ู ุงุณุชุฑุณ.</td>
          <td><input type="radio" name="q7" value="1"></td>
          <td><input type="radio" name="q7" value="2"></td>
          <td><input type="radio" name="q7" value="3"></td>
          <td><input type="radio" name="q7" value="4"></td>
          <td><input type="radio" name="q7" value="5"></td>
        </tr>

        <!-- ธ -->
        <tr>
          <td>ธ. ุจุงุฑูุง ุดุฏู ุจุฑูุงููโุฑุฒ ุนุงู ุฏุงุดุชู ุจุงุดูุ ุงูุง ูุณุท ฺฉุงุฑ ุจุฒูู ุฒุฑุด ู ุจฺฏูู ยซุญูุตูู ูุฏุงุฑูยป.</td>
          <td><input type="radio" name="q8" value="1"></td>
          <td><input type="radio" name="q8" value="2"></td>
          <td><input type="radio" name="q8" value="3"></td>
          <td><input type="radio" name="q8" value="4"></td>
          <td><input type="radio" name="q8" value="5"></td>
        </tr>

        <!-- น -->
        <tr>
          <td>น. ุงุฒ ุฌูุน ุดุฏู ุนูุจโูุงูุฏฺฏโูุง ุฎู ูโุชุฑุณู ู ุฏูุณุช ุฏุงุฑู ุขูโูุง ุฑุง ูุฑฺู ุฒูุฏุชุฑ ุตูุฑ ฺฉูู.</td>
          <td><input type="radio" name="q9" value="1"></td>
          <td><input type="radio" name="q9" value="2"></td>
          <td><input type="radio" name="q9" value="3"></td>
          <td><input type="radio" name="q9" value="4"></td>
          <td><input type="radio" name="q9" value="5"></td>
        </tr>

        <!-- ฑฐ -->
        <tr>
          <td>ฑฐ. ูุนูููุงู ุฏุฑ ุฑูุฒูุง ุขุฎุฑ ูุจู ุงุฒ ุขุฒูููุ ุจุดุชุฑ ุงุฒ ุฑูุฒูุง ุนุงุฏ ุชูุงุด ูโฺฉูู.</td>
          <td><input type="radio" name="q10" value="1"></td>
          <td><input type="radio" name="q10" value="2"></td>
          <td><input type="radio" name="q10" value="3"></td>
          <td><input type="radio" name="q10" value="4"></td>
          <td><input type="radio" name="q10" value="5"></td>
        </tr>

        <!-- ฑฑ -->
        <tr>
          <td>ฑฑ. ุงฺฏุฑ ุจุฑูุงูู ุฎู ูุดุฑุฏู ุจุงุดุฏุ ุงุญุชูุงู ุงูโฺฉู ุฑูุงุด ฺฉูู ุฒุงุฏ ุงุณุช.</td>
          <td><input type="radio" name="q11" value="1"></td>
          <td><input type="radio" name="q11" value="2"></td>
          <td><input type="radio" name="q11" value="3"></td>
          <td><input type="radio" name="q11" value="4"></td>
          <td><input type="radio" name="q11" value="5"></td>
        </tr>

        <!-- ฑฒ -->
        <tr>
          <td>ฑฒ. ูุนูููุงู ุชุฑุฌุญ ูโุฏูู ุงูู ุนูุจโูุงูุฏฺฏโูุงู ุฑุง ุฌูุน ฺฉูู ุจุนุฏ ุณุฑุงุบ ูพุดุฑู ุจุฑูู.</td>
          <td><input type="radio" name="q12" value="1"></td>
          <td><input type="radio" name="q12" value="2"></td>
          <td><input type="radio" name="q12" value="3"></td>
          <td><input type="radio" name="q12" value="4"></td>
          <td><input type="radio" name="q12" value="5"></td>
        </tr>

        <!-- ฑณ -->
        <tr>
          <td>ฑณ. ุงูู ยซุงุฒ ููู ุงูุฑูุฒ ฺฉ ููุฏุงุฑ ุดุฑูุน ฺฉููยป ูุณุชูุ ุญุช ุงฺฏุฑ ุญุณ ฺฉูู ฺฉุงูู ุขูุงุฏู ูุณุชู.</td>
          <td><input type="radio" name="q13" value="1"></td>
          <td><input type="radio" name="q13" value="2"></td>
          <td><input type="radio" name="q13" value="3"></td>
          <td><input type="radio" name="q13" value="4"></td>
          <td><input type="radio" name="q13" value="5"></td>
        </tr>

        <!-- ฑด -->
        <tr>
          <td>ฑด. ููุช ุงุณุชุฑุณ ูโฺฏุฑูุ ุชูุงู ุฏุงุฑู ุจุนุถ ฺฉุงุฑูุง ุฑุง ู ุนูุจ ุจูุฏุงุฒู.</td>
          <td><input type="radio" name="q14" value="1"></td>
          <td><input type="radio" name="q14" value="2"></td>
          <td><input type="radio" name="q14" value="3"></td>
          <td><input type="radio" name="q14" value="4"></td>
          <td><input type="radio" name="q14" value="5"></td>
        </tr>

        <!-- ฑต -->
        <tr>
          <td>ฑต. ุชุฑุฌุญ ูโุฏูู ุจูโุฌุง ุฌูุน ฺฉุฑุฏู ฺฉุงุฑูุงุ ูุฑ ุฑูุฒ ููุฏุงุฑ ูุดุฎุต ฺฉุงุฑ ุซุงุจุช ุฏุงุดุชู ุจุงุดู.</td>
          <td><input type="radio" name="q15" value="1"></td>
          <td><input type="radio" name="q15" value="2"></td>
          <td><input type="radio" name="q15" value="3"></td>
          <td><input type="radio" name="q15" value="4"></td>
          <td><input type="radio" name="q15" value="5"></td>
        </tr>

        <!-- ฑถ -->
        <tr>
          <td>ฑถ. ููุช ูุดุงุฑ ุงูุชุญุงู ูุฒุฏฺฉ ูโุดูุฏุ ุชุงุฒู ุญุณ ูโฺฉูู ุงูฺฏุฒูโ ุงุตูโุงู ุฑูุดู ุดุฏู.</td>
          <td><input type="radio" name="q16" value="1"></td>
          <td><input type="radio" name="q16" value="2"></td>
          <td><input type="radio" name="q16" value="3"></td>
          <td><input type="radio" name="q16" value="4"></td>
          <td><input type="radio" name="q16" value="5"></td>
        </tr>
      </table>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" onclick="computePersonality()">ูุญุงุณุจู ุชูพ</button>
        <button class="btn" id="savePersonalityBtn" onclick="savePersonality()" disabled>ุซุจุช ุชูพ ุฏุฑ ุญุณุงุจ ูู</button>
      </div>
      <div id="personalityResult" style="font-size:12px;color:#333;margin-top:8px;"></div>
    </section>
  </div>

  <!-- ุชุจ ุจุฑูุงููโุฑุฒ -->
  <div id="plannerTab" class="hidden">

    <!-- ฐ. ููุน ุจุฑูุงูู -->
    <section>
      <h3>ฐ. ุงูุชุฎุงุจ ููุน ุจุฑูุงูู</h3>
      <p style="font-size:11px;color:#444">
        ๐น <b>ุจุฑูุงูู ุนุงุฏ:</b> ุจุฏูู ุงุณุชูุงุฏู ุงุฒ ุชูพ ุดุฎุตุชุ ุงูฺฏูุฑุชู ูพุงู ู ฺฉููุงุฎุช.<br>
        ๐น <b>ุจุฑูุงูู ุจุฑ ุงุณุงุณ ุชูพ ุดุฎุตุช:</b> ุงุฒ ุชูพ ุซุจุชโุดุฏู ุฏุฑ ุขุฒููู ุงุณุชูุงุฏู ูโฺฉูุฏ
        (ูุณูุงุณุ ูพุฑุชูุงุดโูุฑุงุฑุ ุขูุณุชูโูพูุณุชูุ ุฏูููโููุฏ) ู ุฑูฺฏ ู ุฑุชู ุฎูุฏ ุงูพ ูู ุจุง ุชูพุช ููุงููฺฏ ูโุดูุฏ.<br>
        ๐น ฺฏุฒููโ ยซููุด ูุตููุนยป ุฑุง ุจุนุฏุงู ฺฉุงูู ูโฺฉูู.
      </p>
      <label>ููุน ุจุฑูุงูู:</label>
      <select id="planMode">
        <option value="normal">ุจุฑูุงูู ุนุงุฏ</option>
        <option value="personality">ุจุฑูุงูู ุจุฑ ุงุณุงุณ ุชูพ ุดุฎุตุช</option>
        <option value="ai" disabled>ุจุฑูุงูู ุจุฑ ุงุณุงุณ ููุด ูุตููุน (ุจู ุฒูุฏ)</option>
      </select>
    </section>

    <!-- ฑ. ุงุทูุงุนุงุช ูพุงู -->
    <section>
      <h3>ฑ. ุงุทูุงุนุงุช ูพุงู ุฏุงูุดโุขููุฒ</h3>
      <p style="font-size:11px;color:#b30000;">ูู ููุฏูุง ุงู ุจุฎุด ุงุฌุจุงุฑ ูุณุชูุฏ.</p>
      <div class="row-flex">
        <div>
          <label>ูุงู</label><br>
          <input id="fname" type="text">
        </div>
        <div>
          <label>ูุงู ุฎุงููุงุฏฺฏ</label><br>
          <input id="lname" type="text">
        </div>
        <div>
          <label>ุดูุงุฑู ููุจุงู</label><br>
          <input id="phone" type="text" placeholder="ูุซูุงู 09123456789">
        </div>
        <div>
          <label>ุดูุฑ</label><br>
          <input id="city" type="text">
        </div>
        <div>
          <label>ูุงู ูุฏุฑุณู</label><br>
          <input id="school" type="text">
        </div>
        <div>
          <label>ูพุงู ุชุญุตู</label><br>
          <select id="grade">
            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
            <option>ุฏูู</option>
            <option>ุงุฒุฏูู</option>
            <option>ุฏูุงุฒุฏูู</option>
          </select>
        </div>
        <div>
          <label>ุฑุดุชู ุชุญุตู</label><br>
          <select id="major">
            <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
            <option>ุชุฌุฑุจ</option>
            <option>ุฑุงุถ</option>
            <option>ุงูุณุงู</option>
          </select>
        </div>
      </div>
    </section>

    <!-- ฒ. ุณุงุนุงุช ูุทุงูุนู ฺฉู -->
    <section>
      <h3>ฒ. ุณุงุนุงุช ูุทุงูุนู ฺฉู</h3>
      <div class="row-flex">
        <div>
          <label>ุณุงุนุช ูุทุงูุนู ุฏุฑ ุฑูุฒ ุณูุฏ (ุจุฏูู ูุฏุฑุณู ู ฺฉูุงุณ)</label><br>
          <input id="whiteDay" type="number" step="0.5" min="0" max="15" value="8">
        </div>
        <div>
          <label>ุณุงุนุช ูุทุงูุนู ุฏุฑ ุฑูุฒ ูุฏุฑุณู (ุจุฏูู ฺฉูุงุณ ุจุฑูู)</label><br>
          <input id="schoolDay" type="number" step="0.5" min="0" max="10" value="4">
        </div>
      </div>
    </section>

    <!-- ณ. ูุถุนุช ูุฏุฑุณู -->
    <section>
      <h3>ณ. ูุถุนุช ูุฏุฑุณู ุฏุฑ ฑด ุฑูุฒ ุขูุฏู</h3>
      <table class="sub-table table-soft">
        <tr><th>ุฑูุฒ</th><th>ูโุฑูุฏ ูุฏุฑุณูุ</th></tr>
        <tbody id="attendanceBody"></tbody>
      </table>
    </section>

    <!-- ด. ฺฉูุงุณโูุง ุขููุงู -->
    <section>
      <h3>ด. ฺฉูุงุณโูุง ุขููุงู</h3>
      <p style="font-size:11px;color:#444">
        ฺฉูุงุณโูุง ุขููุงู ูู ุจูโุตูุฑุช ุชุณฺฉ ุฏุฑ ุจุฑูุงูู ูโุขูุฏุ ุงฺฏุฑ ุชฺฉ ูุฎูุฑุ ุฏุฑ ุจุฑูุงูู ุจุนุฏ ุจูโุนููุงู ููู ุขููุงู ุนูุจโุงูุชุงุฏู ุญุณุงุจ ูโุดููุฏ.
      </p>
      <button class="small-btn" onclick="addClassRow()">โ ุงูุฒูุฏู ฺฉูุงุณ</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฑูุฒ</th><th>ุฏุฑุณ</th><th>ูุฏุช (ุณุงุนุช)</th><th>ูุตู</th><th>ุญุฐู</th>
        </tr>
        <tbody id="classesBody"></tbody>
      </table>
    </section>

    <!-- ต. ุขุฒูููโูุง -->
    <section>
      <h3>ต. ุขุฒูููโูุง ุฏุฑ ฑด ุฑูุฒ ุขูุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุจุฑุง ูุฑ ุขุฒูููุ ูโุชูุงู ฺูุฏ ูุตู ู ฺูุฏ ููุจุน ุชุณุช ุชุนุฑู ฺฉู ู ุงฺฏุฑ ุจุฎูุงู ุชุญูู ุขุฒููู ูู ุงูุฌุงู ุดูุฏ.
      </p>
      <button class="small-btn" onclick="addExamCard()">โ ุงูุฒูุฏู ุขุฒููู</button>
      <div id="examsCards"></div>
    </section>

    <!-- ถ. ูููโูุง ุขููุงู -->
    <section>
      <h3>ถ. ูููโูุง ุขููุงู ุนูุจโุงูุชุงุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุงูุฌุง ุชุฑฺฉุจ ุนูุจโูุงูุฏฺฏโูุง ูุฏู + ููุงุฑุฏ ุงุณุช ฺฉู ุฎูุฏุช ุงุถุงูู ูโฺฉู. ูุจู ุงุฒ ุณุงุฎุช ุจุฑูุงููุ ูโุชูุงู ฺุฒูุง ุฑุง ฺฉู ุฏฺฏุฑ ุนูุจโูุงูุฏู ูุณุช ุญุฐู ฺฉู.
      </p>
      <button class="small-btn" onclick="addOfflineRow()">โ ุงูุฒูุฏู ููู ุขููุงู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฏุฑุณ</th><th>ูุตู</th><th>ูุฏุช (ุณุงุนุช)</th><th>ุญุฐู</th>
        </tr>
        <tbody id="offlineBody"></tbody>
      </table>
    </section>

    <!-- ท. ุชุณุชโูุง ุนูุจโูุงูุฏู -->
    <section>
      <h3>ท. ุชุณุชโูุง ุนูุจโูุงูุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุงู ูู ุชุฑฺฉุจ ุชุณุชโูุง ุงุณุช ฺฉู ุงุฒ ุจุฑูุงููโูุง ูุจู ุฌุง ูุงูุฏู + ุชุณุชโูุง ฺฉู ุฎูุฏุช ุจู ุนููุงู ุนูุจโูุงูุฏฺฏ ุชุนุฑู ูโฺฉู.
      </p>
      <button class="small-btn" onclick="addLagRow()">โ ุงูุฒูุฏู ุชุณุช ุนูุจโูุงูุฏู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฏุฑุณ</th><th>ูุตู</th><th>ููุจุน ุชุณุช</th><th>ุชุนุฏุงุฏ ุชุณุช</th><th>ุญุฐู</th>
        </tr>
        <tbody id="lagBody"></tbody>
      </table>
    </section>

    <!-- ธ. ูพุดุฑู -->
    <section>
      <h3>ธ. ูพุดุฑู ูพุดููุงุฏ</h3>
      <button class="small-btn" onclick="addProgRow()">โ ุงูุฒูุฏู ูุฏู ูพุดุฑู</button>
      <table class="sub-table table-soft">
        <tr>
          <th>ุฏุฑุณ</th><th>ูุตู</th><th>ููุจุน ุชุณุช</th><th>ุชุนุฏุงุฏ ุชุณุช</th><th>ุญุฐู</th>
        </tr>
        <tbody id="progBody"></tbody>
      </table>
    </section>

    <!-- น. ุชุฑุงุฒูุง -->
    <section>
      <h3>น. ุชุฑุงุฒ/ุฏุฑุตุฏ ูุงูฺฏู ุฏุฑูุณ ุงุฎุชุตุงุต</h3>
      <p style="font-size:11px;color:#444">ุจุฑุง ุชุดุฎุต ููุทู ููุช ู ุถุนู.</p>
      <div class="row-flex">
        <div>
          <label>ุชุฑุงุฒ ุฒุณุช</label><br>
          <input id="rankBio" type="number" step="10">
        </div>
        <div>
          <label>ุชุฑุงุฒ ุดู</label><br>
          <input id="rankChem" type="number" step="10">
        </div>
        <div>
          <label>ุชุฑุงุฒ ูุฒฺฉ</label><br>
          <input id="rankPhys" type="number" step="10">
        </div>
        <div>
          <label>ุชุฑุงุฒ ุฑุงุถ</label><br>
          <input id="rankMath" type="number" step="10">
        </div>
      </div>
    </section>

    <!-- ฑฐ. ุณุงุฎุช ุจุฑูุงูู -->
    <section>
      <h3>ฑฐ. ุณุงุฎุช ุจุฑูุงูู</h3>
      <button class="btn" onclick="onMakePlanClicked()">โ ุณุงุฎุช ุจุฑูุงูู ฑด ุฑูุฒู ู ุฐุฎุฑู ุฏุฑ Supabase</button>
      <span id="statusMsg" style="font-size:11px;color:#b30000;margin-right:10px;"></span>
    </section>

    <!-- ููุงุด ุจุฑูุงูู -->
    <section>
      <h3>ุจุฑูุงูู ฑด ุฑูุฒู</h3>
      <div id="coverageSummary"></div>
      <table id="scheduleTable" class="table-soft"></table>
    </section>

  </div>

  <!-- ุชุจ ุจุฑูุงููโูุง ูู (ุฏุงูุดโุขููุฒ) -->
  <div id="studentTab" class="hidden">
    <section>
      <h3>ุจุฑูุงููโูุง ูู</h3>
      <p style="font-size:11px;color:#444">
        ุฑู ูุฑ ุจุฑูุงูู ฺฉูฺฉ ฺฉู ุชุง ุชุณฺฉโูุง ููุงู ุจุฑูุงูู ุฑุง ุจุจู ู ุชฺฉ ุจุฒู.
      </p>
      <table id="studentPlansTable" class="sub-table table-soft"></table>
    </section>

    <section>
      <h3>ุชุณฺฉโูุง ุจุฑูุงูู ุงูุชุฎุงุจโุดุฏู</h3>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap;">
        <p id="studentTasksInfo" style="font-size:11px;color:#444;margin:0;"></p>
        <div style="font-size:11px;">
          ููุชุฑ ุฑูุฒ:
          <select id="studentDayFilter" onchange="renderStudentTasksFiltered()">
            <option value="all">ููู ุฑูุฒูุง</option>
            <option value="1">ุฑูุฒ ฑ</option>
            <option value="2">ุฑูุฒ ฒ</option>
            <option value="3">ุฑูุฒ ณ</option>
            <option value="4">ุฑูุฒ ด</option>
            <option value="5">ุฑูุฒ ต</option>
            <option value="6">ุฑูุฒ ถ</option>
            <option value="7">ุฑูุฒ ท</option>
            <option value="8">ุฑูุฒ ธ</option>
            <option value="9">ุฑูุฒ น</option>
            <option value="10">ุฑูุฒ ฑฐ</option>
            <option value="11">ุฑูุฒ ฑฑ</option>
            <option value="12">ุฑูุฒ ฑฒ</option>
            <option value="13">ุฑูุฒ ฑณ</option>
            <option value="14">ุฑูุฒ ฑด</option>
          </select>
          <button class="small-btn" onclick="showInstantReport()">๐ ฺฏุฒุงุฑุด ูุญุธูโุง</button>
        </div>
      </div>
      <table id="studentTasksTable" class="sub-table table-soft"></table>
      <div id="instantReportBox" style="font-size:11px;color:#333;margin-top:6px;"></div>
    </section>
  </div>

  <!-- ุชุจ ุนูุจโูุงูุฏฺฏโูุง -->
  <div id="backlogTab" class="hidden">
    <section>
      <h3>๐ฆ ุนูุจโูุงูุฏฺฏโูุง ุซุจุช ุดุฏู</h3>
      <p style="font-size:11px;color:#444">
        ุงูโูุง ุชุณฺฉโูุง ูุณุชูุฏ ฺฉู ุชุงุฑุฎโุดุงู ฺฏุฐุดุชู ู ฺฉุงูู ุงูุฌุงู ูุดุฏูโุงูุฏ (ุงูุฌุงูโูุดุฏู ุง ูุงูุต).
        ุจุฑุง ุจุฑูุงูู ุจุนุฏุ ุงุฒ ุงูโูุง ุจู ุนููุงู ุนูุจโูุงูุฏฺฏ ุงุณุชูุงุฏู ูโุดูุฏ.
      </p>
      <button class="small-btn" onclick="loadBacklogView()">๐ ุจูโุฑูุฒุฑุณุงู ูุณุช ุนูุจโูุงูุฏฺฏ</button>
      <table id="backlogTable" class="sub-table table-soft"></table>
    </section>
  </div>

  <!-- ุชุจ ูพูู ุงุฏูู -->
  <div id="adminTab" class="hidden">
    <section>
      <h3>ูุณุช ุจุฑูุงููโูุง ุฏุงูุดโุขููุฒุงู</h3>
      <table id="adminPlansTable" class="sub-table table-soft"></table>
    </section>
    <section>
      <h3>ุชุณฺฉโูุง ุจุฑูุงูู ุงูุชุฎุงุจโุดุฏู</h3>
      <p id="adminPlanTitle" style="font-size:11px;color:#444;"></p>
      <table id="adminTasksTable" class="sub-table table-soft"></table>

      <div style="margin-top:10px;">
        <h4>โ ุงูุฒูุฏู ุชุณฺฉ ุฏุณุช ุจู ุงู ุจุฑูุงูู</h4>
        <label>ุฑูุฒ (ฑ ุชุง ฑด): </label>
        <input id="adminNewTaskDay" type="number" min="1" max="14" value="1"><br>
        <label>ูุชู ุชุณฺฉ:</label><br>
        <textarea id="adminNewTaskText" style="width:100%;height:60px;"></textarea><br>
        <button class="small-btn" onclick="adminAddTask()">ุงูุฒูุฏู ุชุณฺฉ</button>
      </div>
    </section>
  </div>

</div>

<!-- Supabase + JS ููุงู ุงูฺฏูุฑุชู ูุจู + ฺูุฏ ุฎุท ุจุฑุง ุชู ุดุฎุตุช  -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ====== ุชูุธูุงุช Supabase ======
var supabaseUrl = "https://uregjguhgbzwgwlzqbef.supabase.co";
var supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyZWdqZ3VoZ2J6d2d3bHpxYmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMTE5OTQsImV4cCI6MjA4MjY4Nzk5NH0.Gsqi4NKf4SssTVzTdC4AvIJCoynC31prHK_Gr7fZCzI";
var supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ุงูู ุงุฏูู
var ADMIN_EMAILS = ["pouri007008009@gmail.com"];

// ูุถุนุชโูุง ุชุณฺฉ
var TASK_STATUS = {
  TODO: "todo",
  PARTIAL: "partial",
  DONE: "done"
};

// ุชูพ ุดุฎุตุช ูุนู ฺฉุงุฑุจุฑ (ุงุฒ ูพุฑููุงู)
var currentPersonalityType = null;      // "obsessive" | "runner" | "steady" | "lastminute"
var currentPersonalityUpdated = null;   // "YYYY-MM-DD"
var computedPersonalityType = null;

var PERSONALITY_LABELS = {
  obsessive: "ูุณูุงุณ ุฏูู",
  runner: "ูพุฑุชูุงุด ุงูุง ูุฑุงุฑ",
  steady: "ุขูุณุชู ู ูพูุณุชู",
  lastminute: "ููุฑูุงู ุฏููู ููุฏ"
};

var PERSONALITY_DESCRIPTIONS = {
  obsessive: "ุชูุฑฺฉุฒ ุจุงูุง ุฑู ฺฉุงููโฺฉุฑุฏู ฺฉุงุฑูุงุ ุญุณุงุณ ูุณุจุช ุจู ุนูุจโูุงูุฏฺฏ ู ููุต ุฏุฑ ุจุฑูุงูู.",
  runner: "ุชูุงุดโฺฏุฑ ุงูุง ูุฑูุงุฑ ุงุฒ ุดุฑูุนุ ูุงุฒ ุจู ูุฑูุฑูุง ฺฉูุชุงู ู ุงูฺฏุฒูโ ูุฏุงูู.",
  steady: "ุฑุชู ุซุงุจุชุ ุฏูุณุชโุฏุงุฑ ุจุฑูุงููโ ฺฉููุงุฎุช ู ุจุฏูู ููุณุงู ุดุฏุฏ.",
  lastminute: "ุงูุฑฺ ุงุตู ูุฒุฏฺฉ ุฏุฏูุงู ู ุขุฒููู ุฑูุดู ูโุดูุฏุ ุญุฌู ุจุดุชุฑ ุฏุฑ ููุชูโ ุฏูู ุจูุชุฑ ุฌูุงุจ ูโุฏูุฏ."
};

// ุงูโูุงุฑู ุจุฑุง ุฑูุฏุฑ ูุฌุฏุฏ ุงุณุชูุงุฏู ูโฺฉูู
var currentStudentPlanId = null;
var currentStudentPlanDate = null;
var currentStudentTasks = []; // {id, day, task_text, status, leftover}
var backlogPrefilled = false;
var currentAdminPlanId = null;
var currentAdminStudentName = "";
var currentAdminProgramDate = "";

// ==== ููุดู ุชุฃุซุฑ ุณุคุงูุงุช ุขุฒููู ุจุฑ ุชูพโูุง ====
var personalityConfig = {
  q1: {obsessive:2},
  q2: {runner:2},
  q3: {steady:2},
  q4: {lastminute:2},
  q5: {obsessive:2},
  q6: {runner:1, steady:1},
  q7: {steady:2},
  q8: {runner:2},
  q9: {obsessive:2},
  q10:{lastminute:2},
  q11:{steady:1, runner:1},
  q12:{obsessive:1, steady:1},
  q13:{steady:2},
  q14:{runner:1,lastminute:1},
  q15:{steady:2},
  q16:{lastminute:2}
};

// ===== ุชู ุดุฎุตุช (ุฌุฏุฏ) =====
function applyPersonalityTheme(type){
  var body = document.body;
  body.classList.remove("theme-steady","theme-obsessive","theme-runner","theme-lastminute");
  if(type === "obsessive") body.classList.add("theme-obsessive");
  else if(type === "runner") body.classList.add("theme-runner");
  else if(type === "lastminute") body.classList.add("theme-lastminute");
  else body.classList.add("theme-steady");
}

// ===== ุชุจโูุง =====
function showTab(tabId){
  ["personalityTab","plannerTab","studentTab","backlogTab","adminTab"].forEach(function(id){
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById(tabId).classList.remove("hidden");

  // ุญุงูุช ูุนุงู ุฑู ุฏฺฉููโูุง
  var btns = document.querySelectorAll(".tab-btn");
  btns.forEach(function(b){ b.classList.remove("active"); });
  if(tabId === "personalityTab") document.getElementById("personalityTabBtn").classList.add("active");
  if(tabId === "plannerTab") document.getElementById("plannerTabBtn").classList.add("active");
  if(tabId === "studentTab") document.getElementById("studentTabBtn").classList.add("active");
  if(tabId === "backlogTab") document.getElementById("backlogTabBtn").classList.add("active");
  if(tabId === "adminTab") document.getElementById("adminTabBtn").classList.add("active");
}

// ===== ูุงฺฏู =====
async function handleLogin(){
  var email = document.getElementById("loginEmail").value.trim();
  var pass  = document.getElementById("loginPassword").value;
  var status= document.getElementById("loginStatus");
  status.style.color="#b30000";
  status.textContent="";

  if(!email){
    status.textContent="ุงูู ุฑุง ูุงุฑุฏ ฺฉู.";
    return;
  }
  if(!pass || pass.length<6){
    status.textContent="ูพุณูุฑุฏ ุจุงุฏ ุญุฏุงูู ถ ฺฉุงุฑุงฺฉุชุฑ ุจุงุดุฏ.";
    return;
  }

  var res = await supabase.auth.signInWithPassword({email:email,password:pass});
  if(res.error){
    status.textContent="ุฎุทุง ุฏุฑ ูุฑูุฏ: "+res.error.message;
    return;
  }

  document.getElementById("loginContainer").classList.add("hidden");
  document.getElementById("appContainer").classList.remove("hidden");
  document.getElementById("currentUserEmail").textContent = "ฺฉุงุฑุจุฑ: "+email;

  if(ADMIN_EMAILS.indexOf(email)>=0){
    document.getElementById("adminTabBtn").style.display="inline-flex";
  }

  // ูพุฑููุงู ุดุฎุตุช ุฑุง ููุฏ ฺฉู
  await loadPersonalityProfile(email);

  showTab("personalityTab");
  loadStudentPlans();
  if(ADMIN_EMAILS.indexOf(email)>=0){
    loadAdminPlans();
  }
  prefillBacklogFromAllPlans();
  loadBacklogView();
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

// ===== ุซุงุจุชโูุง ู ุชูุงุจุน ุนููู =====
var SOURCE_MIN_PER_QUESTION = {
  "ุฎู ุณุจุฒ": 1.67,
  "ูุฑุฏุจุงู": 2.25,
  "ูุจุชฺฉุฑุงู": 2.0,
  "ูุดุฑุงูฺฏู": 1.67,
  "ุณู ุณุทุญ": 1.67,
  "QB": 2.0,
  "ููุฌ ุขุฒููู": 1.67,
  "ูุตู ุขุฒููู": 1.67,
  "IQ": 2.0,
  "ูฺฉุฑู ฺฏุงุฌ": 1.67,
  "ุชุชุงููู": 2.25
};

function studyRatio(subject){
  if(subject==="ุฒุณุช")  return 0.40;
  if(subject==="ุดู")  return 0.30;
  if(subject==="ูุฒฺฉ") return 0.20;
  if(subject==="ุฑุงุถ") return 0.20;
  return 0;
}

function detectStrongWeak(stats){
  if(!stats) return {strong:"ุฒุณุช",weak:"ุฑุงุถ"};
  var arr=[];
  if(stats.biology && stats.biology.avgRank>0)   arr.push({key:"ุฒุณุช",  rank:stats.biology.avgRank});
  if(stats.chemistry && stats.chemistry.avgRank>0) arr.push({key:"ุดู",  rank:stats.chemistry.avgRank});
  if(stats.physics && stats.physics.avgRank>0)   arr.push({key:"ูุฒฺฉ", rank:stats.physics.avgRank});
  if(stats.math && stats.math.avgRank>0)      arr.push({key:"ุฑุงุถ", rank:stats.math.avgRank});
  if(!arr.length) return {strong:"ุฒุณุช",weak:"ุฑุงุถ"};
  arr.sort(function(a,b){return b.rank-a.rank;});
  return {strong:arr[0].key,weak:arr[arr.length-1].key};
}

function parseDurationToHours(str){
  if(!str) return 0;
  str=String(str).trim();
  if(str.indexOf("min")>-1){
    var m=parseInt(str,10); return m/60;
  }
  if(str.indexOf("h")>-1){
    return parseFloat(str);
  }
  var n=parseFloat(str); return isNaN(n)?0:n;
}

function formatHoursWithMinutes(h){
  h = Math.max(0, h);
  var hrsFloat = h;
  var hrs = Math.floor(hrsFloat);
  var mins = Math.round((hrsFloat - hrs)*60);
  if(mins % 5 !== 0){
    mins = mins + (5 - (mins % 5));
  }
  if(mins === 60){
    hrs += 1;
    mins = 0;
  }
  var hText = hrsFloat.toFixed(1);
  if(hText.endsWith(".0")) hText = hText.slice(0,-2);
  var totalMin = hrs*60 + mins;
  if(hrs>0 || mins>0){
    return hText+' ุณุงุนุช ('+totalMin+' ุฏููู)';
  }else{
    return '0 ุฏููู';
  }
}

// ุชุนุฏุงุฏ ูุตูโูุง
var SUBJECT_CHAPTER_COUNT = {
  "ุฒุณุช": 8,
  "ุดู": 4,
  "ูุฒฺฉ": 4,
  "ุฑุงุถ": 7,
  "ุงุฏุจุงุช": 18,
  "ุฏู": 12,
  "ุนุฑุจ": 8,
  "ุฒุจุงู": 4
};

function getChapterOptionsForSubject(subj){
  var n = SUBJECT_CHAPTER_COUNT[subj] || 10;
  var html = "";
  for(var i=1;i<=n;i++){
    html += '<option value="ูุตู '+i+'">ูุตู '+i+'</option>';
  }
  return html;
}

function updateTopicOptions(selectEl, topicClass){
  var subj = selectEl.value;
  var row  = selectEl.closest("tr") || selectEl.closest(".exam-card") || selectEl.closest("div");
  var topicSel;
  if(topicClass){
    topicSel = row.querySelector("."+topicClass);
  }else{
    topicSel = row.querySelector("select");
  }
  if(!topicSel) return;
  var prev = topicSel.value;
  topicSel.innerHTML = getChapterOptionsForSubject(subj);
  var exists=false;
  for(var i=0;i<topicSel.options.length;i++){
    if(topicSel.options[i].value===prev){ exists=true; break;}
  }
  if(exists) topicSel.value=prev;
}

// ูุจู ุชุงุฑุฎโูุง ุงุฒ ุฑู program_date
function getDateLabelsFromProgramDate(programDateStr){
  if(!programDateStr) return Array(14).fill(null);
  var parts = programDateStr.split("-");
  var y = parseInt(parts[0],10);
  var m = parseInt(parts[1],10)-1;
  var d = parseInt(parts[2],10);
  var base = new Date(y,m,d);
  var weekdays = ["ฺฉุดูุจู","ุฏูุดูุจู","ุณูโุดูุจู","ฺูุงุฑุดูุจู","ูพูุฌโุดูุจู","ุฌูุนู","ุดูุจู"];
  var labels=[];
  for(var i=1;i<=14;i++){
    var dd = new Date(base);
    dd.setDate(base.getDate()+i);
    var wd = weekdays[dd.getDay()];
    var yy = dd.getFullYear();
    var mm = (dd.getMonth()+1).toString().padStart(2,'0');
    var da = dd.getDate().toString().padStart(2,'0');
    labels.push(wd+" "+yy+"/"+mm+"/"+da);
  }
  return labels;
}

// ===== ุณุงุฎุช ุฌุฏูู ูุถุนุช ูุฏุฑุณู =====
document.addEventListener("DOMContentLoaded", function(){
  applyPersonalityTheme("steady");

  var attBody=document.getElementById("attendanceBody");
  for(var d=1;d<=14;d++){
    var tr=document.createElement("tr");
    tr.innerHTML=
      '<td style="text-align:center">'+d+'</td>'+
      '<td><select class="att-select" data-day="'+d+'">'+
      '<option value="ุจูู">ุจูู (ูุฏุฑุณู ูโุฑูุฏ)</option>'+
      '<option value="ุฎุฑ">ุฎุฑ</option>'+
      '</select></td>';
    attBody.appendChild(tr);
  }

  document.getElementById("examsCards").addEventListener("click",function(e){
    if(e.target.classList.contains("delete-exam-card")){
      var card=e.target.closest(".exam-card");
      if(card) card.remove();
    }
  });
});

// ===== ุงูุฒูุฏู ุฑุฏูโูุง =====
function addClassRow(){
  var tbody=document.getElementById("classesBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><input type="number" class="class-day" min="1" max="14" value="1"></td>'+
    '<td><select class="class-subject" onchange="updateTopicOptions(this, \'class-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
      '<option>ุงุฏุจุงุช</option><option>ุฏู</option><option>ุนุฑุจ</option><option>ุฒุจุงู</option>'+
    '</select></td>'+
    '<td><input type="number" step="0.5" class="class-duration" value="2"></td>'+
    '<td><select class="class-topic"></select></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  var subjSel=tr.querySelector(".class-subject");
  updateTopicOptions(subjSel,"class-topic");
}

function addExamCard(){
  var container=document.getElementById("examsCards");
  var div=document.createElement("div");
  div.className="exam-card";
  div.innerHTML=
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">'+
      '<strong>ุขุฒููู ุฌุฏุฏ</strong>'+
      '<button type="button" class="small-btn del delete-exam-card">ุญุฐู ุขุฒููู</button>'+
    '</div>'+
    'ุฑูุฒ ุขุฒููู: <input type="number" class="exam-day" min="1" max="14" value="14"> '+
    'ุฏุฑุณ: <select class="exam-subject" onchange="refreshExamChapters(this)">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
      '<option>ุงุฏุจุงุช</option><option>ุฏู</option><option>ุนุฑุจ</option><option>ุฒุจุงู</option>'+
    '</select> '+
    'ููุน: <select class="exam-type">'+
      '<option>ุขุฒููู ุขุฒูุงุด</option>'+
      '<option>ุงูุชุญุงู ูุฏุฑุณู</option>'+
      '<option>ุงูุชุญุงู ฺฉูุงุณ ุจุฑูู</option>'+
    '</select> '+
    'ูุฏุช: <select class="exam-duration">'+
      '<option value="30min">ณฐ ุฏููู</option>'+
      '<option value="45min">ดต ุฏููู</option>'+
      '<option value="60min">ฑ ุณุงุนุช</option>'+
      '<option value="90min">ฑ.ต ุณุงุนุช</option>'+
      '<option value="120min">ฒ ุณุงุนุช</option>'+
      '<option value="180min">ณ ุณุงุนุช</option>'+
    '</select>'+
    '<br><br>'+
    'ูุทุงูุนู/ุชุณุช ุฏุฑ ุฎูุฏ ุฑูุฒ ุขุฒููู ูุฌุงุฒ ุจุงุดุฏุ '+
    '<input type="checkbox" class="exam-allow-today" checked> '+
    '๐ ุชุญูู ุขุฒูููุ <input type="checkbox" class="exam-analysis-need"> '+
    'ุงููู ุฑูุฒ ูุฌุงุฒ ุจุฑุง ุชุญูู: <input type="number" class="exam-analysis-start" min="1" max="14" value="14">'+
    '<hr style="margin:6px 0;">'+
    '<div><strong>ูุตูโูุง:</strong> <button type="button" class="small-btn" onclick="addExamChapter(this)">โ ูุตู</button>'+
    '<div class="exam-chapters-box" style="margin-top:4px;"></div></div>'+
    '<hr style="margin:6px 0;">'+
    '<div><strong>ููุงุจุน ุชุณุช:</strong> <button type="button" class="small-btn" onclick="addExamSource(this)">โ ููุจุน ุชุณุช</button>'+
    '<div class="exam-sources-box" style="margin-top:4px;"></div></div>';
  container.appendChild(div);
}

function refreshExamChapters(subjSelect){
  var card=subjSelect.closest(".exam-card");
  var subj=subjSelect.value;
  var boxes=card.querySelectorAll(".exam-chapter");
  for(var i=0;i<boxes.length;i++){
    var sel=boxes[i];
    var prev=sel.value;
    sel.innerHTML=getChapterOptionsForSubject(subj);
    var exists=false;
    for(var j=0;j<sel.options.length;j++){
      if(sel.options[j].value===prev){exists=true;break;}
    }
    if(exists) sel.value=prev;
  }
}

function addExamChapter(btn){
  var box=btn.parentElement.querySelector(".exam-chapters-box");
  var card=btn.closest(".exam-card");
  var subj=card.querySelector(".exam-subject").value;
  var d=document.createElement("div");
  d.innerHTML=
    'ูุตู: <select class="exam-chapter">'+getChapterOptionsForSubject(subj)+'</select> '+
    '<button type="button" class="small-btn del" onclick="this.parentElement.remove()">ุญุฐู</button>';
  box.appendChild(d);
}

function addExamSource(btn){
  var box=btn.parentElement.querySelector(".exam-sources-box");
  var d=document.createElement("div");
  d.innerHTML=
    'ููุจุน: <select class="exam-source">'+
      '<option>ุฎู ุณุจุฒ</option><option>ูุฑุฏุจุงู</option><option>ูุจุชฺฉุฑุงู</option>'+
      '<option>ูุดุฑุงูฺฏู</option><option>ุณู ุณุทุญ</option><option>QB</option>'+
      '<option>ููุฌ ุขุฒููู</option><option>ูุตู ุขุฒููู</option><option>IQ</option>'+
      '<option>ูฺฉุฑู ฺฏุงุฌ</option><option>ุชุชุงููู</option>'+
    '</select> '+
    'ุชุนุฏุงุฏ ุชุณุช: <input type="number" class="exam-count" min="10" step="10" value="100"> '+
    '<button type="button" class="small-btn del" onclick="this.parentElement.remove()">ุญุฐู</button>';
  box.appendChild(d);
}

function addOfflineRow(){
  var tbody=document.getElementById("offlineBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="off-subject" onchange="updateTopicOptions(this, \'off-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
      '<option>ุงุฏุจุงุช</option><option>ุฏู</option><option>ุนุฑุจ</option><option>ุฒุจุงู</option>'+
    '</select></td>'+
    '<td><select class="off-topic"></select></td>'+
    '<td><input type="number" step="0.5" class="off-hours" value="2"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  updateTopicOptions(tr.querySelector(".off-subject"),"off-topic");
}

function addLagRow(){
  var tbody=document.getElementById("lagBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="lag-subject" onchange="updateTopicOptions(this, \'lag-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
    '</select></td>'+
    '<td><select class="lag-topic"></select></td>'+
    '<td><select class="lag-source">'+
      '<option>ุฎู ุณุจุฒ</option><option>ูุฑุฏุจุงู</option><option>ูุจุชฺฉุฑุงู</option>'+
      '<option>ูุดุฑุงูฺฏู</option><option>ุณู ุณุทุญ</option><option>QB</option>'+
      '<option>ููุฌ ุขุฒููู</option><option>ูุตู ุขุฒููู</option><option>IQ</option>'+
      '<option>ูฺฉุฑู ฺฏุงุฌ</option><option>ุชุชุงููู</option>'+
    '</select></td>'+
    '<td><input type="number" class="lag-count" min="10" step="10" value="80"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  updateTopicOptions(tr.querySelector(".lag-subject"),"lag-topic");
}

function addProgRow(){
  var tbody=document.getElementById("progBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="prog-subject" onchange="updateTopicOptions(this, \'prog-topic\')">'+
      '<option>ุฒุณุช</option><option>ุดู</option><option>ูุฒฺฉ</option><option>ุฑุงุถ</option>'+
    '</select></td>'+
    '<td><select class="prog-topic"></select></td>'+
    '<td><select class="prog-source">'+
      '<option>ุฎู ุณุจุฒ</option><option>ูุฑุฏุจุงู</option><option>ูุจุชฺฉุฑุงู</option>'+
      '<option>ูุดุฑุงูฺฏู</option><option>ุณู ุณุทุญ</option><option>QB</option>'+
      '<option>ููุฌ ุขุฒููู</option><option>ูุตู ุขุฒููู</option><option>IQ</option>'+
      '<option>ูฺฉุฑู ฺฏุงุฌ</option><option>ุชุชุงููู</option>'+
    '</select></td>'+
    '<td><input type="number" class="prog-count" min="10" step="10" value="100"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  updateTopicOptions(tr.querySelector(".prog-subject"),"prog-topic");
}

// ===== ุชูุงุจุน ุขุฒููู ุดุฎุตุช =====
function daysBetween(date1, date2){
  try{
    var d1 = new Date(date1);
    var d2 = new Date(date2);
    var diff = d2.getTime() - d1.getTime();
    return Math.floor(diff / (1000*60*60*24));
  }catch(e){
    return 9999;
  }
}

async function loadPersonalityProfile(email){
  currentPersonalityType = null;
  currentPersonalityUpdated = null;
  computedPersonalityType = null;

  var resDiv = document.getElementById("personalityResult");
  var saveBtn = document.getElementById("savePersonalityBtn");
  saveBtn.disabled = true;
  resDiv.textContent = "";

  var res = await supabase
    .from("student_profile")
    .select("personality_type, personality_updated")
    .eq("email", email)
    .limit(1)
    .single()
    .catch(()=>({error:null,data:null}));

  if(res && !res.error && res.data){
    currentPersonalityType = res.data.personality_type || null;
    currentPersonalityUpdated = res.data.personality_updated || null;
  }

  updatePersonalityUI();
}

function updatePersonalityUI(){
  var info = document.getElementById("personalityInfo");
  var saveBtn = document.getElementById("savePersonalityBtn");

  if(!currentPersonalityType){
    info.innerHTML =
      "ูููุฒ ุชูพ ุดุฎุตุช ูุทุงูุนู ุจุฑุงุช ุซุจุช ูุดุฏู ุงุณุช. "+
      "ูุทูุงู ุขุฒููู ุฑุง ฺฉโุจุงุฑ ฺฉุงูู ูพุงุณุฎ ุจุฏู ู ูุชุฌู ุฑุง ุฐุฎุฑู ฺฉู. "+
      "<br>ุจุนุฏ ุงุฒ ุซุจุชุ ุงฺฏุฑ ุฏุฑ ุณุงุฎุช ุจุฑูุงูู ยซุจุฑ ุงุณุงุณ ุชูพ ุดุฎุตุชยป ุฑุง ุงูุชุฎุงุจ ฺฉูุ ุฑู ุงูฺฏูุฑุชู ู ุธุงูุฑ ุงูพ ุงุนูุงู ูโุดูุฏ.";
    saveBtn.disabled = true;
    applyPersonalityTheme("steady");
    return;
  }

  var label = PERSONALITY_LABELS[currentPersonalityType] || currentPersonalityType;
  var txt = "ุชูพ ุซุจุชโุดุฏูโ ูุนู ุดูุง: <b>"+label+"</b>";
  if(currentPersonalityUpdated){
    txt += " (ุชุงุฑุฎ ุซุจุช: "+currentPersonalityUpdated+")";
    var today = new Date().toISOString().slice(0,10);
    var diff = daysBetween(currentPersonalityUpdated, today);
    if(diff < 60){
      txt += "<br>ุงูฺฉุงู ุซุจุช ุชูพ ุฌุฏุฏ ุชุง "+(60-diff)+" ุฑูุฒ ุฏฺฏุฑ ูุนุงู ูโุดูุฏ.";
    }else{
      txt += "<br>ุฏุฑ ุตูุฑุช ูุงุฒ ูโุชูุงู ุฏูุจุงุฑู ุขุฒููู ุจุฏู ู ุชูพ ุฌุฏุฏ ุซุจุช ฺฉู.";
    }
  }
  info.innerHTML = txt;

  applyPersonalityTheme(currentPersonalityType);
}

function computePersonality(){
  var scores = {
    obsessive:0,
    runner:0,
    steady:0,
    lastminute:0
  };

  for(var q=1;q<=16;q++){
    var name = "q"+q;
    var radios = document.getElementsByName(name);
    var val = null;
    for(var i=0;i<radios.length;i++){
      if(radios[i].checked){ val = parseInt(radios[i].value,10); break; }
    }
    if(!val){
      alert("ูุทูุงู ุจู ูููโ ุณุคุงูุงุช ูพุงุณุฎ ุจุฏู. ุณุคุงู "+q+" ุฎุงู ุงุณุช.");
      return;
    }
    var cfg = personalityConfig[name];
    if(!cfg) continue;
    var baseScore = val-1; // ฐ ุชุง ด
    for(var key in cfg){
      scores[key] += baseScore * cfg[key];
    }
  }

  var bestType = null;
  var bestScore = -9999;
  for(var t in scores){
    if(scores[t] > bestScore){
      bestScore = scores[t];
      bestType = t;
    }
  }
  computedPersonalityType = bestType;

  var label = PERSONALITY_LABELS[bestType] || bestType;
  var desc  = PERSONALITY_DESCRIPTIONS[bestType] || "";
  var resDiv = document.getElementById("personalityResult");
  resDiv.innerHTML =
    "ุชูพ ูพุดููุงุฏ ุดูุง: <b>"+label+"</b><br>"+desc+
    "<br><span style='font-size:11px;color:#666'>ุจุฑุง ุงุนูุงู ุงู ุชูพ ุฏุฑ ุจุฑูุงููโุฑุฒ ู ุชู ุธุงูุฑ ุงูพุ ุฑู ยซุซุจุช ุชูพ ุฏุฑ ุญุณุงุจ ููยป ุจุฒู.</span>";

  document.getElementById("savePersonalityBtn").disabled = false;
}

async function savePersonality(){
  if(!computedPersonalityType){
    alert("ุงูู ุชูพ ุฎูุฏุช ุฑุง ุจุง ุฒุฏู ยซูุญุงุณุจู ุชูพยป ุจูโุฏุณุช ุจุงูุฑ.");
    return;
  }

  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    alert("ุงุจุชุฏุง ูุงุฑุฏ ุญุณุงุจ ฺฉุงุฑุจุฑ ุดู.");
    return;
  }
  var email = userRes.data.user.email;

  var today = new Date().toISOString().slice(0,10);
  if(currentPersonalityUpdated){
    var diff = daysBetween(currentPersonalityUpdated, today);
    if(diff < 60){
      alert("ูุนูุงู ฺฉูุชุฑ ุงุฒ ถฐ ุฑูุฒ ุงุฒ ุขุฎุฑู ุซุจุช ุชูพ ฺฏุฐุดุชู. ุจุนุฏุงู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉู.");
      return;
    }
  }

  var upRes = await supabase
    .from("student_profile")
    .upsert({
      email: email,
      personality_type: computedPersonalityType,
      personality_updated: today
    });

  if(upRes.error){
    alert("ุฎุทุง ุฏุฑ ุฐุฎุฑู ุชูพ: "+upRes.error.message);
    console.log(upRes.error);
    return;
  }

  currentPersonalityType = computedPersonalityType;
  currentPersonalityUpdated = today;
  updatePersonalityUI();
  alert("ุชูพ ุดุฎุตุชุช ุฐุฎุฑู ุดุฏ. ุงุฒ ุงู ุจู ุจุนุฏ ููุช ยซุจุฑูุงูู ุจุฑ ุงุณุงุณ ุชูพ ุดุฎุตุชยป ุฑุง ุงูุชุฎุงุจ ฺฉูุ ุงู ุชูพ ุฑู ุจุฑูุงูู ู ุธุงูุฑ ุงูพ ุงุนูุงู ูโุดูุฏ.");
}

// ===== ุงุฒ ุงูุฌุง ุจู ุจุนุฏ: ฺฉู ุงูฺฏูุฑุชู ู ุจูู ุชูุงุจุน ุฏููุงู ูุซู ฺฉุฏ ุงุณุช ฺฉู ุฎูุฏุช ูุฑุณุชุงุฏ =====
// (ูฺ ุชุบุฑ ุฏุฑ ููุทู ุณุงุฎุช ุจุฑูุงููุ ุฐุฎุฑู ุฏุฑ Supabaseุ ูพูู ุฏุงูุดโุขููุฒุ ุนูุจโูุงูุฏฺฏ ู ุงุฏูู ุฏุงุฏู ูุดุฏู)


// ===== ูพุฑ ฺฉุฑุฏู ุนูุจโูุงูุฏฺฏ ุงุฒ ุจุฑูุงููโูุง ูุจู =====

function parseHoursFromText(txt){
  var m = txt.match(/ูุฏุช:\s*([\d\.]+)\s*ุณุงุนุช/);
  if(m) return parseFloat(m[1])||1.5;
  var m2 = txt.match(/(\d+)\s*ุฏููู/);
  if(m2){
    var min = parseInt(m2[1],10)||0;
    return min/60;
  }
  return 1.5;
}

function appendOfflineBacklogRow(subject, topic, hours){
  var tbody=document.getElementById("offlineBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="off-subject" onchange="updateTopicOptions(this, \'off-topic\')">'+
      '<option'+(subject==="ุฒุณุช"?' selected':'')+'>ุฒุณุช</option>'+
      '<option'+(subject==="ุดู"?' selected':'')+'>ุดู</option>'+
      '<option'+(subject==="ูุฒฺฉ"?' selected':'')+'>ูุฒฺฉ</option>'+
      '<option'+(subject==="ุฑุงุถ"?' selected':'')+'>ุฑุงุถ</option>'+
      '<option'+(subject==="ุงุฏุจุงุช"?' selected':'')+'>ุงุฏุจุงุช</option>'+
      '<option'+(subject==="ุฏู"?' selected':'')+'>ุฏู</option>'+
      '<option'+(subject==="ุนุฑุจ"?' selected':'')+'>ุนุฑุจ</option>'+
      '<option'+(subject==="ุฒุจุงู"?' selected':'')+'>ุฒุจุงู</option>'+
    '</select></td>'+
    '<td><select class="off-topic"></select></td>'+
    '<td><input type="number" step="0.5" class="off-hours" value="'+(hours||1.5)+'"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  var subjSel=tr.querySelector(".off-subject");
  updateTopicOptions(subjSel,"off-topic");
  if(topic){
    var topicSel=tr.querySelector(".off-topic");
    var found=false;
    for(var i=0;i<topicSel.options.length;i++){
      if(topicSel.options[i].value===topic){found=true;break;}
    }
    if(found) topicSel.value=topic;
  }
}

function appendLagBacklogRow(subject, topic, resource, count){
  var tbody=document.getElementById("lagBody");
  var tr=document.createElement("tr");
  tr.innerHTML=
    '<td><select class="lag-subject" onchange="updateTopicOptions(this, \'lag-topic\')">'+
      '<option'+(subject==="ุฒุณุช"?' selected':'')+'>ุฒุณุช</option>'+
      '<option'+(subject==="ุดู"?' selected':'')+'>ุดู</option>'+
      '<option'+(subject==="ูุฒฺฉ"?' selected':'')+'>ูุฒฺฉ</option>'+
      '<option'+(subject==="ุฑุงุถ"?' selected':'')+'>ุฑุงุถ</option>'+
    '</select></td>'+
    '<td><select class="lag-topic"></select></td>'+
    '<td><select class="lag-source">'+
      ['ุฎู ุณุจุฒ','ูุฑุฏุจุงู','ูุจุชฺฉุฑุงู','ูุดุฑุงูฺฏู','ุณู ุณุทุญ','QB','ููุฌ ุขุฒููู','ูุตู ุขุฒููู','IQ','ูฺฉุฑู ฺฏุงุฌ','ุชุชุงููู']
        .map(function(src){
          return '<option'+(src===resource?' selected':'')+'>'+src+'</option>';
        }).join("")+
    '</select></td>'+
    '<td><input type="number" class="lag-count" min="10" step="10" value="'+(count||80)+'"></td>'+
    '<td><button type="button" class="small-btn del" onclick="this.closest(\'tr\').remove()">ุญุฐู</button></td>';
  tbody.appendChild(tr);
  var subjSel=tr.querySelector(".lag-subject");
  updateTopicOptions(subjSel,"lag-topic");
  if(topic){
    var topicSel=tr.querySelector(".lag-topic");
    var found=false;
    for(var i=0;i<topicSel.options.length;i++){
      if(topicSel.options[i].value===topic){found=true;break;}
    }
    if(found) topicSel.value=topic;
  }
}

async function prefillBacklogFromAllPlans(){
  if(backlogPrefilled) return;
  backlogPrefilled = true;

  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user) return;
  var user = userRes.data.user;

  var pRes = await supabase
    .from("plans")
    .select("id,program_date")
    .eq("email", user.email)
    .order("program_date", { ascending:true });

  if(pRes.error || !pRes.data) return;
  var plans=pRes.data;
  if(!plans.length) return;

  var today = new Date();
  today.setHours(0,0,0,0);

  for(var pi=0;pi<plans.length;pi++){
    var p=plans[pi];
    var labels=getDateLabelsFromProgramDate(p.program_date);

    var tRes=await supabase
      .from("task_status")
      .select("id,day,task_text,status,leftover,done")
      .eq("plan_id", p.id);

    if(tRes.error || !tRes.data) continue;
    var tasks=tRes.data;

    for(var ti=0;ti<tasks.length;ti++){
      var t=tasks[ti];
      var dayIndex=t.day-1;
      if(dayIndex<0 || dayIndex>=14) continue;
      var dLabel=labels[dayIndex];
      if(!dLabel) continue;
      var datePart=dLabel.split(" ")[1];
      var parts=datePart.split("/");
      var yy=parseInt(parts[0],10);
      var mm=parseInt(parts[1],10)-1;
      var dd=parseInt(parts[2],10);
      var dateObj=new Date(yy,mm,dd);
      dateObj.setHours(0,0,0,0);
      if(dateObj>=today) continue;

      var st = t.status || (t.done?TASK_STATUS.DONE:TASK_STATUS.TODO);
      if(st===TASK_STATUS.DONE) continue;

      var leftoverVal = t.leftover || 0;
      var txt=t.task_text || "";

      if(txt.indexOf("ููู ุขููุงู")>-1 || txt.indexOf("ฺฉูุงุณ ุขููุงู")>-1){
        var subMatch = txt.match(/(ููู ุขููุงู|ฺฉูุงุณ ุขููุงู)\s+(\S+)/);
        var subject = subMatch ? subMatch[2] : "ุฒุณุช";
        var topic = "";
        var dashIndex = txt.indexOf("โ");
        if(dashIndex>-1){
          var subStr = txt.substring(dashIndex+1);
          var idxMed = subStr.indexOf("ูุฏุช:");
          if(idxMed>-1) subStr = subStr.substring(0,idxMed);
          topic = subStr.trim();
        }
        var hours;
        if(st===TASK_STATUS.PARTIAL && leftoverVal>0){
          hours = leftoverVal;
        }else{
          hours = parseHoursFromText(txt);
        }
        appendOfflineBacklogRow(subject,topic,hours);
        continue;
      }

      if(txt.indexOf("ุชุณุช")>-1 || txt.indexOf("ูุทุงูุนู")>-1){
        var subjMatch = txt.match(/(ุชุณุช|ูุทุงูุนู)\s+(\S+)/);
        var subject2 = subjMatch ? subjMatch[2] : "ุฒุณุช";
        var resMatch = txt.match(/ููุจุน:\s*([^\s]+)/);
        var resource = resMatch ? resMatch[1] : "ุฎู ุณุจุฒ";

        var count;
        if(st===TASK_STATUS.PARTIAL && leftoverVal>0){
          count = Math.round(leftoverVal);
        }else{
          var countMatch = txt.match(/ุญุฏูุฏ\s+(\d+)\s+ุชุณุช/);
          if(countMatch){
            count = parseInt(countMatch[1],10)||0;
          }else{
            var h = parseHoursFromText(txt);
            var perMin=SOURCE_MIN_PER_QUESTION[resource]||2.0;
            count = Math.round((h*60)/perMin);
          }
        }
        if(count>0){
          var topic2="";
          var dash2 = txt.indexOf("โ");
          if(dash2>-1){
            var sub2 = txt.substring(dash2+1);
            var idxRes = sub2.indexOf("ููุจุน:");
            if(idxRes>-1) sub2=sub2.substring(0,idxRes);
            var idxHor = sub2.indexOf("ุญุฏูุฏ");
            if(idxHor>-1) sub2=sub2.substring(0,idxHor);
            topic2=sub2.trim();
          }
          appendLagBacklogRow(subject2,topic2,resource,count);
        }
      }
    }
  }
}

// ===== ุฌูุนโุขูุฑ ุฏุงุฏู ุงุฒ ูุฑู =====
function collectStudentDataFromForm(){
  var fname=document.getElementById("fname").value.trim();
  var lname=document.getElementById("lname").value.trim();
  var phone=document.getElementById("phone").value.trim();
  var city=document.getElementById("city").value.trim();
  var school=document.getElementById("school").value.trim();
  var grade=document.getElementById("grade").value;
  var major=document.getElementById("major").value;
  var whiteDay=parseFloat(document.getElementById("whiteDay").value)||0;
  var schoolDay=parseFloat(document.getElementById("schoolDay").value)||0;

  var attendance=[];
  var attSel=document.querySelectorAll(".att-select");
  for(var i=0;i<attSel.length;i++){
    var sel=attSel[i];
    attendance.push({
      day:parseInt(sel.getAttribute("data-day"),10),
      goesToSchool:sel.value
    });
  }

  var classes=[];
  var clsRows=document.querySelectorAll("#classesBody tr");
  for(var c=0;c<clsRows.length;c++){
    var tr=clsRows[c];
    var d=parseInt(tr.querySelector(".class-day").value||"0",10);
    if(!d) continue;
    classes.push({
      day:d,
      subject:tr.querySelector(".class-subject").value,
      duration:parseFloat(tr.querySelector(".class-duration").value)||0,
      topic:tr.querySelector(".class-topic").value
    });
  }

  var exams=[];
  var cards=document.querySelectorAll(".exam-card");
  for(var i2=0;i2<cards.length;i2++){
    var card=cards[i2];
    var day=parseInt(card.querySelector(".exam-day").value||"0",10);
    if(!day) continue;
    var subject=card.querySelector(".exam-subject").value;
    var type=card.querySelector(".exam-type").value;
    var duration=card.querySelector(".exam-duration").value;
    var needsAnalysis = card.querySelector(".exam-analysis-need").checked;
    var analysisStartDay = parseInt(card.querySelector(".exam-analysis-start").value||"0",10);
    var allowExamDayStudy = card.querySelector(".exam-allow-today").checked;

    var topics=[];
    var tSel=card.querySelectorAll(".exam-chapter");
    for(var j=0;j<tSel.length;j++){
      topics.push(tSel[j].value);
    }
    if(!topics.length) topics=["ูุตู ูุงูุดุฎุต"];

    var resources=[];
    var srcSel=card.querySelectorAll(".exam-source");
    var cntSel=card.querySelectorAll(".exam-count");
    for(j=0;j<srcSel.length;j++){
      var cnum=parseInt(cntSel[j].value||"0",10);
      if(cnum>0){
        resources.push({name:srcSel[j].value,count:cnum});
      }
    }
    if(!resources.length) continue;

    exams.push({
      day:day,
      subject:subject,
      type:type,
      duration:duration,
      topics:topics,
      resources:resources,
      needsAnalysis:needsAnalysis,
      analysisStartDay:analysisStartDay,
      allowExamDayStudy:allowExamDayStudy
    });
  }

  var offlineVideos=[];
  var offRows=document.querySelectorAll("#offlineBody tr");
  for(var o=0;o<offRows.length;o++){
    var tro=offRows[o];
    var subjectO=tro.querySelector(".off-subject").value;
    var topicO=tro.querySelector(".off-topic").value;
    var hours=parseFloat(tro.querySelector(".off-hours").value)||0;
    if(hours>0) offlineVideos.push({subject:subjectO,topic:topicO,hours:hours});
  }

  var backlogTests=[];
  var lagRows=document.querySelectorAll("#lagBody tr");
  for(var l=0;l<lagRows.length;l++){
    var trl=lagRows[l];
    var subjectL=trl.querySelector(".lag-subject").value;
    var topicL=trl.querySelector(".lag-topic").value;
    var sourceL=trl.querySelector(".lag-source").value;
    var countL=parseInt(trl.querySelector(".lag-count").value||"0",10);
    if(countL>0) backlogTests.push({subject:subjectL,topic:topicL,resource:sourceL,count:countL});
  }

  var progressTargets=[];
  var progRows=document.querySelectorAll("#progBody tr");
  for(var p=0;p<progRows.length;p++){
    var trp=progRows[p];
    var subjectP=trp.querySelector(".prog-subject").value;
    var topicP=trp.querySelector(".prog-topic").value;
    var sourceP=trp.querySelector(".prog-source").value;
    var countP=parseInt(trp.querySelector(".prog-count").value||"0",10);
    if(countP>0) progressTargets.push({subject:subjectP,topic:topicP,resource:sourceP,count:countP});
  }

  var stats={
    biology:{avgRank:parseInt(document.getElementById("rankBio").value||"0",10)||0},
    chemistry:{avgRank:parseInt(document.getElementById("rankChem").value||"0",10)||0},
    physics:{avgRank:parseInt(document.getElementById("rankPhys").value||"0",10)||0},
    math:{avgRank:parseInt(document.getElementById("rankMath").value||"0",10)||0}
  };

  return {
    fname:fname,lname:lname,phone:phone,city:city,school:school,grade:grade,major:major,
    whiteDay:whiteDay,schoolDay:schoolDay,
    attendance:attendance,classes:classes,exams:exams,
    offlineVideos:offlineVideos,backlogTests:backlogTests,progressTargets:progressTargets,
    stats:stats
  };
}

// ===== ุงูฺฏูุฑุชู ุณุงุฎุช ุจุฑูุงูู (ุฏู ุญุงูุช: normal / personality) =====
function buildPlan(student, dateLabels, mode){
  var DAYS=14;
  var dayFree=new Array(DAYS).fill(0);
  var dayHasSchool=new Array(DAYS).fill(false);
  var classHoursPerDay=new Array(DAYS).fill(0);
  var d,i;

  // ุชูพ ููุง ฺฉู ุฑู ุงูฺฏูุฑุชู ุงุซุฑ ูโฺฏุฐุงุฑุฏ:
  // ุญุงูุช ุนุงุฏ: ููุดู steady
  // ุญุงูุช ุชูพ: ุงฺฏุฑ ุชูพ ุฐุฎุฑู ุดุฏู ุจุงุดุฏ ุงุฒ ููุงูุ ูฺฏุฑูู steady
  var personality = "steady";
  if(mode === "personality" && currentPersonalityType){
    personality = currentPersonalityType;
  }

  // ฑ) ูุญุงุณุจู ุณุงุนุช ุฎุงู ูุฑ ุฑูุฒ
  for(d=1;d<=DAYS;d++){
    var att=null;
    for(i=0;i<student.attendance.length;i++){
      if(student.attendance[i].day===d){att=student.attendance[i];break;}
    }
    var base=(att && att.goesToSchool==="ุจูู")? student.schoolDay : student.whiteDay;
    dayFree[d-1]=base||0;
    dayHasSchool[d-1]=!!(att && att.goesToSchool==="ุจูู");
  }

  for(i=0;i<student.classes.length;i++){
    var c=student.classes[i];
    if(c.day>=1 && c.day<=DAYS){
      var h=parseFloat(c.duration)||0;
      classHoursPerDay[c.day-1]+=h;
      dayFree[c.day-1]-=h;
    }
  }

  // ฺฉู ฺฉุฑุฏู ุฎูุฏ ุขุฒููู
  for(i=0;i<student.exams.length;i++){
    var ex0=student.exams[i];
    if(ex0.day>=1 && ex0.day<=DAYS){
      dayFree[ex0.day-1]-=parseDurationToHours(ex0.duration);
    }
  }
  for(i=0;i<DAYS;i++){ if(dayFree[i]<0) dayFree[i]=0; }

  // ฒ) ุดุฎุตุช: ููุท ุงฺฏุฑ mode = personality
  if(mode==="personality" && personality==="lastminute"){
    var oriWeek1=0, adjWeek1=0;
    for(i=0;i<7;i++){
      var ori = dayFree[i];
      var adj = ori*0.8; // ููุชู ุงูู ุณุจฺฉโุชุฑ
      oriWeek1 += ori;
      adjWeek1 += adj;
      dayFree[i] = adj;
    }
    var lost = oriWeek1 - adjWeek1;
    if(lost>0){
      var addPerDay=lost/7;
      for(i=7;i<14;i++){
        dayFree[i]+=addPerDay;
      }
    }
  }

  // ณ) ุฌูุน ฺฉู ู ููุชูโุง
  var week1Free=0,week2Free=0;
  for(i=0;i<7;i++) week1Free+=dayFree[i];
  for(i=7;i<14;i++) week2Free+=dayFree[i];
  var totalFree=week1Free+week2Free;

  // ุนูููโูุง
  var publicW1=totalFree*0.15;
  var publicW2=totalFree*0.05;
  var publicSubjects=["ุงุฏุจุงุช","ุฏู","ุนุฑุจ","ุฒุจุงู"];
  var publicWeights={"ุงุฏุจุงุช":0.5,"ุฏู":0.2,"ุนุฑุจ":0.2,"ุฒุจุงู":0.1};
  var totalPublic=publicW1+publicW2;
  var subjectRemainingPublic={};
  publicSubjects.forEach(function(s){
    subjectRemainingPublic[s]=totalPublic*(publicWeights[s]||0);
  });

  // ุนูุจโูุงูุฏฺฏ: ุถุฑุงุจ ุจุฑ ุงุณุงุณ ุชูพ ููุท ุงฺฏุฑ mode = personality
  var lagFactor1=0.30;
  var lagFactor2=0.15;
  if(mode==="personality" && personality==="obsessive"){
    lagFactor1=0.35;
    lagFactor2=0.20;
  }
  var lagW1=week1Free*lagFactor1;
  var lagW2=week2Free*lagFactor2;

  // ุขุฒูููโูุง
  var examQueue=[];
  var examTotalNeededTests=0;
  var examTotalHoursBefore=0;
  for(i=0;i<student.exams.length;i++){
    var ex=student.exams[i];
    var topics=(ex.topics && ex.topics.length)? ex.topics:[""];
    for(var r=0;r<ex.resources.length;r++){
      var res=ex.resources[r];
      var perMin=SOURCE_MIN_PER_QUESTION[res.name]||2.0;
      var testH=(res.count*perMin)/60;
      var studyH=testH*studyRatio(ex.subject);
      examQueue.push({
        day:ex.day,
        subject:ex.subject,
        topics:topics,
        resource:res.name,
        totalTests:res.count,
        testHours:testH,
        studyHours:studyH,
        allowExamDayStudy: !!ex.allowExamDayStudy
      });
      examTotalNeededTests+=res.count;
      examTotalHoursBefore+=(testH+studyH);
    }
  }

  // ุชุญูู ุขุฒููู
  var analysisQueue=[];
  var analysisTotalHours=0;
  for(i=0;i<student.exams.length;i++){
    var exA=student.exams[i];
    if(!exA.needsAnalysis) continue;
    if(!(exA.type==="ุขุฒููู ุขุฒูุงุด" || exA.type==="ุงูุชุญุงู ฺฉูุงุณ ุจุฑูู")) continue;
    var durH=parseDurationToHours(exA.duration);
    var aH=durH*0.5;
    var startDay=exA.analysisStartDay || (exA.day+1);
    if(startDay<exA.day) startDay=exA.day;
    analysisQueue.push({
      subject:exA.subject,
      topics:(exA.topics && exA.topics.length? exA.topics:["ูุตูโูุง ุขุฒููู"]),
      examDay:exA.day,
      earliestDay:startDay,
      hours:aH
    });
    analysisTotalHours+=aH;
  }

  var reservedForPublicLag=publicW1+publicW2;

  // ุนูุจโูุงูุฏฺฏโูุง (ููู + ุชุณุช)
  var backlogQueue=[];
  var backlogTotalHours=0;
  for(i=0;i<student.offlineVideos.length;i++){
    var v=student.offlineVideos[i];
    backlogQueue.push({type:"offline",subject:v.subject,topic:v.topic,hours:v.hours||0});
    backlogTotalHours+=(v.hours||0);
  }
  for(i=0;i<student.backlogTests.length;i++){
    var l=student.backlogTests[i];
    var perMin2=SOURCE_MIN_PER_QUESTION[l.resource]||2.0;
    var h2=(l.count*perMin2)/60;
    backlogQueue.push({
      type:"lagtest",subject:l.subject,topic:l.topic,
      resource:l.resource,count:l.count,hours:h2
    });
    backlogTotalHours+=h2;
  }

  // ูพุดุฑู
  var progressQueue=[];
  var progressTotalHours=0;
  for(i=0;i<student.progressTargets.length;i++){
    var p=student.progressTargets[i];
    var perMin3=SOURCE_MIN_PER_QUESTION[p.resource]||2.0;
    var testH2=(p.count*perMin3)/60;
    var studyH2=testH2*studyRatio(p.subject);
    progressQueue.push({
      subject:p.subject,topic:p.topic,resource:p.resource,
      totalTests:p.count,testHours:testH2,studyHours:studyH2
    });
    progressTotalHours+=(testH2+studyH2);
  }

  // ุชูุธู ููุงุณ ุฒูุงู ุขุฒูููโูุง
  var freeForExamAndMore=totalFree-reservedForPublicLag;
  var examScale=1;
  if(freeForExamAndMore>0 && examTotalHoursBefore>freeForExamAndMore){
    examScale=freeForExamAndMore/examTotalHoursBefore;
  }
  for(i=0;i<examQueue.length;i++){
    examQueue[i].testHours*=examScale;
    examQueue[i].studyHours*=examScale;
    examQueue[i].totalTests=Math.round(examQueue[i].totalTests*examScale);
  }
  var examCoveragePercent = (examTotalHoursBefore>0? examScale*100 : 100);

  var sw=detectStrongWeak(student.stats);
  var strong=sw.strong;
  var weak=sw.weak;

  function takeFromBacklog(maxStudyHours,maxOfflineVideo){
    var used=0;
    var offlineUsed=0;
    var tasks=[];
    var i2;
    for(i2=0;i2<backlogQueue.length && used<maxStudyHours-0.25;i2++){
      var it=backlogQueue[i2];
      if(it.type!=="offline") continue;
      var offlineRemain=maxOfflineVideo-offlineUsed;
      if(offlineRemain<=0.25) continue;
      var can=Math.min(it.hours, maxStudyHours-used, offlineRemain, 2);
      if(can<0.5) continue;
      used+=can;
      offlineUsed+=can;
      it.hours-=can;
      tasks.push(
        '๐ฌ ููู ุขููุงู '+it.subject+' โ '+(it.topic||"ูุตู ูุงูุดุฎุต")+
        '<br>ูุฏุช: '+formatHoursWithMinutes(can)
      );
      if(it.hours<=0.25){backlogQueue.splice(i2,1);i2--;}
    }
    for(i2=0;i2<backlogQueue.length && used<maxStudyHours-0.25;i2++){
      var it2=backlogQueue[i2];
      if(it2.type!=="lagtest") continue;
      var perMin=SOURCE_MIN_PER_QUESTION[it2.resource]||2.0;
      var can2=Math.min(it2.hours, maxStudyHours-used, 2);
      if(can2<0.5) continue;
      var q=Math.round((can2*60)/perMin);
      if(q<=0) continue;
      used+=can2;
      it2.hours-=can2;
      it2.count-=q;
      var weakTag=(it2.subject===weak? " โญ ุชูุฑฺฉุฒ ุฑู ููุทูโุถุนู" : "");
      tasks.push(
        '๐งช ุชุณุช ุนูุจโูุงูุฏู '+it2.subject+' ุงุฒ '+it2.resource+' โ '+(it2.topic||"ูุตู ูุงูุดุฎุต")+'<br>'+
        'ุญุฏูุฏ '+q+' ุชุณุช ุฏุฑ '+formatHoursWithMinutes(can2)+weakTag
      );
      if(it2.count<=0 || it2.hours<=0.25){backlogQueue.splice(i2,1);i2--;}
    }

    return {used:used,tasks:tasks,offlineUsed:offlineUsed};
  }

  function takeFromExams(dayIdx,maxH){
    var used=0;
    var tasks=[];
    var testTime=0;
    examQueue.sort(function(a,b){return a.day-b.day;});

    for(var i3=0;i3<examQueue.length && used<maxH-0.25;i3++){
      var ex2=examQueue[i3];
      if(ex2.day<dayIdx+1) continue;
      if(ex2.day===dayIdx+1 && !ex2.allowExamDayStudy) continue;

      var total=ex2.testHours+ex2.studyHours;
      var block=Math.min(total,maxH-used,4);
      if(block<0.5) continue;
      var ratio=(total>0? block/total : 0);
      var testPart=ex2.testHours*ratio;
      var studyPart=ex2.studyHours*ratio;
      var perMin=SOURCE_MIN_PER_QUESTION[ex2.resource]||2.0;
      var q2=Math.round((testPart*60)/perMin);
      if(q2<=0 && studyPart>0){
        testPart=0;
      }
      used+=block;
      ex2.testHours-=testPart;
      ex2.studyHours-=studyPart;
      testTime+=testPart;

      var chapters=(ex2.topics && ex2.topics.length? ex2.topics.join("ุ "):"ูุตู ูุงูุดุฎุต");
      var typeTag='ุขุฒููู/ุงูุชุญุงู ุฑูุฒ '+ex2.day;
      var weakTag2=(ex2.subject===weak? " โญ ุชูุฑฺฉุฒ ุฑู ููุทูโุถุนู" : "");
      if(testPart>0.25){
        tasks.push(
          '๐ก ุชุณุช '+ex2.subject+' ุจุฑุง '+typeTag+'<br>'+
          'ููุจุน: '+ex2.resource+' | ูุตู: '+chapters+'<br>'+
          'ุญุฏูุฏ '+q2+' ุชุณุช ุฏุฑ '+formatHoursWithMinutes(testPart)+weakTag2
        );
      }
      if(studyPart>0.25){
        tasks.push(
          '๐ ูุทุงูุนู '+ex2.subject+' ุจุฑุง '+typeTag+'<br>'+
          'ููุจุน: '+ex2.resource+' | ูุตู: '+chapters+'<br>'+
          'ูุฏุช ูุทุงูุนู: '+formatHoursWithMinutes(studyPart)
        );
      }
      if(ex2.testHours+ex2.studyHours<=0.25 || ex2.totalTests<=q2){
        examQueue.splice(i3,1);i3--;
      }else{
        ex2.totalTests=Math.max(0,ex2.totalTests-q2);
      }
    }
    return {used:used,tasks:tasks,testTime:testTime};
  }

  function takeFromAnalysis(dayIdx,maxH){
    var used=0;
    var tasks=[];
    for(var i5=0;i5<analysisQueue.length && used<maxH-0.25;i5++){
      var item=analysisQueue[i5];
      if(item.earliestDay>dayIdx+1) continue;
      if(item.hours<=0){
        analysisQueue.splice(i5,1);i5--;continue;
      }
      var can=Math.min(item.hours, maxH-used, 2);
      if(can<0.5) continue;
      used+=can;
      item.hours-=can;
      var ch=(item.topics && item.topics.length? item.topics.join("ุ "):"ูุตูโูุง ุขุฒููู");
      tasks.push(
        '๐ง ุชุญูู ุขุฒููู '+item.subject+' (ุฑูุฒ '+item.examDay+') โ '+ch+'<br>'+
        'ูุฏุช: '+formatHoursWithMinutes(can)
      );
      if(item.hours<=0.25){
        analysisQueue.splice(i5,1);i5--;
      }
    }
    return {used:used,tasks:tasks};
  }

  function takeFromProgress(maxH,strongSub){
    var used=0;
    var tasks=[];
    progressQueue.sort(function(a,b){
      if(a.subject===strongSub && b.subject!==strongSub) return -1;
      if(b.subject===strongSub && a.subject!==strongSub) return 1;
      return 0;
    });
    for(var i4=0;i4<progressQueue.length && used<maxH-0.25;i4++){
      var p2=progressQueue[i4];
      var total2=p2.testHours+p2.studyHours;
      var block2=Math.min(total2,maxH-used,2);
      if(block2<0.5) continue;
      var ratio2=(total2>0? block2/total2 : 0);
      var testPart2=p2.testHours*ratio2;
      var studyPart2=p2.studyHours*ratio2;
      var perMin2=SOURCE_MIN_PER_QUESTION[p2.resource]||2.0;
      var q3=Math.round((testPart2*60)/perMin2);
      used+=block2;
      p2.testHours-=testPart2;
      p2.studyHours-=studyPart2;
      var strongTag=(p2.subject===strongSub? " โญ ุงุณุชูุงุฏู ุงุฒ ููุทู ููุช" : "");
      var ch=(p2.topic||"ูุจุงุญุซ ุจุนุฏ");
      tasks.push(
        '๐ฃ ูพุดุฑู '+p2.subject+' โ '+ch+'<br>'+
        'ููุจุน: '+p2.resource+' | ุญุฏูุฏ '+q3+' ุชุณุช + ูุทุงูุนู ุฏุฑ '+formatHoursWithMinutes(block2)+strongTag
      );
      if(p2.testHours+p2.studyHours<=0.25 || p2.totalTests<=q3){
        progressQueue.splice(i4,1);i4--;
      }else{
        p2.totalTests=Math.max(0,p2.totalTests-q3);
      }
    }
    return {used:used,tasks:tasks};
  }

  var backlogHoursUsed=0;
  var progressHoursUsed=0;
  var analysisHoursUsed=0;

  var plan=[];
  for(d=1;d<=DAYS;d++){
    var baseFree=dayFree[d-1];
    var free = baseFree;
    if(examCoveragePercent<70){
      free += 0.5;
    }
    var dayTasks=[];
    var testHoursToday=0;

    var hasClassToday=(classHoursPerDay[d-1]>0);
    var videoCapDay = dayHasSchool[d-1] ? 3 : 4;
    var videoUsedToday = classHoursPerDay[d-1];

    // ฺฉูุงุณโูุง ุขููุงู ููุงู ุฑูุฒ
    for(i=0;i<student.classes.length;i++){
      var cl=student.classes[i];
      if(cl.day===d){
        dayTasks.push(
          '๐ง ุดุฑฺฉุช ุฏุฑ ฺฉูุงุณ ุขููุงู '+cl.subject+' โ '+(cl.topic||"ูุตู ูุงูุดุฎุต")+
          '<br>ูุฏุช: '+formatHoursWithMinutes(cl.duration||0)
        );
      }
    }

    // ุชูพ ยซูพุฑุชูุงุด ุงูุง ูุฑุงุฑยป ููุท ุฏุฑ ุญุงูุช personality
    if(mode==="personality" && personality==="runner" && d>=4 && free>0.5){
      var reviewSub = (weak==="ุฒุณุช" || weak==="ุดู") ? weak : "ุฒุณุช";
      var reviewH = Math.min(0.5, free);
      dayTasks.push(
        '๐ ูุฑูุฑ ููููู '+reviewSub+' (ุจุฑ ุงุณุงุณ ูุจุงุญุซ ุณุฎุช ุง ุขุฒูููโูุง ุงุฎุฑ)<br>'+
        'ูุฏุช: '+formatHoursWithMinutes(reviewH)
      );
      free -= reviewH;
    }

    // ุนูููโูุง
    if(free>0 && (!hasClassToday)){
      var capPubDay=(d<=7? publicW1:publicW2);
      if(capPubDay>0){
        var dayMaxPub=Math.min(2,free,capPubDay);
        var remainToday=dayMaxPub;
        var startIdx=(d-1)%publicSubjects.length;
        for(var k=0;k<publicSubjects.length && remainToday>0.25;k++){
          var subj=publicSubjects[(startIdx+k)%publicSubjects.length];
          var subjRemain=subjectRemainingPublic[subj]||0;
          if(subjRemain<=0.25) continue;
          var slot=Math.min(subjRemain, remainToday, 1.5);
          if(slot<0.5) continue;
          dayTasks.push('๐ '+subj+' โ ูุทุงูุนู ู ุญู ุชูุฑู<br>ูุฏุช: '+formatHoursWithMinutes(slot));
          subjectRemainingPublic[subj]-=slot;
          remainToday-=slot;
        }
        var usedPub=dayMaxPub-remainToday;
        free-=usedPub;
        if(d<=7) publicW1-=usedPub; else publicW2-=usedPub;
      }
    }

    // ุชุญูู ุขุฒููู
    if(free>0 && analysisQueue.length){
      var anaRes=takeFromAnalysis(d-1,Math.min(3,free));
      if(anaRes.used>0){
        for(i=0;i<anaRes.tasks.length;i++) dayTasks.push(anaRes.tasks[i]);
        free-=anaRes.used;
        analysisHoursUsed+=anaRes.used;
      }
    }

    // ุนูุจโูุงูุฏฺฏ
    var capLag=(d<=7? lagW1:lagW2);
    if(free>0 && capLag>0 && backlogQueue.length){
      var maxLagToday=Math.min(4,free,capLag);
      var lagResult=takeFromBacklog(maxLagToday, Math.max(0,videoCapDay-videoUsedToday));
      if(lagResult.used>0){
        backlogHoursUsed+=lagResult.used;
        videoUsedToday+=lagResult.offlineUsed;
        for(i=0;i<lagResult.tasks.length;i++) dayTasks.push(lagResult.tasks[i]);
        free-=lagResult.used;
        if(d<=7) lagW1-=lagResult.used; else lagW2-=lagResult.used;
      }
    }

    // ุขุฒููู
    if(free>0 && examQueue.length){
      var exResult=takeFromExams(d-1,free);
      if(exResult.used>0){
        for(i=0;i<exResult.tasks.length;i++) dayTasks.push(exResult.tasks[i]);
        free-=exResult.used;
        testHoursToday+=exResult.testTime;
      }
    }

    // ุฏูุจุงุฑู ุนูุจโูุงูุฏฺฏ
    if(free>0 && backlogQueue.length){
      var lag2=takeFromBacklog(Math.min(3,free), Math.max(0,videoCapDay-videoUsedToday));
      if(lag2.used>0){
        backlogHoursUsed+=lag2.used;
        videoUsedToday+=lag2.offlineUsed;
        for(i=0;i<lag2.tasks.length;i++) dayTasks.push(lag2.tasks[i]);
        free-=lag2.used;
      }
    }

    // ูุฑูุฑ ุชุณุชโูุง ูุงุฑฺฉุฏุงุฑ
    if(free>0 && testHoursToday>0){
      var reviewNeed=testHoursToday/6;
      var hRev=Math.min(free,reviewNeed);
      if(hRev>=0.25){
        dayTasks.push('๐ ูุฑูุฑ ุชุณุชโูุง ูุงุฑฺฉโุฏุงุฑ ุงูุฑูุฒ<br>ูุฏุช: '+formatHoursWithMinutes(hRev));
        free-=hRev;
      }
    }

    // ูพุดุฑู
    if(free>0 && progressQueue.length){
      var progRes=takeFromProgress(free,strong);
      if(progRes.used>0){
        progressHoursUsed+=progRes.used;
        for(i=0;i<progRes.tasks.length;i++) dayTasks.push(progRes.tasks[i]);
        free-=progRes.used;
      }
    }

    // ูพุงุณ ุฏูู
    if(free>0.5){
      if(examQueue.length){
        var exRes2=takeFromExams(d-1,free);
        if(exRes2.used>0){
          for(i=0;i<exRes2.tasks.length;i++) dayTasks.push(exRes2.tasks[i]);
          free-=exRes2.used;
        }
      }
      if(free>0.5 && progressQueue.length){
        var progRes2=takeFromProgress(free,strong);
        if(progRes2.used>0){
          progressHoursUsed+=progRes2.used;
          for(i=0;i<progRes2.tasks.length;i++) dayTasks.push(progRes2.tasks[i]);
          free-=progRes2.used;
        }
      }
    }

    if(dayTasks.length===0){
      dayTasks.push("โช ุงุณุชุฑุงุญุช / ูุฑูุฑ ุณุจฺฉ");
    }
    plan.push(dayTasks);
  }

  var backlogCoverage = (backlogTotalHours>0) ? Math.round((backlogHoursUsed*100)/backlogTotalHours) : null;
  var progressCoverage = (progressTotalHours>0) ? Math.round((progressHoursUsed*100)/progressTotalHours) : null;
  var examCoverage = (examTotalHoursBefore>0) ? Math.round((examScale*100)) : null;
  var analysisCoverage = (analysisTotalHours>0) ? Math.round((analysisHoursUsed*100)/analysisTotalHours) : null;

  var html='<tr><th>ุฑูุฒ</th><th>ุจุฑูุงูู</th></tr>';
  for(d=1;d<=DAYS;d++){
    var tasksHTML="";
    for(i=0;i<plan[d-1].length;i++){
      tasksHTML+='<div class="task-block">'+plan[d-1][i]+'</div>';
    }
    var label = (dateLabels && dateLabels[d-1]) ? dateLabels[d-1] : ('ุฑูุฒ '+d);
    html+='<tr><td style="text-align:center">'+label+'</td><td>'+tasksHTML+'</td></tr>';
  }
  return {
    plan:plan,
    html:html,
    coverage:{
      exam:examCoverage,
      backlog:backlogCoverage,
      progress:progressCoverage,
      analysis:analysisCoverage
    }
  };
}

// ===== ุณุงุฎุช ุจุฑูุงูู ู ุฐุฎุฑู =====
async function onMakePlanClicked(){
  var status=document.getElementById("statusMsg");
  var coverageDiv=document.getElementById("coverageSummary");
  status.textContent="";
  coverageDiv.textContent="";

  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    alert("ุงูู ุจุงุฏ ูุงฺฏู ฺฉู.");
    return;
  }
  var user=userRes.data.user;

  var planMode = document.getElementById("planMode").value; // normal | personality | ai

  if(planMode === "personality" && !currentPersonalityType){
    if(!confirm("ุชูพ ุดุฎุตุช ุซุจุชโุดุฏูโุง ุจุฑุง ุงู ุญุณุงุจ ูุฌูุฏ ูุฏุงุฑุฏ.\nุงฺฏุฑ ูโุฎูุงู ุชูพ ุฑู ุจุฑูุงูู ุงุซุฑ ุจฺฏุฐุงุฑุฏุ ุงูู ุงุฒ ุชุจ ยซุขุฒููู ุดุฎุตุชยป ุชูพ ุฑุง ุซุจุช ฺฉู.\nุงูุงู ุงฺฏุฑ ุงุฏุงูู ุฏูุ ูุซู ุญุงูุช ุนุงุฏ (steady) ุจุฑูุงูู ูโฺูู. ุงุฏุงูู ุจุฏููุ")){
      showTab("personalityTab");
      return;
    }
  }

  var s=collectStudentDataFromForm();

  if(!s.fname || !s.lname || !s.phone || !s.city || !s.school || !s.grade || !s.major){
    alert("ูุงูุ ูุงู ุฎุงููุงุฏฺฏุ ุดูุงุฑู ููุจุงูุ ุดูุฑุ ูุฏุฑุณูุ ูพุงู ู ุฑุดุชู ุญุชูุงู ุจุงุฏ ูพุฑ ุดููุฏ.");
    return;
  }
  var reg=/^09\d{9}$/;
  if(!reg.test(s.phone)){
    alert("ุดูุงุฑู ููุจุงู ุจุงุฏ ุจุง 09 ุดุฑูุน ุดูุฏ ู ุฏููุงู 11 ุฑูู ุจุงุดุฏ.");
    return;
  }

  var programDate=new Date().toISOString().slice(0,10);
  var dateLabels = getDateLabelsFromProgramDate(programDate);
  var result=buildPlan(s,dateLabels,planMode);

  document.getElementById("scheduleTable").innerHTML=result.html;

  var examCov = (result.coverage.exam!=null? result.coverage.exam+"ูช":"โ");
  var backCov = (result.coverage.backlog!=null? result.coverage.backlog+"ูช":"โ");
  var progCov = (result.coverage.progress!=null? result.coverage.progress+"ูช":"โ");
  var anaCov  = (result.coverage.analysis!=null? result.coverage.analysis+"ูช":"โ");
  coverageDiv.textContent =
    "ูพูุดุด ุขุฒูููโูุง: "+examCov+
    " | ูพูุดุด ุนูุจโูุงูุฏฺฏ (ููู + ุชุณุช): "+backCov+
    " | ุงุณุชูุงุฏู ุงุฒ ุงูุฏุงู ูพุดุฑู: "+progCov+
    " | ูพูุดุด ุชุญูู ุขุฒูููโูุง: "+anaCov;

  status.style.color="#b30000";
  status.textContent="ุฏุฑ ุญุงู ุฐุฎุฑู ุจุฑูุงูู ุฏุฑ Supabase...";

  var insertRes=await supabase
    .from("plans")
    .insert({
      email:user.email,
      fname:s.fname,
      lname:s.lname,
      phone:s.phone,
      city:s.city,
      school:s.school,
      grade:s.grade,
      major:s.major,
      program_date:programDate,
      plan_type: planMode
    })
    .select()
    .single();

  if(insertRes.error){
    console.log(insertRes.error);
    status.textContent="โ ุฎุทุง ุฏุฑ ุฐุฎุฑู ุจุฑูุงูู: "+insertRes.error.message;
    return;
  }

  var planId=insertRes.data.id;
  var rows=[];
  for(var d=0;d<result.plan.length;d++){
    var dayTasks=result.plan[d];
    for(var i=0;i<dayTasks.length;i++){
      var txt=dayTasks[i].replace(/<br>/g," ").replace(/<\/?[^>]+(>|$)/g,"").trim();
      rows.push({
        plan_id:planId,
        day:d+1,
        task_text:txt,
        status:TASK_STATUS.TODO,
        leftover:0,
        done:false
      });
    }
  }

  if(rows.length){
    var tRes=await supabase.from("task_status").insert(rows);
    if(tRes.error){
      console.log(tRes.error);
      status.textContent="โ๏ธ ุจุฑูุงูู ุฐุฎุฑู ุดุฏ ุงูุง ุชุณฺฉโูุง ุฐุฎุฑู ูุดุฏูุฏ: "+tRes.error.message;
    }else{
      status.style.color="green";
      status.textContent="โ ุจุฑูุงูู ู ุชุณฺฉโูุง ุฐุฎุฑู ุดุฏูุฏ.";
    }
  }else{
    status.style.color="green";
    status.textContent="โ ุจุฑูุงูู ุฐุฎุฑู ุดุฏ (ุชุณฺฉ ุซุจุช ูุดุฏ).";
  }

  loadStudentPlans();
  loadBacklogView();
  var u = user.email;
  if(ADMIN_EMAILS.indexOf(u)>=0){
    loadAdminPlans();
  }
}

// ===== ุจุฑูุงููโูุง ุฏุงูุดโุขููุฒ =====
function planTypeLabel(t){
  if(t==="personality") return "ุชูพ ุดุฎุตุช";
  if(t==="ai") return "ููุด ูุตููุน";
  return "ุนุงุฏ";
}

async function loadStudentPlans(){
  var info = document.getElementById("studentTasksInfo");
  var plansTable = document.getElementById("studentPlansTable");
  var tasksTable = document.getElementById("studentTasksTable");
  var reportBox  = document.getElementById("instantReportBox");

  info.textContent = "";
  plansTable.innerHTML = "";
  tasksTable.innerHTML = "";
  reportBox.textContent = "";

  var userRes = await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    info.textContent = "ุงุจุชุฏุง ูุงฺฏู ฺฉู.";
    return;
  }
  var user = userRes.data.user;

  var pRes = await supabase
    .from("plans")
    .select("id,program_date,plan_type")
    .eq("email", user.email)
    .order("program_date", { ascending: false });

  if(pRes.error){
    plansTable.innerHTML = "<tr><td>ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุจุฑูุงููโูุง.</td></tr>";
    console.log(pRes.error);
    return;
  }

  var plans = pRes.data || [];
  if(!plans.length){
    plansTable.innerHTML = "<tr><td>ูููุฒ ูฺ ุจุฑูุงููโุง ุซุจุช ูฺฉุฑุฏูโุง.</td></tr>";
    info.textContent = "";
    return;
  }

  var html = "<tr><th>ID</th><th>ุชุงุฑุฎ ุจุฑูุงูู</th><th>ููุน ุจุฑูุงูู</th><th>ุชุณฺฉโูุง</th></tr>";
  for(var i=0;i<plans.length;i++){
    var p = plans[i];
    html += '<tr>'+
      '<td>'+p.id+'</td>'+
      '<td>'+p.program_date+'</td>'+
      '<td>'+planTypeLabel(p.plan_type)+'</td>'+
      '<td><button class="small-btn" onclick="loadStudentTasksForPlan('+p.id+', \''+p.program_date+'\')">ููุงุด ุชุณฺฉโูุง</button></td>'+
    '</tr>';
  }
  plansTable.innerHTML = html;

  currentStudentPlanId = plans[0].id;
  currentStudentPlanDate = plans[0].program_date;
  loadStudentTasksForPlan(currentStudentPlanId, currentStudentPlanDate);
}

async function loadStudentTasksForPlan(planId, programDate){
  currentStudentPlanId = planId;
  currentStudentPlanDate = programDate;

  var info = document.getElementById("studentTasksInfo");
  var reportBox = document.getElementById("instantReportBox");
  info.textContent = "";
  reportBox.textContent = "";

  var tRes = await supabase
    .from("task_status")
    .select("id,day,task_text,done,status,leftover")
    .eq("plan_id", planId)
    .order("day", { ascending: true })
    .order("id", { ascending: true });

  if(tRes.error){
    info.textContent = "ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุชุณฺฉโูุง.";
    console.log(tRes.error);
    return;
  }

  currentStudentTasks = tRes.data || [];
  if(!currentStudentTasks.length){
    info.textContent = "ุจุฑุง ุงู ุจุฑูุงูู ุชุณฺฉ ุซุจุช ูุดุฏู.";
    document.getElementById("studentTasksTable").innerHTML = "";
    return;
  }

  var doneCount=0, partialCount=0, todoCount=0;
  for(var i=0;i<currentStudentTasks.length;i++){
    var st=currentStudentTasks[i].status || (currentStudentTasks[i].done?TASK_STATUS.DONE:TASK_STATUS.TODO);
    if(st===TASK_STATUS.DONE) doneCount++;
    else if(st===TASK_STATUS.PARTIAL) partialCount++;
    else todoCount++;
  }
  var total=currentStudentTasks.length;
  var percent = Math.round((doneCount * 100) / total);

  info.textContent =
    "ุจุฑูุงูู ุชุงุฑุฎ " + programDate +
    " | ุชุนุฏุงุฏ ุชุณฺฉ: " + total +
    " | ุงูุฌุงู ุดุฏู: " + doneCount +
    " | ูุงูุต: " + partialCount +
    " | ุงูุฌุงูโูุดุฏู: " + todoCount +
    " | ุฏุฑุตุฏ ุงูุฌุงู ฺฉุงูู: " + percent + "ูช";

  renderStudentTasksFiltered();
}

// ุฑูุฏุฑ ุจุง ููุชุฑ ุฑูุฒ
function renderStudentTasksFiltered(){
  var table = document.getElementById("studentTasksTable");
  var filter = document.getElementById("studentDayFilter").value;
  table.innerHTML = "";

  if(!currentStudentTasks || !currentStudentTasks.length){
    table.innerHTML = "<tr><td>ุชุณฺฉ ุจุฑุง ููุงุด ูุฌูุฏ ูุฏุงุฑุฏ.</td></tr>";
    return;
  }

  var labels = getDateLabelsFromProgramDate(currentStudentPlanDate);
  var html = "<tr><th>ุฑูุฒ</th><th>ุชุณฺฉ</th><th>ูุถุนุช</th><th>ุจุงูโูุงูุฏู</th></tr>";

  for(var i=0;i<currentStudentTasks.length;i++){
    var t=currentStudentTasks[i];
    if(filter!=="all" && String(t.day)!==filter) continue;

    var st=t.status || (t.done?TASK_STATUS.DONE:TASK_STATUS.TODO);
    var label=labels[t.day-1] || ("ุฑูุฒ "+t.day);
    var badgeHtml="";
    if(st===TASK_STATUS.DONE) badgeHtml='<span class="badge done">ุงูุฌุงู ุดุฏู</span>';
    else if(st===TASK_STATUS.PARTIAL) badgeHtml='<span class="badge partial">ูุงูุต</span>';
    else badgeHtml='<span class="badge todo">ุงูุฌุงูโูุดุฏู</span>';

    html+='<tr>'+
      '<td style="text-align:center">'+label+'</td>'+
      '<td>'+t.task_text+'</td>'+
      '<td style="font-size:11px;">'+
        '<label><input type="radio" name="st_'+t.id+'" value="done" '+(st===TASK_STATUS.DONE?'checked':'')+' onchange="onTaskStatusChange('+t.id+',\'done\')"> ุงูุฌุงู ุดุฏ</label><br>'+
        '<label><input type="radio" name="st_'+t.id+'" value="todo" '+(st===TASK_STATUS.TODO?'checked':'')+' onchange="onTaskStatusChange('+t.id+',\'todo\')"> ุงูุฌุงู ูุดุฏ</label><br>'+
        '<label><input type="radio" name="st_'+t.id+'" value="partial" '+(st===TASK_STATUS.PARTIAL?'checked':'')+' onchange="onTaskStatusChange('+t.id+',\'partial\')"> ูุงูุต</label><br>'+
        badgeHtml+
      '</td>'+
      '<td style="text-align:center;">'+
        '<input type="number" step="0.5" min="0" style="width:70px;" '+
        'id="left_'+t.id+'" value="'+(t.leftover||0)+'" '+
        (st===TASK_STATUS.PARTIAL?'':'disabled')+
        ' onchange="onLeftoverChange('+t.id+')">'+
        '<div style="font-size:9px;color:#555;">ุจุฑุง ุชุณุช: ุชุนุฏุงุฏ ุชุณุช | ููู: ุณุงุนุช</div>'+
      '</td>'+
    '</tr>';
  }
  table.innerHTML = html;
}

// ุชุบุฑ ูุถุนุช ุชุณฺฉ
async function onTaskStatusChange(taskId,newStatus){
  var leftoverInput=document.getElementById("left_"+taskId);
  if(newStatus===TASK_STATUS.PARTIAL){
    leftoverInput.disabled=false;
  }else{
    leftoverInput.disabled=true;
  }

  var leftoverVal=parseFloat(leftoverInput.value)||0;
  var doneFlag=(newStatus===TASK_STATUS.DONE);

  var res=await supabase
    .from("task_status")
    .update({status:newStatus, leftover:leftoverVal, done:doneFlag})
    .eq("id",taskId);

  if(res.error){
    alert("ุฎุทุง ุฏุฑ ุจูโุฑูุฒุฑุณุงู ูุถุนุช ุชุณฺฉ.");
    console.log(res.error);
  }else{
    for(var i=0;i<currentStudentTasks.length;i++){
      if(currentStudentTasks[i].id===taskId){
        currentStudentTasks[i].status=newStatus;
        currentStudentTasks[i].leftover=leftoverVal;
        currentStudentTasks[i].done=doneFlag;
        break;
      }
    }
    loadBacklogView();
    loadStudentPlans();
  }
}

// ุชุบุฑ leftover
async function onLeftoverChange(taskId){
  var leftoverInput=document.getElementById("left_"+taskId);
  var leftoverVal=parseFloat(leftoverInput.value)||0;
  var res=await supabase
    .from("task_status")
    .update({leftover:leftoverVal})
    .eq("id",taskId);
  if(res.error){
    alert("ุฎุทุง ุฏุฑ ุฐุฎุฑู ููุฏุงุฑ ุจุงูโูุงูุฏู.");
    console.log(res.error);
  }else{
    for(var i=0;i<currentStudentTasks.length;i++){
      if(currentStudentTasks[i].id===taskId){
        currentStudentTasks[i].leftover=leftoverVal;
        break;
      }
    }
  }
}

// ฺฏุฒุงุฑุด ูุญุธูโุง
function showInstantReport(){
  var box=document.getElementById("instantReportBox");
  if(!currentStudentTasks || !currentStudentTasks.length){
    box.textContent="ุจุฑูุงููโุง ุงูุชุฎุงุจ ูุดุฏู.";
    return;
  }
  var doneCount=0, partialCount=0, todoCount=0;
  var todayIdx=null;
  var labels=getDateLabelsFromProgramDate(currentStudentPlanDate);
  var todayStr=(new Date()).toISOString().slice(0,10);

  for(var d=0;d<labels.length;d++){
    var parts=labels[d].split(" ");
    var datePart=parts[1];
    var dparts=datePart.split("/");
    var y=parseInt(dparts[0],10);
    var m=parseInt(dparts[1],10)-1;
    var dd=parseInt(dparts[2],10);
    var dt=new Date(y,m,dd);
    var iso=dt.toISOString().slice(0,10);
    if(iso===todayStr){
      todayIdx=d+1;
      break;
    }
  }

  var todayDone=[],todayTodo=[],todayPartial=[];
  for(var i=0;i<currentStudentTasks.length;i++){
    var t=currentStudentTasks[i];
    var st=t.status || (t.done?TASK_STATUS.DONE:TASK_STATUS.TODO);
    if(st===TASK_STATUS.DONE) doneCount++;
    else if(st===TASK_STATUS.PARTIAL) partialCount++;
    else todoCount++;

    if(todayIdx && t.day===todayIdx){
      if(st===TASK_STATUS.DONE) todayDone.push(t.task_text);
      else if(st===TASK_STATUS.PARTIAL) todayPartial.push(t.task_text);
      else todayTodo.push(t.task_text);
    }
  }
  var total=currentStudentTasks.length;
  var percent = Math.round((doneCount*100)/total);

  var html="๐ฅ ฺฏุฒุงุฑุด ูุญุธูโุง ุงู ุจุฑูุงูู:<br>"+
    "ฺฉู ุชุณฺฉโูุง: "+total+
    " | ุงูุฌุงู ุดุฏู: "+doneCount+
    " | ูุงูุต: "+partialCount+
    " | ุงูุฌุงูโูุดุฏู: "+todoCount+
    " | ุฏุฑุตุฏ ุงูุฌุงู ฺฉุงูู: "+percent+"ูช";

  if(todayIdx){
    html+="<br><br>๐ ูุถุนุช ุงูุฑูุฒ ("+labels[todayIdx-1]+"):";
    if(todayDone.length){
      html+="<br>โ ุงูุฌุงู ุดุฏู:";
      todayDone.forEach(function(t){html+="<br>- "+t;});
    }
    if(todayPartial.length){
      html+="<br>โณ ูุงูุต:";
      todayPartial.forEach(function(t){html+="<br>- "+t;});
    }
    if(todayTodo.length){
      html+="<br>โ ุงูุฌุงูโูุดุฏู:";
      todayTodo.forEach(function(t){html+="<br>- "+t;});
    }
  }else{
    html+="<br><br>๐ ุงูุฑูุฒ ุฏุงุฎู ุจุงุฒู ฑด ุฑูุฒู ุงู ุจุฑูุงูู ูุณุช.";
  }

  box.innerHTML=html;
}

// ===== ูพูู ุนูุจโูุงูุฏฺฏ =====
async function loadBacklogView(){
  var table=document.getElementById("backlogTable");
  table.innerHTML="ุฏุฑ ุญุงู ุฎูุงูุฏู ุนูุจโูุงูุฏฺฏโูุง...";

  var userRes=await supabase.auth.getUser();
  if(userRes.error || !userRes.data.user){
    table.innerHTML="<tr><td>ุงุจุชุฏุง ูุงฺฏู ฺฉู.</td></tr>";
    return;
  }
  var user=userRes.data.user;

  var pRes=await supabase
    .from("plans")
    .select("id,program_date")
    .eq("email", user.email)
    .order("program_date",{ascending:true});

  if(pRes.error){
    table.innerHTML="<tr><td>ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุจุฑูุงููโูุง.</td></tr>";
    console.log(pRes.error);
    return;
  }
  var plans=pRes.data||[];
  if(!plans.length){
    table.innerHTML="<tr><td>ูฺ ุจุฑูุงููโุง ุซุจุช ูุดุฏู.</td></tr>";
    return;
  }

  var today=new Date();
  today.setHours(0,0,0,0);

  var backlogRows=[];
  for(var pi=0;pi<plans.length;pi++){
    var p=plans[pi];
    var labels=getDateLabelsFromProgramDate(p.program_date);

    var tRes=await supabase
      .from("task_status")
      .select("id,day,task_text,status,leftover,done")
      .eq("plan_id",p.id);

    if(tRes.error || !tRes.data) continue;
    var tasks=tRes.data;

    for(var ti=0;ti<tasks.length;ti++){
      var t=tasks[ti];
      var st=t.status || (t.done?TASK_STATUS.DONE:TASK_STATUS.TODO);
      if(st===TASK_STATUS.DONE) continue;

      var dayIndex=t.day-1;
      if(dayIndex<0 || dayIndex>=14) continue;
      var dLabel=labels[dayIndex];
      if(!dLabel) continue;
      var datePart=dLabel.split(" ")[1];
      var parts=datePart.split("/");
      var yy=parseInt(parts[0],10);
      var mm=parseInt(parts[1],10)-1;
      var dd=parseInt(parts[2],10);
      var dt=new Date(yy,mm,dd);
      dt.setHours(0,0,0,0);
      if(dt>=today) continue;

      backlogRows.push({
        plan_id:p.id,
        program_date:p.program_date,
        day:t.day,
        dateLabel:dLabel,
        task_text:t.task_text,
        status:st,
        leftover:t.leftover||0
      });
    }
  }

  if(!backlogRows.length){
    table.innerHTML="<tr><td>ุฏุฑ ุญุงู ุญุงุถุฑ ุนูุจโูุงูุฏฺฏ ุซุจุชโุดุฏูโุง ูุฌูุฏ ูุฏุงุฑุฏ (ุง ููู ุงูุฌุงู ุดุฏูโุงูุฏ).</td></tr>";
    return;
  }

  var html="<tr><th>ุจุฑูุงูู</th><th>ุฑูุฒ/ุชุงุฑุฎ</th><th>ุชุณฺฉ</th><th>ูุถุนุช</th><th>ููุฏุงุฑ ุจุงูโูุงูุฏู</th></tr>";
  backlogRows.forEach(function(r){
    var badge="";
    if(r.status===TASK_STATUS.PARTIAL) badge='<span class="badge partial">ูุงูุต</span>';
    else badge='<span class="badge todo">ุงูุฌุงูโูุดุฏู</span>';
    html+='<tr>'+
      '<td>ุจุฑูุงูู '+r.plan_id+' ('+r.program_date+')</td>'+
      '<td>'+r.dateLabel+'</td>'+
      '<td>'+r.task_text+'</td>'+
      '<td>'+badge+'</td>'+
      '<td>'+(r.leftover>0? r.leftover : "โ")+'</td>'+
    '</tr>';
  });
  table.innerHTML=html;
}

// ===== ูพูู ุงุฏูู =====
async function loadAdminPlans(){
  var table=document.getElementById("adminPlansTable");
  table.innerHTML="";
  var res=await supabase
    .from("plans")
    .select("id,email,fname,lname,program_date,plan_type")
    .order("program_date",{ascending:false})
    .limit(100);

  if(res.error){
    table.innerHTML="<tr><td>ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุจุฑูุงููโูุง</td></tr>";
    console.log(res.error);
    return;
  }
  var rows=res.data;
  if(!rows.length){
    table.innerHTML="<tr><td>ุจุฑูุงููโุง ุซุจุช ูุดุฏู.</td></tr>";
    return;
  }

  var html="<tr><th>ID</th><th>ุฏุงูุดโุขููุฒ</th><th>ุงูู</th><th>ุชุงุฑุฎ ุจุฑูุงูู</th><th>ููุน</th><th>ุชุณฺฉโูุง</th></tr>";
  for(var i=0;i<rows.length;i++){
    var p=rows[i];
    html+='<tr>'+
      '<td>'+p.id+'</td>'+
      '<td>'+ (p.fname||"")+' '+(p.lname||"") +'</td>'+
      '<td>'+ (p.email||"") +'</td>'+
      '<td>'+ (p.program_date||"") +'</td>'+
      '<td>'+ planTypeLabel(p.plan_type) +'</td>'+
      '<td><button class="small-btn" onclick="loadAdminTasks('+p.id+',\''+(p.fname||"")+' '+(p.lname||"")+'\','+'\''+(p.program_date||"")+'\')">ููุงุด ุชุณฺฉโูุง</button></td>'+
    '</tr>';
  }
  table.innerHTML=html;
}

async function loadAdminTasks(planId,studentName,programDate){
  currentAdminPlanId = planId;
  currentAdminStudentName = studentName;
  currentAdminProgramDate = programDate;

  var title=document.getElementById("adminPlanTitle");
  var table=document.getElementById("adminTasksTable");
  title.textContent="ุจุฑูุงูู "+studentName+" ุฏุฑ ุชุงุฑุฎ "+programDate;
  table.innerHTML="";

  var res=await supabase
    .from("task_status")
    .select("id,day,task_text,done,status,leftover")
    .eq("plan_id",planId)
    .order("day",{ascending:true})
    .order("id",{ascending:true});

  if(res.error){
    table.innerHTML="<tr><td>ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุชุณฺฉโูุง</td></tr>";
    console.log(res.error);
    return;
  }
  var tasks=res.data;
  if(!tasks.length){
    table.innerHTML="<tr><td>ุชุณฺฉ ุซุจุช ูุดุฏู.</td></tr>";
    return;
  }

  var doneCount=0, partialCount=0, todoCount=0;
  for(var i=0;i<tasks.length;i++){
    var st=tasks[i].status || (tasks[i].done?TASK_STATUS.DONE:TASK_STATUS.TODO);
    if(st===TASK_STATUS.DONE) doneCount++;
    else if(st===TASK_STATUS.PARTIAL) partialCount++;
    else todoCount++;
  }
  var total=tasks.length;
  var percent=Math.round((doneCount*100)/total);
  title.textContent+=" | ุงูุฌุงู ุดุฏู: "+doneCount+" | ูุงูุต: "+partialCount+" | ุงูุฌุงูโูุดุฏู: "+todoCount+" ("+percent+"ูช)";

  var labels = getDateLabelsFromProgramDate(programDate);

  var html="<tr><th>ุฑูุฒ</th><th>ุชุณฺฉ</th><th>ูุถุนุช</th><th>ุจุงูโูุงูุฏู</th><th>ุญุฐู</th></tr>";
  for(i=0;i<tasks.length;i++){
    var t=tasks[i];
    var st=t.status || (t.done?TASK_STATUS.DONE:TASK_STATUS.TODO);
    var badge="";
    if(st===TASK_STATUS.DONE) badge='<span class="badge done">ุงูุฌุงู ุดุฏู</span>';
    else if(st===TASK_STATUS.PARTIAL) badge='<span class="badge partial">ูุงูุต</span>';
    else badge='<span class="badge todo">ุงูุฌุงูโูุดุฏู</span>';
    var label = labels[t.day-1] || ("ุฑูุฒ "+t.day);
    html+='<tr>'+
      '<td style="text-align:center">'+label+'</td>'+
      '<td>'+t.task_text+'</td>'+
      '<td style="text-align:center">'+badge+'</td>'+
      '<td style="text-align:center">'+(t.leftover>0?t.leftover:"โ")+'</td>'+
      '<td style="text-align:center"><button class="small-btn del" onclick="adminDeleteTask('+t.id+')">ุญุฐู</button></td>'+
    '</tr>';
  }
  table.innerHTML=html;
}

async function adminAddTask(){
  if(!currentAdminPlanId){
    alert("ุงูู ฺฉ ุจุฑูุงูู ุฑุง ุฏุฑ ูพูู ุงุฏูู ุงูุชุฎุงุจ ฺฉู.");
    return;
  }
  var day = parseInt(document.getElementById("adminNewTaskDay").value||"0",10);
  var text = document.getElementById("adminNewTaskText").value.trim();
  if(day<1 || day>14){
    alert("ุฑูุฒ ุจุงุฏ ุจู ฑ ุชุง ฑด ุจุงุดุฏ.");
    return;
  }
  if(!text){
    alert("ูุชู ุชุณฺฉ ุฑุง ูุงุฑุฏ ฺฉู.");
    return;
  }
  var res = await supabase
    .from("task_status")
    .insert({plan_id: currentAdminPlanId, day: day, task_text: text, done:false, status:TASK_STATUS.TODO, leftover:0});
  if(res.error){
    alert("ุฎุทุง ุฏุฑ ุงูุฒูุฏู ุชุณฺฉ ุฌุฏุฏ.");
    console.log(res.error);
    return;
  }
  document.getElementById("adminNewTaskText").value="";
  loadAdminTasks(currentAdminPlanId, currentAdminStudentName, currentAdminProgramDate);
}

async function adminDeleteTask(taskId){
  if(!currentAdminPlanId) return;
  if(!confirm("ุงู ุชุณฺฉ ุญุฐู ุดูุฏุ")) return;
  var res = await supabase
    .from("task_status")
    .delete()
    .eq("id", taskId);
  if(res.error){
    alert("ุฎุทุง ุฏุฑ ุญุฐู ุชุณฺฉ.");
    console.log(res.error);
    return;
  }
  loadAdminTasks(currentAdminPlanId, currentAdminStudentName, currentAdminProgramDate);
}
</script>
</body>
</html>
